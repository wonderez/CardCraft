### ç”¨æˆ·:
é¡¹ç›®èƒŒæ™¯
æˆ‘æ­£åœ¨å¼€å‘ä¸€ä¸ª Windows æ¡Œé¢åº”ç”¨ã€ŒCardCraftã€ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š
- ç”¨æˆ·è¾“å…¥ Markdown æ–‡æœ¬
- è‡ªåŠ¨æ¸²æŸ“æˆå°çº¢ä¹¦é£æ ¼çš„ç²¾ç¾å¡ç‰‡
- æ™ºèƒ½åˆ†é¡µï¼ˆ3:4 æ¯”ä¾‹ï¼Œ1080Ã—1440pxï¼‰
- æ‰¹é‡å¯¼å‡ºé«˜è´¨é‡å›¾ç‰‡
Â 
# æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼šPySide6 (Qt for Python)
- æ¸²æŸ“ï¼šQWebEngineView (åŸºäº Chromium)
- Markdownè§£æï¼špython-markdown + æ‰©å±•
- æ ·å¼ï¼šHTML + CSS (å°çº¢ä¹¦é£æ ¼)
- åˆ†é¡µï¼šJavaScript (åœ¨ WebEngine ä¸­æ‰§è¡Œ)
Â 
# æ ¸å¿ƒæ¶æ„è®¾è®¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â Â Â Â Â Â Â Â Â Â ä¸»çª—å£ (MainWindow) Â Â Â Â Â Â Â Â Â Â â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Â ç¼–è¾‘å™¨ç»„ä»¶ Â â”‚ Â Â é¢„è§ˆç»„ä»¶ Â Â Â â”‚ Â å·¥å…·æ  Â Â â”‚
â”‚ (QTextEdit) â”‚(QWebEngineView)â”‚ (QToolBar)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Markdownè§£æ Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â HTMLç”Ÿæˆ Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â æ™ºèƒ½åˆ†é¡µ Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â æ ·å¼æ¸²æŸ“ Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â å›¾ç‰‡å¯¼å‡º Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Â 
# é¡¹ç›®ç»“æ„
cardcraft/
â”œâ”€â”€ main.py Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # å¯åŠ¨ç¨‹åºï¼Œåˆ›å»º Qt åº”ç”¨
â”œâ”€â”€ requirements.txt Â Â Â Â Â Â Â Â Â Â Â # ä¾èµ–åŒ…åˆ—è¡¨ï¼šPySide6ã€markdown ç­‰
â”‚
src/
â”œâ”€â”€ ui/
â”‚ Â Â â”œâ”€â”€ main_window.py Â Â Â Â Â Â Â Â # ä¸»çª—å£ï¼šå·¦å³åˆ†æ å¸ƒå±€ï¼Œå¯¼å‡ºæŒ‰é’®ï¼Œ300mså»¶è¿Ÿæ›´æ–°
â”‚ Â Â â”œâ”€â”€ editor_widget.py Â Â Â Â Â Â # å·¦ä¾§ç¼–è¾‘å™¨ï¼šQTextEditï¼Œå«ç¤ºä¾‹æ–‡æœ¬
â”‚ Â Â â”œâ”€â”€ preview_widget.py Â Â Â Â Â # å³ä¾§é¢„è§ˆï¼šQWebEngineViewï¼Œé›†æˆåˆ†é¡µå’Œå¯¼å‡ºåŠŸèƒ½
â”‚ Â Â 
â”œâ”€â”€ core/
â”‚ Â Â â”œâ”€â”€ markdown_processor.py Â # Markdown è½¬ HTMLï¼šä½¿ç”¨ python-markdown åº“
â”‚ Â Â â”œâ”€â”€ html_generator.py Â Â Â Â Â # ç”Ÿæˆå®Œæ•´ç½‘é¡µï¼šæ”¯æŒé¡µç ã€å¤šä¸»é¢˜CSSæ ·å¼
â”‚ Â Â 
â”œâ”€â”€ utils/
â”‚ Â Â â”œâ”€â”€ paginator.py Â Â Â Â Â Â Â Â Â Â # âœ… æ™ºèƒ½åˆ†é¡µå™¨ï¼šHTMLå…ƒç´ è§£æã€é«˜åº¦ä¼°ç®—ã€åˆ†é¡µä¼˜åŒ–
â”‚ Â Â â”œâ”€â”€ exporter.py Â Â Â Â Â Â Â Â Â Â Â # âœ… å›¾ç‰‡å¯¼å‡ºå™¨ï¼šæ‰¹é‡å¯¼å‡ºã€è¿›åº¦è¿½è¸ªã€æ°´å°æ·»åŠ 
â”‚ Â Â â”œâ”€â”€ style_manager.py Â Â Â Â Â Â # âœ… æ ·å¼ç®¡ç†å™¨ï¼šå¤šä¸»é¢˜æ”¯æŒï¼ˆå°çº¢ä¹¦/Instagram/å¾®ä¿¡/çŸ¥ä¹/æ·±è‰²ï¼‰
â”‚ Â Â 
â”œâ”€â”€ resources/
â”‚ Â Â â”œâ”€â”€ styles/ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # ï¿½ï¿½ é¢„ç•™ï¼šæœªæ¥å¯å­˜æ”¾ç‹¬ç«‹CSSæ–‡ä»¶
â”‚ Â Â â””â”€â”€ templates/ Â Â Â Â Â Â Â Â Â Â Â Â # ï¿½ï¿½ é¢„ç•™ï¼šæœªæ¥å¯å­˜æ”¾HTMLæ¨¡æ¿æ–‡ä»¶# æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚
Â 
## 1. æ™ºèƒ½åˆ†é¡µç®—æ³•
- æ¯é¡µå›ºå®šå°ºå¯¸ï¼š1080Ã—1440px (3:4æ¯”ä¾‹)
- åˆ†é¡µåŸåˆ™ï¼š
Â Â * æ®µè½å®Œæ•´æ€§ï¼šä¸åœ¨æ®µè½ä¸­é—´åˆ†é¡µ
Â Â * æ ‡é¢˜å…³è”ï¼šæ ‡é¢˜ä¸å…¶åç»­å†…å®¹ä¿æŒåŒé¡µ
Â Â * åˆ—è¡¨è¿ç»­ï¼šåˆ—è¡¨é¡¹å°½é‡ä¸åˆ†ç¦»
Â Â * ä»£ç å®Œæ•´ï¼šä»£ç å—ä¸è·¨é¡µ
Â Â * è§†è§‰å¹³è¡¡ï¼šé¿å…é¡µé¢è¿‡ç©ºæˆ–è¿‡æ»¡
Â 
## 2. æ ·å¼ç³»ç»Ÿ
- é¢„è®¾ä¸»é¢˜ï¼šå°çº¢ä¹¦ã€Instagramã€å¾®ä¿¡ã€çŸ¥ä¹ç­‰
- æ ·å¼è¦ç´ ï¼š
Â Â * å­—ä½“ï¼šä¸­æ–‡ç”¨è‹¹æ–¹/å¾®è½¯é›…é»‘ï¼Œè¥¿æ–‡ç”¨ Helvetica
Â Â * é¢œè‰²ï¼šä¸»è‰² #FF2442ï¼Œæ–‡å­— #333333
Â Â * é—´è·ï¼šæ®µè½é—´è· 20pxï¼Œè¡Œé«˜ 1.8
Â Â * ç‰¹æ•ˆï¼šå¡ç‰‡é˜´å½±ã€åœ†è§’ã€æ¸å˜èƒŒæ™¯
Â 
## 3. æ¸²æŸ“æµç¨‹
```python
# ä¼ªä»£ç ç¤ºä¾‹
markdown_text â†’ parse_markdown() â†’ generate_html() â†’ apply_styles() â†’ paginate() â†’ render_preview() â†’ export_images()
4. å¯¼å‡ºåŠŸèƒ½
Â 
æ ¼å¼ï¼šPNG/JPEG
è´¨é‡ï¼šæ”¯æŒ 1x/2x/3x åˆ†è¾¨ç‡
å‘½åï¼šè‡ªåŠ¨ç¼–å·ï¼Œå¦‚ card_01.png, card_02.png
æ‰¹é‡ï¼šä¸€æ¬¡å¯¼å‡ºæ‰€æœ‰åˆ†é¡µ
Â 
ä»£ç è§„èŒƒ
Â 
ä½¿ç”¨ç±»å‹æ³¨è§£ (typing)
éµå¾ª PEP 8
ä¸­æ–‡æ³¨é‡Šè¯´æ˜å…³é”®é€»è¾‘
é”™è¯¯å¤„ç†è¦å®Œå–„
Â 
æ€§èƒ½è¦æ±‚
Â 
å®æ—¶é¢„è§ˆå»¶è¿Ÿ < 300ms
æ”¯æŒ 10000 å­—çš„æ–‡æ¡£
å¯¼å‡ºé€Ÿåº¦ï¼šæ¯å¼ å¡ç‰‡ < 1ç§’
Â 
é—®é¢˜æè¿°
è¿™ä¸ªé¢„è§ˆé¡µé¢å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä¸€ä¸€åˆ—ä¸¾ï¼š
1. å³ä¸Šè§’å’Œå·¦ä¸‹è§’ï¼Œéƒ½æœ‰é¡µæ•°ï¼Œé‡å¤äº†ã€‚
2. å·¦ä¸‹è§’çš„ä¸Šä¸‹é¡µå’Œé¡µæ•°ï¼Œæœ€å¥½å±…ä¸­æ˜¾ç¤º
3. æ²¡æœ‰æ»šåŠ¨æ ï¼Œå®é™…å¤§å°æ¨¡å¼æ—¶å¡ç‰‡æ— æ³•å®Œå…¨å±•ç¤º
4. é€‚åº”çª—å£æ—¶ï¼Œå¡ç‰‡ä¸å±…ä¸­
5. æˆ–è€…æ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘å‘ç°ä¸ç®¡æ˜¯é€‚åº”çª—å£æ¨¡å¼è¿˜æ˜¯å®é™…å¤§å°æ¨¡å¼ï¼Œæ•´ä¸ªçª—å£å³è¾¹ä¼¼ä¹æœ‰ä¸€å—ç©ºç™½åŒºåŸŸæ²¡æœ‰ç”¨åˆ°
æœŸæœ›è¾“å‡º
ä¿®æ”¹é—®é¢˜çš„ä»£ç ï¼›è‹¥ä¿®æ”¹å°åˆ™ç›´æ¥å‘Šè¯‰æˆ‘ä½ç½®ï¼Œæˆ‘ä¸ªäººè¿›è¡Œä¿®æ”¹ï¼›è‹¥å˜åŠ¨å¤§ï¼Œåˆ™ç»™æˆ‘è¿™ä¸ªæ–‡ä»¶çš„å®Œæ•´ä»£ç 
preview_widget.py->text/plain-># ============================================
# src/ui/preview_widget.py - ä¼˜åŒ–ç‰ˆæœ¬
# ============================================
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QLabel, QFrame, 
                               QPushButton, QHBoxLayout, QProgressDialog,
                               QMessageBox, QComboBox, QButtonGroup, QRadioButton)
from PySide6.QtWebEngineWidgets import QWebEngineView
from PySide6.QtCore import QUrl, QTimer, Signal, Qt, QSize, QEvent
from PySide6.QtGui import QWheelEvent
from pathlib import Path
from src.core.markdown_processor import MarkdownProcessor
from src.core.html_generator import HTMLGenerator
from src.utils.paginator import SmartPaginator
from src.utils.exporter import ImageExporter

class PreviewWidget(QWidget):
    pageChanged = Signal(int, int)  # å½“å‰é¡µï¼Œæ€»é¡µæ•°
    sizeChanged = Signal(str)  # å°ºå¯¸æ”¹å˜ä¿¡å·
    
    def __init__(self):
        super().__init__()
        self.current_pages = []  # å­˜å‚¨åˆ†é¡µåçš„HTMLå†…å®¹
        self.current_page = 1
        self.total_pages = 1
        self.markdown_text = ""  # ä¿å­˜åŸå§‹markdownæ–‡æœ¬
        self.current_size = "medium"  # å½“å‰é¡µé¢å°ºå¯¸
        self.preview_mode = "fit"  # é¢„è§ˆæ¨¡å¼: fit(é€‚åº”çª—å£) æˆ– actual(å®é™…å¤§å°)
        
        # åˆå§‹åŒ–å¤„ç†å™¨
        self.markdown_processor = MarkdownProcessor()
        self.html_generator = HTMLGenerator(page_size="medium")
        self.paginator = SmartPaginator(page_size="medium")
        
        # åˆå§‹åŒ–UI
        self.init_ui()
        
        # è®¾ç½®å¯¼å‡ºå™¨
        self.setup_exporter()
        
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # åˆ›å»ºå®¹å™¨æ¡†æ¶
        container = QFrame()
        container.setStyleSheet("""
            QFrame {
                background: rgba(25, 25, 40, 0.95);
                border: 1px solid rgba(0, 224, 255, 0.2);
                border-radius: 16px;
            }
        """)
        container_layout = QVBoxLayout(container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(0)
        
        # åˆ›å»ºæ ‡é¢˜æ 
        title_bar = self.create_title_bar()
        
        # åˆ›å»ºWebViewï¼ˆç›´æ¥åµŒå…¥ï¼Œä¸ä½¿ç”¨æ»šåŠ¨åŒºåŸŸï¼‰
        self.create_web_view()
        
        # åˆ›å»ºæ§åˆ¶æ 
        control_bar = self.create_control_bar()
        
        # ç»„è£…å¸ƒå±€
        container_layout.addWidget(title_bar)
        container_layout.addWidget(self.web_view, 1)
        container_layout.addWidget(control_bar)
        
        layout.addWidget(container)
        
        # è¿æ¥ä¿¡å·
        self.connect_signals()
        
        # åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        self.update_buttons()
        
        # å®‰è£…äº‹ä»¶è¿‡æ»¤å™¨ä»¥å¤„ç†æ»šè½®äº‹ä»¶
        self.web_view.installEventFilter(self)
    
    def create_title_bar(self):
        """åˆ›å»ºæ ‡é¢˜æ """
        title_bar = QFrame()
        title_bar.setFixedHeight(50)
        title_bar.setStyleSheet("""
            QFrame {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 224, 255, 0.1),
                    stop: 0.5 rgba(0, 150, 255, 0.15),
                    stop: 1 rgba(0, 224, 255, 0.1)
                );
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
                border-bottom: 1px solid rgba(0, 224, 255, 0.2);
            }
        """)
        
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(20, 5, 20, 5)
        title_layout.setSpacing(15)
        
        # æ ‡é¢˜
        title = QLabel("ğŸ‘€ å®æ—¶é¢„è§ˆ")
        title.setStyleSheet("""
            QLabel {
                color: #00e0ff;
                font-size: 16px;
                font-weight: 600;
                letter-spacing: 0.5px;
                background: transparent;
            }
        """)
        
        # å°ºå¯¸é€‰æ‹©æ ‡ç­¾
        size_label = QLabel("å°ºå¯¸:")
        size_label.setStyleSheet("""
            QLabel {
                color: #8a92a6;
                font-size: 12px;
                background: transparent;
            }
        """)
        
        # å°ºå¯¸é€‰æ‹©ä¸‹æ‹‰æ¡†
        self.size_selector = QComboBox()
        self.size_selector.addItems(["å°å°ºå¯¸ (720Ã—960)", "ä¸­å°ºå¯¸ (1080Ã—1440)", "å¤§å°ºå¯¸ (1440Ã—1920)"])
        self.size_selector.setCurrentIndex(1)
        self.size_selector.setFixedWidth(150)
        self.size_selector.setStyleSheet(self.get_combobox_style())
        
        # é¢„è§ˆæ¨¡å¼é€‰æ‹©
        mode_label = QLabel("æ¨¡å¼:")
        mode_label.setStyleSheet("""
            QLabel {
                color: #8a92a6;
                font-size: 12px;
                background: transparent;
            }
        """)
        
        # é¢„è§ˆæ¨¡å¼æŒ‰é’®ç»„
        self.mode_group = QButtonGroup()
        
        self.fit_mode_btn = QRadioButton("é€‚åº”çª—å£")
        self.fit_mode_btn.setChecked(True)
        self.fit_mode_btn.setStyleSheet(self.get_radio_style())
        
        self.actual_mode_btn = QRadioButton("å®é™…å¤§å°")
        self.actual_mode_btn.setStyleSheet(self.get_radio_style())
        
        self.mode_group.addButton(self.fit_mode_btn, 0)
        self.mode_group.addButton(self.actual_mode_btn, 1)
        
        # é¡µé¢ä¿¡æ¯æ ‡ç­¾
        self.page_info_label = QLabel("")
        self.page_info_label.setStyleSheet("""
            QLabel {
                color: #8a92a6;
                font-size: 12px;
                padding: 5px 15px;
                background: rgba(0, 224, 255, 0.05);
                border: 1px solid rgba(0, 224, 255, 0.2);
                border-radius: 12px;
            }
        """)
        
        # ç»„è£…æ ‡é¢˜æ 
        title_layout.addWidget(title)
        title_layout.addSpacing(20)
        title_layout.addWidget(size_label)
        title_layout.addWidget(self.size_selector)
        title_layout.addSpacing(15)
        title_layout.addWidget(mode_label)
        title_layout.addWidget(self.fit_mode_btn)
        title_layout.addWidget(self.actual_mode_btn)
        title_layout.addStretch()
        title_layout.addWidget(self.page_info_label)
        
        return title_bar
    
    def create_web_view(self):
        """åˆ›å»ºWebView"""
        self.web_view = QWebEngineView()
        self.web_view.setStyleSheet("""
            QWebEngineView {
                border: none;
                background: #1a1a2e;
            }
        """)
        
        # å¯ç”¨æ»šåŠ¨æ¡ï¼ˆå®é™…å¤§å°æ¨¡å¼éœ€è¦ï¼‰
        self.web_view.page().settings().setAttribute(
            self.web_view.page().settings().WebAttribute.ShowScrollBars, True
        )
    
    def create_control_bar(self):
        """åˆ›å»ºæ§åˆ¶æ """
        control_bar = QFrame()
        control_bar.setFixedHeight(60)
        control_bar.setStyleSheet("""
            QFrame {
                background: rgba(20, 20, 35, 0.8);
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
                border-top: 1px solid rgba(0, 224, 255, 0.1);
            }
        """)
        
        control_layout = QHBoxLayout(control_bar)
        control_layout.setContentsMargins(20, 12, 20, 12)
        control_layout.setSpacing(15)
        
        # ä¸Šä¸€é¡µæŒ‰é’®
        self.prev_btn = QPushButton("â¬… ä¸Šä¸€é¡µ")
        self.prev_btn.setFixedSize(100, 36)
        self.prev_btn.setStyleSheet(self.get_button_style())
        
        # é¡µç å¿«é€Ÿè·³è½¬
        self.page_jump_label = QLabel("è·³è½¬:")
        self.page_jump_label.setStyleSheet("""
            QLabel {
                color: #8a92a6;
                font-size: 13px;
                background: transparent;
            }
        """)
        
        self.page_selector = QComboBox()
        self.page_selector.setFixedWidth(80)
        self.page_selector.setStyleSheet(self.get_combobox_style())
        
        # ä¸‹ä¸€é¡µæŒ‰é’®
        self.next_btn = QPushButton("ä¸‹ä¸€é¡µ â¡")
        self.next_btn.setFixedSize(100, 36)
        self.next_btn.setStyleSheet(self.get_button_style())
        
        # å¿«æ·æç¤º
        tips_label = QLabel("ğŸ’¡ æç¤º: ä½¿ç”¨é¼ æ ‡æ»šè½®æˆ– â†‘â†“ é”®ç¿»é¡µ")
        tips_label.setStyleSheet("""
            QLabel {
                color: #6a7a8a;
                font-size: 11px;
                font-style: italic;
                background: transparent;
            }
        """)
        
        # ç»„è£…æ§åˆ¶æ 
        control_layout.addWidget(self.prev_btn)
        control_layout.addWidget(self.page_jump_label)
        control_layout.addWidget(self.page_selector)
        control_layout.addWidget(self.next_btn)
        control_layout.addStretch()
        control_layout.addWidget(tips_label)
        
        return control_bar
    
    def connect_signals(self):
        """è¿æ¥ä¿¡å·"""
        self.prev_btn.clicked.connect(self.prev_page)
        self.next_btn.clicked.connect(self.next_page)
        self.size_selector.currentIndexChanged.connect(self.on_size_changed)
        self.mode_group.buttonClicked.connect(self.on_mode_changed)
        self.page_selector.currentIndexChanged.connect(self.on_page_jump)
    
    def eventFilter(self, obj, event):
        """äº‹ä»¶è¿‡æ»¤å™¨ - å¤„ç†æ»šè½®äº‹ä»¶å®ç°ç¿»é¡µ"""
        if obj == self.web_view and event.type() == QEvent.Wheel:
            wheel_event = event
            
            # æ£€æŸ¥æ˜¯å¦åœ¨å®é™…å¤§å°æ¨¡å¼ä¸‹ï¼Œä¸”é¡µé¢æœ‰æ»šåŠ¨æ¡
            if self.preview_mode == "actual":
                # è·å–å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
                def check_scroll_and_page():
                    self.web_view.page().runJavaScript("""
                        ({
                            scrollTop: window.pageYOffset || document.documentElement.scrollTop,
                            scrollHeight: document.documentElement.scrollHeight,
                            clientHeight: window.innerHeight,
                            canScrollDown: (window.pageYOffset + window.innerHeight) < document.documentElement.scrollHeight - 10,
                            canScrollUp: window.pageYOffset > 10
                        })
                    """, lambda result: self.handle_scroll_result(result, wheel_event))
                
                check_scroll_and_page()
                return False  # å…ˆä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
            else:
                # é€‚åº”çª—å£æ¨¡å¼ï¼Œç›´æ¥ç¿»é¡µ
                if wheel_event.angleDelta().y() > 0:
                    self.prev_page()
                else:
                    self.next_page()
                return True  # é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
        
        return super().eventFilter(obj, event)
    
    def handle_scroll_result(self, result, wheel_event):
        """å¤„ç†æ»šåŠ¨æ£€æµ‹ç»“æœ"""
        if result:
            # å‘ä¸‹æ»šåŠ¨ä¸”å·²åˆ°åº•éƒ¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€é¡µ
            if wheel_event.angleDelta().y() < 0 and not result['canScrollDown']:
                if self.current_page < self.total_pages:
                    self.next_page()
                    # æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                    QTimer.singleShot(100, lambda: self.web_view.page().runJavaScript(
                        "window.scrollTo(0, 0);"
                    ))
            
            # å‘ä¸Šæ»šåŠ¨ä¸”å·²åˆ°é¡¶éƒ¨ï¼Œåˆ‡æ¢åˆ°ä¸Šä¸€é¡µ
            elif wheel_event.angleDelta().y() > 0 and not result['canScrollUp']:
                if self.current_page > 1:
                    self.prev_page()
                    # æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨
                    QTimer.singleShot(100, lambda: self.web_view.page().runJavaScript(
                        "window.scrollTo(0, document.documentElement.scrollHeight);"
                    ))
    
    def keyPressEvent(self, event):
        """å¤„ç†é”®ç›˜äº‹ä»¶"""
        if event.key() == Qt.Key_Up or event.key() == Qt.Key_PageUp:
            self.prev_page()
        elif event.key() == Qt.Key_Down or event.key() == Qt.Key_PageDown:
            self.next_page()
        elif event.key() == Qt.Key_Home:
            self.go_to_page(1)
        elif event.key() == Qt.Key_End:
            self.go_to_page(self.total_pages)
        else:
            super().keyPressEvent(event)
    
    def on_mode_changed(self):
        """å¤„ç†é¢„è§ˆæ¨¡å¼æ”¹å˜"""
        if self.fit_mode_btn.isChecked():
            self.preview_mode = "fit"
        else:
            self.preview_mode = "actual"
        
        # é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢
        self.display_current_page()
    
    def on_size_changed(self, index):
        """å¤„ç†å°ºå¯¸æ”¹å˜"""
        size_map = {0: "small", 1: "medium", 2: "large"}
        new_size = size_map.get(index, "medium")
        
        if new_size != self.current_size:
            self.current_size = new_size
            
            # æ›´æ–°å„ç»„ä»¶çš„å°ºå¯¸è®¾ç½®
            self.html_generator = HTMLGenerator(page_size=new_size)
            self.paginator.set_page_size(new_size)
            
            # é‡æ–°å¤„ç†å†…å®¹
            if self.markdown_text:
                self.update_content(self.markdown_text)
            
            # å‘é€å°ºå¯¸æ”¹å˜ä¿¡å·
            self.sizeChanged.emit(new_size)
    
    def on_page_jump(self, index):
        """å¤„ç†é¡µç è·³è½¬"""
        if index >= 0:
            self.go_to_page(index + 1)
    
    def update_content(self, markdown_text: str):
        """æ›´æ–°é¢„è§ˆå†…å®¹"""
        try:
            self.markdown_text = markdown_text
            
            # å¤„ç† Markdown
            html_content = self.markdown_processor.parse(markdown_text)
            
            # ä½¿ç”¨æ™ºèƒ½åˆ†é¡µå™¨è¿›è¡Œåˆ†é¡µ
            self.current_pages = self.paginator.paginate(html_content)
            
            # ä¼˜åŒ–åˆ†é¡µç»“æœ
            self.current_pages = self.paginator.optimize_pages(self.current_pages)
            
            self.total_pages = len(self.current_pages)
            self.current_page = 1
            
            # æ›´æ–°é¡µç é€‰æ‹©å™¨
            self.update_page_selector()
            
            # æ˜¾ç¤ºç¬¬ä¸€é¡µ
            self.display_current_page()
            
            # æ›´æ–°æŒ‰é’®å’Œä¿¡æ¯
            self.update_buttons()
            self.update_page_info()
            
        except Exception as e:
            self.show_error(f"é¢„è§ˆé”™è¯¯: {str(e)}")
    
    def update_page_selector(self):
        """æ›´æ–°é¡µç é€‰æ‹©å™¨"""
        self.page_selector.blockSignals(True)
        self.page_selector.clear()
        for i in range(1, self.total_pages + 1):
            self.page_selector.addItem(f"ç¬¬ {i} é¡µ")
        self.page_selector.setCurrentIndex(0)
        self.page_selector.blockSignals(False)
        
        # å¦‚æœåªæœ‰ä¸€é¡µï¼Œéšè—è·³è½¬æ§ä»¶
        has_multiple_pages = self.total_pages > 1
        self.page_jump_label.setVisible(has_multiple_pages)
        self.page_selector.setVisible(has_multiple_pages)
    
    def display_current_page(self):
        """æ˜¾ç¤ºå½“å‰é¡µ"""
        if not self.current_pages:
            return
            
        if 1 <= self.current_page <= len(self.current_pages):
            page_content = self.current_pages[self.current_page - 1]
            
            # æ ¹æ®é¢„è§ˆæ¨¡å¼ç”Ÿæˆä¸åŒçš„HTML
            if self.preview_mode == "fit":
                # é€‚åº”çª—å£æ¨¡å¼ï¼šä½¿ç”¨ç¼©æ”¾ä½¿å†…å®¹é€‚åº”è§†çª—
                full_html = self.generate_fit_html(page_content)
            else:
                # å®é™…å¤§å°æ¨¡å¼ï¼šæ˜¾ç¤ºçœŸå®å°ºå¯¸
                full_html = self.html_generator.generate(page_content)
            
            # åŠ è½½åˆ°WebView
            self.web_view.setHtml(full_html, QUrl("file:///"))
    
    def generate_fit_html(self, content: str) -> str:
        """ç”Ÿæˆé€‚åº”çª—å£çš„HTML"""
        # è·å–å½“å‰çª—å£å¤§å°
        view_width = self.web_view.width()
        view_height = self.web_view.height()
        
        # è·å–ç›®æ ‡å°ºå¯¸
        size_config = {
            "small": (720, 960),
            "medium": (1080, 1440),
            "large": (1440, 1920)
        }
        target_width, target_height = size_config.get(self.current_size, (1080, 1440))
        
        # è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒæ¯”ä¾‹ï¼Œé€‚åº”çª—å£ï¼‰
        scale_x = (view_width - 40) / target_width  # å‡å»è¾¹è·
        scale_y = (view_height - 40) / target_height
        scale = min(scale_x, scale_y, 1.0)  # ä¸è¶…è¿‡åŸå§‹å¤§å°
        
        # ç”Ÿæˆå¸¦ç¼©æ”¾çš„HTML
        html = self.html_generator.generate(content)
        
        # æ³¨å…¥ç¼©æ”¾æ ·å¼
        scale_style = f"""
        <style>
            body {{
                zoom: {scale};
                -moz-transform: scale({scale});
                -moz-transform-origin: 0 0;
                width: {target_width}px !important;
                margin: 0 auto;
            }}
            .page-container {{
                box-shadow: 0 4px 20px rgba(0, 224, 255, 0.15);
            }}
        </style>
        """
        
        # æ’å…¥ç¼©æ”¾æ ·å¼
        html = html.replace('</head>', scale_style + '</head>')
        
        return html
    
    def prev_page(self):
        """ä¸Šä¸€é¡µ"""
        if self.current_page > 1:
            self.go_to_page(self.current_page - 1)
    
    def next_page(self):
        """ä¸‹ä¸€é¡µ"""
        if self.current_page < self.total_pages:
            self.go_to_page(self.current_page + 1)
    
    def go_to_page(self, page_num: int):
        """è·³è½¬åˆ°æŒ‡å®šé¡µ"""
        if 1 <= page_num <= self.total_pages:
            self.current_page = page_num
            self.display_current_page()
            self.update_buttons()
            self.update_page_info()
            
            # æ›´æ–°é¡µç é€‰æ‹©å™¨
            self.page_selector.blockSignals(True)
            self.page_selector.setCurrentIndex(page_num - 1)
            self.page_selector.blockSignals(False)
    
    def update_buttons(self):
        """æ›´æ–°æŒ‰é’®çŠ¶æ€"""
        self.prev_btn.setEnabled(self.current_page > 1)
        self.next_btn.setEnabled(self.current_page < self.total_pages)
        
        # å‘é€é¡µé¢æ”¹å˜ä¿¡å·
        self.pageChanged.emit(self.current_page, self.total_pages)
    
    def update_page_info(self):
        """æ›´æ–°é¡µé¢ä¿¡æ¯æ˜¾ç¤º"""
        if self.total_pages > 1:
            self.page_info_label.setText(f"ç¬¬ {self.current_page}/{self.total_pages} é¡µ")
        else:
            self.page_info_label.setText("ç¬¬ 1 é¡µ")
    
    def get_button_style(self) -> str:
        """è·å–æŒ‰é’®æ ·å¼"""
        return """
            QPushButton {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 224, 255, 0.15),
                    stop: 1 rgba(0, 150, 255, 0.1)
                );
                border: 1px solid rgba(0, 224, 255, 0.4);
                color: #00e0ff;
                padding: 8px 16px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
            }
            QPushButton:hover {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 224, 255, 0.25),
                    stop: 1 rgba(0, 150, 255, 0.2)
                );
                border: 1px solid rgba(0, 224, 255, 0.6);
            }
            QPushButton:pressed {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 224, 255, 0.35),
                    stop: 1 rgba(0, 150, 255, 0.3)
                );
            }
            QPushButton:disabled {
                background: rgba(30, 30, 45, 0.5);
                border-color: rgba(100, 100, 120, 0.3);
                color: rgba(100, 100, 120, 0.5);
            }
        """
    
    def get_combobox_style(self) -> str:
        """è·å–ä¸‹æ‹‰æ¡†æ ·å¼"""
        return """
            QComboBox {
                background: rgba(0, 224, 255, 0.1);
                border: 1px solid rgba(0, 224, 255, 0.3);
                color: #00e0ff;
                padding: 5px 10px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
            }
            QComboBox:hover {
                background: rgba(0, 224, 255, 0.15);
                border: 1px solid rgba(0, 224, 255, 0.5);
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-top: 5px solid #00e0ff;
                margin-right: 5px;
            }
            QComboBox QAbstractItemView {
                background: rgba(25, 25, 40, 0.98);
                border: 1px solid rgba(0, 224, 255, 0.3);
                color: #00e0ff;
                selection-background-color: rgba(0, 224, 255, 0.2);
                outline: none;
            }
        """
    
    def get_radio_style(self) -> str:
        """è·å–å•é€‰æŒ‰é’®æ ·å¼"""
        return """
            QRadioButton {
                color: #8a92a6;
                font-size: 12px;
                spacing: 5px;
            }
            QRadioButton::indicator {
                width: 14px;
                height: 14px;
                border: 2px solid rgba(0, 224, 255, 0.4);
                border-radius: 7px;
                background: transparent;
            }
            QRadioButton::indicator:checked {
                background: qradialgradient(
                    cx: 0.5, cy: 0.5, radius: 0.5,
                    fx: 0.5, fy: 0.5,
                    stop: 0 #00e0ff,
                    stop: 0.6 #00e0ff,
                    stop: 0.7 transparent
                );
                border-color: #00e0ff;
            }
            QRadioButton:checked {
                color: #00e0ff;
            }
        """
    
    def setup_exporter(self):
        """è®¾ç½®å¯¼å‡ºå™¨"""
        self.exporter = ImageExporter(self.web_view)
        self.exporter.progress.connect(self.on_export_progress)
        self.exporter.finished.connect(self.on_export_finished)
        self.exporter.page_exported.connect(self.on_page_exported)
    
    def export_pages(self, folder: str):
        """å¯¼å‡ºæ‰€æœ‰é¡µé¢ä¸ºå›¾ç‰‡"""
        if not self.current_pages:
            QMessageBox.warning(self, "æç¤º", "æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹")
            return
        
        # åˆ›å»ºè¿›åº¦å¯¹è¯æ¡†
        self.progress_dialog = QProgressDialog(
            "æ­£åœ¨å¯¼å‡ºå›¾ç‰‡...", 
            "å–æ¶ˆ", 
            0, 
            self.total_pages, 
            self
        )
        self.progress_dialog.setWindowModality(Qt.WindowModal)
        self.progress_dialog.setMinimumDuration(0)
        self.progress_dialog.setAutoClose(False)
        self.progress_dialog.setAutoReset(False)
        self.progress_dialog.canceled.connect(self.on_export_canceled)
        
        # å¼€å§‹å¯¼å‡ºï¼ˆå§‹ç»ˆä»¥å®é™…å¤§å°å¯¼å‡ºï¼‰
        self.exporter.export_pages(
            self.current_pages,
            folder,
            self.html_generator,
            format="PNG",
            quality=100
        )
    
    def on_export_progress(self, current: int, total: int):
        """å¤„ç†å¯¼å‡ºè¿›åº¦"""
        if hasattr(self, 'progress_dialog') and self.progress_dialog:
            self.progress_dialog.setValue(current)
            self.progress_dialog.setLabelText(f"æ­£åœ¨å¯¼å‡ºç¬¬ {current}/{total} é¡µ...")
    
    def on_export_finished(self, success: bool, message: str):
        """å¤„ç†å¯¼å‡ºå®Œæˆ"""
        if hasattr(self, 'progress_dialog') and self.progress_dialog:
            try:
                self.progress_dialog.canceled.disconnect()
                self.progress_dialog.close()
                self.progress_dialog.deleteLater()
            except:
                pass
            finally:
                self.progress_dialog = None
        
        if success:
            size_info = f"({self.current_size}: {self.get_actual_size()}px)"
            QMessageBox.information(self, "å¯¼å‡ºæˆåŠŸ", f"{message}\nå°ºå¯¸: {size_info}")
        else:
            QMessageBox.warning(self, "å¯¼å‡ºå¤±è´¥", message)
    
    def on_page_exported(self, page_num: int, file_path: str):
        """å¤„ç†å•é¡µå¯¼å‡ºå®Œæˆ"""
        print(f"å·²å¯¼å‡ºç¬¬ {page_num} é¡µ: {file_path}")
    
    def on_export_canceled(self):
        """å¤„ç†å¯¼å‡ºå–æ¶ˆ"""
        self.exporter.cancel_export()
    
    def get_actual_size(self) -> str:
        """è·å–å®é™…å°ºå¯¸"""
        size_config = {
            "small": "720Ã—960",
            "medium": "1080Ã—1440",
            "large": "1440Ã—1920"
        }
        return size_config.get(self.current_size, "1080Ã—1440")
    
    def handle_scroll(self, percentage: float):
        """å¤„ç†ç¼–è¾‘å™¨æ»šåŠ¨åŒæ­¥ï¼ˆä¿ç•™æ¥å£å…¼å®¹æ€§ï¼‰"""
        pass
    
    def show_error(self, message: str):
        """æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯"""
        error_html = f"""
        <html>
        <body style="padding: 20px; font-family: sans-serif; background: #1a1a2e; color: #e0e6ed;">
            <h3 style="color: #ff4757;">é”™è¯¯</h3>
            <p style="color: #8a92a6;">{message}</p>
        </body>
        </html>
        """
        self.web_view.setHtml(error_html)
    
    def change_theme(self, theme: str):
        """åˆ‡æ¢ä¸»é¢˜"""
        self.html_generator.set_theme(theme)
        if self.current_pages:
            self.display_current_page()
### ç³»ç»Ÿ:
æˆ‘æ¥å¸®ä½ åˆ†æå’Œä¿®å¤è¿™äº›é—®é¢˜ã€‚è¿™äº›é—®é¢˜ä¸»è¦æ¶‰åŠå¸ƒå±€å’Œæ˜¾ç¤ºé€»è¾‘ï¼Œéœ€è¦å¯¹ `preview_widget.py` è¿›è¡Œä¸€äº›è°ƒæ•´ã€‚

## é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆï¼š

### 1. **é¡µæ•°é‡å¤æ˜¾ç¤ºé—®é¢˜**
å³ä¸Šè§’æ ‡é¢˜æ çš„ `page_info_label` å’Œå·¦ä¸‹è§’æ§åˆ¶æ çš„é¡µç è·³è½¬éƒ½æ˜¾ç¤ºäº†é¡µæ•°ï¼Œç¡®å®é‡å¤äº†ã€‚

### 2. **æ§åˆ¶æ å±…ä¸­é—®é¢˜**
æ§åˆ¶æ çš„æŒ‰é’®å’Œé¡µç é€‰æ‹©å™¨åº”è¯¥å±…ä¸­æ˜¾ç¤ºã€‚

### 3. **å®é™…å¤§å°æ¨¡å¼æ»šåŠ¨æ¡é—®é¢˜**
WebView éœ€è¦æ­£ç¡®é…ç½®ä»¥æ”¯æŒæ»šåŠ¨ã€‚

### 4. **é€‚åº”çª—å£æ¨¡å¼å±…ä¸­é—®é¢˜**
éœ€è¦è°ƒæ•´ç¼©æ”¾åçš„å±…ä¸­é€»è¾‘ã€‚

### 5. **å³ä¾§ç©ºç™½åŒºåŸŸé—®é¢˜**
å¯èƒ½æ˜¯å®¹å™¨è¾¹è·æˆ–WebViewå°ºå¯¸è®¾ç½®çš„é—®é¢˜ã€‚

ç”±äºæ”¹åŠ¨è¾ƒå¤§ï¼Œæˆ‘æä¾›å®Œæ•´çš„ä¿®å¤åçš„ä»£ç ï¼š ä»£ç 
```python
# ============================================
# src/ui/preview_widget.py - ä¿®å¤ç‰ˆæœ¬
# ============================================
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QLabel, QFrame, 
                               QPushButton, QHBoxLayout, QProgressDialog,
                               QMessageBox, QComboBox, QButtonGroup, QRadioButton,
                               QScrollArea)
from PySide6.QtWebEngineWidgets import QWebEngineView
from PySide6.QtCore import QUrl, QTimer, Signal, Qt, QSize, QEvent
from PySide6.QtGui import QWheelEvent
from pathlib import Path
from src.core.markdown_processor import MarkdownProcessor
from src.core.html_generator import HTMLGenerator
from src.utils.paginator import SmartPaginator
from src.utils.exporter import ImageExporter

class PreviewWidget(QWidget):
    pageChanged = Signal(int, int)  # å½“å‰é¡µï¼Œæ€»é¡µæ•°
    sizeChanged = Signal(str)  # å°ºå¯¸æ”¹å˜ä¿¡å·
    
    def __init__(self):
        super().__init__()
        self.current_pages = []  # å­˜å‚¨åˆ†é¡µåçš„HTMLå†…å®¹
        self.current_page = 1
        self.total_pages = 1
        self.markdown_text = ""  # ä¿å­˜åŸå§‹markdownæ–‡æœ¬
        self.current_size = "medium"  # å½“å‰é¡µé¢å°ºå¯¸
        self.preview_mode = "fit"  # é¢„è§ˆæ¨¡å¼: fit(é€‚åº”çª—å£) æˆ– actual(å®é™…å¤§å°)
        
        # åˆå§‹åŒ–å¤„ç†å™¨
        self.markdown_processor = MarkdownProcessor()
        self.html_generator = HTMLGenerator(page_size="medium")
        self.paginator = SmartPaginator(page_size="medium")
        
        # åˆå§‹åŒ–UI
        self.init_ui()
        
        # è®¾ç½®å¯¼å‡ºå™¨
        self.setup_exporter()
        
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # åˆ›å»ºå®¹å™¨æ¡†æ¶
        container = QFrame()
        container.setStyleSheet("""
            QFrame {
                background: rgba(25, 25, 40, 0.95);
                border: 1px solid rgba(0, 224, 255, 0.2);
                border-radius: 16px;
            }
        """)
        container_layout = QVBoxLayout(container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(0)
        
        # åˆ›å»ºæ ‡é¢˜æ 
        title_bar = self.create_title_bar()
        
        # åˆ›å»ºWebViewå®¹å™¨ï¼ˆç”¨äºå®é™…å¤§å°æ¨¡å¼çš„æ»šåŠ¨ï¼‰
        self.create_web_view_container()
        
        # åˆ›å»ºæ§åˆ¶æ 
        control_bar = self.create_control_bar()
        
        # ç»„è£…å¸ƒå±€
        container_layout.addWidget(title_bar)
        container_layout.addWidget(self.web_container, 1)
        container_layout.addWidget(control_bar)
        
        layout.addWidget(container)
        
        # è¿æ¥ä¿¡å·
        self.connect_signals()
        
        # åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        self.update_buttons()
        
        # å®‰è£…äº‹ä»¶è¿‡æ»¤å™¨ä»¥å¤„ç†æ»šè½®äº‹ä»¶
        self.web_view.installEventFilter(self)
    
    def create_title_bar(self):
        """åˆ›å»ºæ ‡é¢˜æ """
        title_bar = QFrame()
        title_bar.setFixedHeight(50)
        title_bar.setStyleSheet("""
            QFrame {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 224, 255, 0.1),
                    stop: 0.5 rgba(0, 150, 255, 0.15),
                    stop: 1 rgba(0, 224, 255, 0.1)
                );
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
                border-bottom: 1px solid rgba(0, 224, 255, 0.2);
            }
        """)
        
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(20, 5, 20, 5)
        title_layout.setSpacing(15)
        
        # æ ‡é¢˜
        title = QLabel("ğŸ‘€ å®æ—¶é¢„è§ˆ")
        title.setStyleSheet("""
            QLabel {
                color: #00e0ff;
                font-size: 16px;
                font-weight: 600;
                letter-spacing: 0.5px;
                background: transparent;
            }
        """)
        
        # å°ºå¯¸é€‰æ‹©æ ‡ç­¾
        size_label = QLabel("å°ºå¯¸:")
        size_label.setStyleSheet("""
            QLabel {
                color: #8a92a6;
                font-size: 12px;
                background: transparent;
            }
        """)
        
        # å°ºå¯¸é€‰æ‹©ä¸‹æ‹‰æ¡†
        self.size_selector = QComboBox()
        self.size_selector.addItems(["å°å°ºå¯¸ (720Ã—960)", "ä¸­å°ºå¯¸ (1080Ã—1440)", "å¤§å°ºå¯¸ (1440Ã—1920)"])
        self.size_selector.setCurrentIndex(1)
        self.size_selector.setFixedWidth(150)
        self.size_selector.setStyleSheet(self.get_combobox_style())
        
        # é¢„è§ˆæ¨¡å¼é€‰æ‹©
        mode_label = QLabel("æ¨¡å¼:")
        mode_label.setStyleSheet("""
            QLabel {
                color: #8a92a6;
                font-size: 12px;
                background: transparent;
            }
        """)
        
        # é¢„è§ˆæ¨¡å¼æŒ‰é’®ç»„
        self.mode_group = QButtonGroup()
        
        self.fit_mode_btn = QRadioButton("é€‚åº”çª—å£")
        self.fit_mode_btn.setChecked(True)
        self.fit_mode_btn.setStyleSheet(self.get_radio_style())
        
        self.actual_mode_btn = QRadioButton("å®é™…å¤§å°")
        self.actual_mode_btn.setStyleSheet(self.get_radio_style())
        
        self.mode_group.addButton(self.fit_mode_btn, 0)
        self.mode_group.addButton(self.actual_mode_btn, 1)
        
        # ç»„è£…æ ‡é¢˜æ ï¼ˆç§»é™¤äº†é¡µé¢ä¿¡æ¯æ ‡ç­¾ï¼‰
        title_layout.addWidget(title)
        title_layout.addSpacing(20)
        title_layout.addWidget(size_label)
        title_layout.addWidget(self.size_selector)
        title_layout.addSpacing(15)
        title_layout.addWidget(mode_label)
        title_layout.addWidget(self.fit_mode_btn)
        title_layout.addWidget(self.actual_mode_btn)
        title_layout.addStretch()
        
        return title_bar
    
    def create_web_view_container(self):
        """åˆ›å»ºWebViewå®¹å™¨ï¼ˆæ”¯æŒæ»šåŠ¨ï¼‰"""
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸå®¹å™¨
        self.web_container = QScrollArea()
        self.web_container.setStyleSheet("""
            QScrollArea {
                border: none;
                background: #1a1a2e;
            }
            QScrollBar:vertical {
                background: rgba(30, 30, 45, 0.5);
                width: 12px;
                border-radius: 6px;
                margin: 2px;
            }
            QScrollBar::handle:vertical {
                background: rgba(0, 224, 255, 0.3);
                border-radius: 6px;
                min-height: 30px;
            }
            QScrollBar::handle:vertical:hover {
                background: rgba(0, 224, 255, 0.5);
            }
            QScrollBar::add-line:vertical,
            QScrollBar::sub-line:vertical {
                height: 0px;
            }
            QScrollBar:horizontal {
                background: rgba(30, 30, 45, 0.5);
                height: 12px;
                border-radius: 6px;
                margin: 2px;
            }
            QScrollBar::handle:horizontal {
                background: rgba(0, 224, 255, 0.3);
                border-radius: 6px;
                min-width: 30px;
            }
            QScrollBar::handle:horizontal:hover {
                background: rgba(0, 224, 255, 0.5);
            }
            QScrollBar::add-line:horizontal,
            QScrollBar::sub-line:horizontal {
                width: 0px;
            }
        """)
        
        # åˆ›å»ºWebView
        self.web_view = QWebEngineView()
        self.web_view.setStyleSheet("""
            QWebEngineView {
                border: none;
                background: #1a1a2e;
            }
        """)
        
        # è®¾ç½®æ»šåŠ¨åŒºåŸŸ
        self.web_container.setWidget(self.web_view)
        self.web_container.setWidgetResizable(False)  # å®é™…å¤§å°æ¨¡å¼éœ€è¦
        self.web_container.setAlignment(Qt.AlignCenter)  # å±…ä¸­æ˜¾ç¤º
        
        # é»˜è®¤è®¾ç½®ä¸ºé€‚åº”çª—å£æ¨¡å¼ï¼ˆä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ï¼‰
        self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
    
    def create_control_bar(self):
        """åˆ›å»ºæ§åˆ¶æ """
        control_bar = QFrame()
        control_bar.setFixedHeight(60)
        control_bar.setStyleSheet("""
            QFrame {
                background: rgba(20, 20, 35, 0.8);
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
                border-top: 1px solid rgba(0, 224, 255, 0.1);
            }
        """)
        
        control_layout = QHBoxLayout(control_bar)
        control_layout.setContentsMargins(20, 12, 20, 12)
        control_layout.setSpacing(15)
        
        # åˆ›å»ºä¸­å¿ƒæ§åˆ¶åŒºå®¹å™¨
        center_controls = QWidget()
        center_layout = QHBoxLayout(center_controls)
        center_layout.setContentsMargins(0, 0, 0, 0)
        center_layout.setSpacing(15)
        
        # ä¸Šä¸€é¡µæŒ‰é’®
        self.prev_btn = QPushButton("â¬… ä¸Šä¸€é¡µ")
        self.prev_btn.setFixedSize(100, 36)
        self.prev_btn.setStyleSheet(self.get_button_style())
        
        # é¡µé¢ä¿¡æ¯æ ‡ç­¾
        self.page_info_label = QLabel("")
        self.page_info_label.setStyleSheet("""
            QLabel {
                color: #00e0ff;
                font-size: 14px;
                font-weight: 600;
                padding: 5px 15px;
                background: rgba(0, 224, 255, 0.05);
                border: 1px solid rgba(0, 224, 255, 0.2);
                border-radius: 12px;
                min-width: 100px;
                text-align: center;
            }
        """)
        self.page_info_label.setAlignment(Qt.AlignCenter)
        
        # ä¸‹ä¸€é¡µæŒ‰é’®
        self.next_btn = QPushButton("ä¸‹ä¸€é¡µ â¡")
        self.next_btn.setFixedSize(100, 36)
        self.next_btn.setStyleSheet(self.get_button_style())
        
        # ç»„è£…ä¸­å¿ƒæ§åˆ¶åŒº
        center_layout.addWidget(self.prev_btn)
        center_layout.addWidget(self.page_info_label)
        center_layout.addWidget(self.next_btn)
        
        # å¿«æ·æç¤º
        tips_label = QLabel("ğŸ’¡ æç¤º: ä½¿ç”¨é¼ æ ‡æ»šè½®æˆ– â†‘â†“ é”®ç¿»é¡µ")
        tips_label.setStyleSheet("""
            QLabel {
                color: #6a7a8a;
                font-size: 11px;
                font-style: italic;
                background: transparent;
            }
        """)
        
        # ç»„è£…æ§åˆ¶æ ï¼ˆå±…ä¸­æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®ï¼‰
        control_layout.addStretch()
        control_layout.addWidget(center_controls)
        control_layout.addStretch()
        control_layout.addWidget(tips_label)
        
        return control_bar
    
    def connect_signals(self):
        """è¿æ¥ä¿¡å·"""
        self.prev_btn.clicked.connect(self.prev_page)
        self.next_btn.clicked.connect(self.next_page)
        self.size_selector.currentIndexChanged.connect(self.on_size_changed)
        self.mode_group.buttonClicked.connect(self.on_mode_changed)
    
    def eventFilter(self, obj, event):
        """äº‹ä»¶è¿‡æ»¤å™¨ - å¤„ç†æ»šè½®äº‹ä»¶å®ç°ç¿»é¡µ"""
        if obj == self.web_view and event.type() == QEvent.Wheel:
            wheel_event = event
            
            # åœ¨é€‚åº”çª—å£æ¨¡å¼ä¸‹ï¼Œæ»šè½®ç›´æ¥ç¿»é¡µ
            if self.preview_mode == "fit":
                if wheel_event.angleDelta().y() > 0:
                    self.prev_page()
                else:
                    self.next_page()
                return True  # é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
            
            # å®é™…å¤§å°æ¨¡å¼ä¸‹ï¼Œè®©æ»šåŠ¨æ­£å¸¸å·¥ä½œ
            return False
        
        return super().eventFilter(obj, event)
    
    def keyPressEvent(self, event):
        """å¤„ç†é”®ç›˜äº‹ä»¶"""
        if event.key() == Qt.Key_Up or event.key() == Qt.Key_PageUp:
            self.prev_page()
        elif event.key() == Qt.Key_Down or event.key() == Qt.Key_PageDown:
            self.next_page()
        elif event.key() == Qt.Key_Home:
            self.go_to_page(1)
        elif event.key() == Qt.Key_End:
            self.go_to_page(self.total_pages)
        else:
            super().keyPressEvent(event)
    
    def on_mode_changed(self):
        """å¤„ç†é¢„è§ˆæ¨¡å¼æ”¹å˜"""
        if self.fit_mode_btn.isChecked():
            self.preview_mode = "fit"
            # é€‚åº”çª—å£æ¨¡å¼ï¼šéšè—æ»šåŠ¨æ¡
            self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            self.web_container.setWidgetResizable(False)
        else:
            self.preview_mode = "actual"
            # å®é™…å¤§å°æ¨¡å¼ï¼šæ˜¾ç¤ºæ»šåŠ¨æ¡
            self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAsNeeded)
            self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
            self.web_container.setWidgetResizable(False)
        
        # é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢
        self.display_current_page()
    
    def on_size_changed(self, index):
        """å¤„ç†å°ºå¯¸æ”¹å˜"""
        size_map = {0: "small", 1: "medium", 2: "large"}
        new_size = size_map.get(index, "medium")
        
        if new_size != self.current_size:
            self.current_size = new_size
            
            # æ›´æ–°å„ç»„ä»¶çš„å°ºå¯¸è®¾ç½®
            self.html_generator = HTMLGenerator(page_size=new_size)
            self.paginator.set_page_size(new_size)
            
            # é‡æ–°å¤„ç†å†…å®¹
            if self.markdown_text:
                self.update_content(self.markdown_text)
            
            # å‘é€å°ºå¯¸æ”¹å˜ä¿¡å·
            self.sizeChanged.emit(new_size)
    
    def update_content(self, markdown_text: str):
        """æ›´æ–°é¢„è§ˆå†…å®¹"""
        try:
            self.markdown_text = markdown_text
            
            # å¤„ç† Markdown
            html_content = self.markdown_processor.parse(markdown_text)
            
            # ä½¿ç”¨æ™ºèƒ½åˆ†é¡µå™¨è¿›è¡Œåˆ†é¡µ
            self.current_pages = self.paginator.paginate(html_content)
            
            # ä¼˜åŒ–åˆ†é¡µç»“æœ
            self.current_pages = self.paginator.optimize_pages(self.current_pages)
            
            self.total_pages = len(self.current_pages)
            self.current_page = 1
            
            # æ˜¾ç¤ºç¬¬ä¸€é¡µ
            self.display_current_page()
            
            # æ›´æ–°æŒ‰é’®å’Œä¿¡æ¯
            self.update_buttons()
            self.update_page_info()
            
        except Exception as e:
            self.show_error(f"é¢„è§ˆé”™è¯¯: {str(e)}")
    
    def display_current_page(self):
        """æ˜¾ç¤ºå½“å‰é¡µ"""
        if not self.current_pages:
            return
            
        if 1 <= self.current_page <= len(self.current_pages):
            page_content = self.current_pages[self.current_page - 1]
            
            # è·å–ç›®æ ‡å°ºå¯¸
            size_config = {
                "small": (720, 960),
                "medium": (1080, 1440),
                "large": (1440, 1920)
            }
            target_width, target_height = size_config.get(self.current_size, (1080, 1440))
            
            # æ ¹æ®é¢„è§ˆæ¨¡å¼ç”Ÿæˆä¸åŒçš„HTML
            if self.preview_mode == "fit":
                # é€‚åº”çª—å£æ¨¡å¼ï¼šä½¿ç”¨ç¼©æ”¾ä½¿å†…å®¹é€‚åº”è§†çª—
                full_html = self.generate_fit_html(page_content)
                
                # è®¾ç½®WebViewå°ºå¯¸ä¸ºå®¹å™¨å¤§å°
                container_size = self.web_container.size()
                self.web_view.resize(container_size)
            else:
                # å®é™…å¤§å°æ¨¡å¼ï¼šæ˜¾ç¤ºçœŸå®å°ºå¯¸
                full_html = self.html_generator.generate(page_content)
                
                # è®¾ç½®WebViewä¸ºå®é™…å°ºå¯¸
                self.web_view.setFixedSize(target_width, target_height)
            
            # åŠ è½½åˆ°WebView
            self.web_view.setHtml(full_html, QUrl("file:///"))
    
    def generate_fit_html(self, content: str) -> str:
        """ç”Ÿæˆé€‚åº”çª—å£çš„HTML"""
        # è·å–å®¹å™¨å°ºå¯¸
        container_width = self.web_container.width()
        container_height = self.web_container.height()
        
        # è·å–ç›®æ ‡å°ºå¯¸
        size_config = {
            "small": (720, 960),
            "medium": (1080, 1440),
            "large": (1440, 1920)
        }
        target_width, target_height = size_config.get(self.current_size, (1080, 1440))
        
        # è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒæ¯”ä¾‹ï¼Œé€‚åº”çª—å£ï¼‰
        scale_x = (container_width - 40) / target_width  # å‡å»è¾¹è·
        scale_y = (container_height - 40) / target_height
        scale = min(scale_x, scale_y, 1.0)  # ä¸è¶…è¿‡åŸå§‹å¤§å°
        
        # ç”Ÿæˆå¸¦ç¼©æ”¾çš„HTML
        html = self.html_generator.generate(content)
        
        # æ³¨å…¥ç¼©æ”¾å’Œå±…ä¸­æ ·å¼
        scale_style = f"""
        <style>
            html, body {{
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #1a1a2e;
            }}
            .scaled-container {{
                transform: scale({scale});
                transform-origin: center center;
                width: {target_width}px;
                height: {target_height}px;
            }}
            .page-container {{
                box-shadow: 0 4px 20px rgba(0, 224, 255, 0.15);
                width: {target_width}px !important;
                height: {target_height}px !important;
            }}
        </style>
        <script>
            // åŒ…è£…é¡µé¢å†…å®¹
            window.onload = function() {{
                const pageContainer = document.querySelector('.page-container');
                if (pageContainer && !pageContainer.parentElement.classList.contains('scaled-container')) {{
                    const wrapper = document.createElement('div');
                    wrapper.className = 'scaled-container';
                    pageContainer.parentNode.insertBefore(wrapper, pageContainer);
                    wrapper.appendChild(pageContainer);
                }}
            }};
        </script>
        """
        
        # æ’å…¥ç¼©æ”¾æ ·å¼
        html = html.replace('</head>', scale_style + '</head>')
        
        return html
    
    def prev_page(self):
        """ä¸Šä¸€é¡µ"""
        if self.current_page > 1:
            self.go_to_page(self.current_page - 1)
    
    def next_page(self):
        """ä¸‹ä¸€é¡µ"""
        if self.current_page < self.total_pages:
            self.go_to_page(self.current_page + 1)
    
    def go_to_page(self, page_num: int):
        """è·³è½¬åˆ°æŒ‡å®šé¡µ"""
        if 1 <= page_num <= self.total_pages:
            self.current_page = page_num
            self.display_current_page()
            self.update_buttons()
            self.update_page_info()
    
    def update_buttons(self):
        """æ›´æ–°æŒ‰é’®çŠ¶æ€"""
        self.prev_btn.setEnabled(self.current_page > 1)
        self.next_btn.setEnabled(self.current_page < self.total_pages)
        
        # å‘é€é¡µé¢æ”¹å˜ä¿¡å·
        self.pageChanged.emit(self.current_page, self.total_pages)
    
    def update_page_info(self):
        """æ›´æ–°é¡µé¢ä¿¡æ¯æ˜¾ç¤º"""
        if self.total_pages > 1:
            self.page_info_label.setText(f"ç¬¬ {self.current_page} / {self.total_pages} é¡µ")
        else:
            self.page_info_label.setText("ç¬¬ 1 é¡µ")
    
    def get_button_style(self) -> str:
        """è·å–æŒ‰é’®æ ·å¼"""
        return """
            QPushButton {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 224, 255, 0.15),
                    stop: 1 rgba(0, 150, 255, 0.1)
                );
                border: 1px solid rgba(0, 224, 255, 0.4);
                color: #00e0ff;
                padding: 8px 16px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
            }
            QPushButton:hover {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 224, 255, 0.25),
                    stop: 1 rgba(0, 150, 255, 0.2)
                );
                border: 1px solid rgba(0, 224, 255, 0.6);
            }
            QPushButton:pressed {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 224, 255, 0.35),
                    stop: 1 rgba(0, 150, 255, 0.3)
                );
            }
            QPushButton:disabled {
                background: rgba(30, 30, 45, 0.5);
                border-color: rgba(100, 100, 120, 0.3);
                color: rgba(100, 100, 120, 0.5);
            }
        """
    
    def get_combobox_style(self) -> str:
        """è·å–ä¸‹æ‹‰æ¡†æ ·å¼"""
        return """
            QComboBox {
                background: rgba(0, 224, 255, 0.1);
                border: 1px solid rgba(0, 224, 255, 0.3);
                color: #00e0ff;
                padding: 5px 10px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
            }
            QComboBox:hover {
                background: rgba(0, 224, 255, 0.15);
                border: 1px solid rgba(0, 224, 255, 0.5);
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-top: 5px solid #00e0ff;
                margin-right: 5px;
            }
            QComboBox QAbstractItemView {
                background: rgba(25, 25, 40, 0.98);
                border: 1px solid rgba(0, 224, 255, 0.3);
                color: #00e0ff;
                selection-background-color: rgba(0, 224, 255, 0.2);
                outline: none;
            }
        """
    
    def get_radio_style(self) -> str:
        """è·å–å•é€‰æŒ‰é’®æ ·å¼"""
        return """
            QRadioButton {
                color: #8a92a6;
                font-size: 12px;
                spacing: 5px;
            }
            QRadioButton::indicator {
                width: 14px;
                height: 14px;
                border: 2px solid rgba(0, 224, 255, 0.4);
                border-radius: 7px;
                background: transparent;
            }
            QRadioButton::indicator:checked {
                background: qradialgradient(
                    cx: 0.5, cy: 0.5, radius: 0.5,
                    fx: 0.5, fy: 0.5,
                    stop: 0 #00e0ff,
                    stop: 0.6 #00e0ff,
                    stop: 0.7 transparent
                );
                border-color: #00e0ff;
            }
            QRadioButton:checked {
                color: #00e0ff;
            }
        """
    
    def setup_exporter(self):
        """è®¾ç½®å¯¼å‡ºå™¨"""
        self.exporter = ImageExporter(self.web_view)
        self.exporter.progress.connect(self.on_export_progress)
        self.exporter.finished.connect(self.on_export_finished)
        self.exporter.page_exported.connect(self.on_page_exported)
    
    def export_pages(self, folder: str):
        """å¯¼å‡ºæ‰€æœ‰é¡µé¢ä¸ºå›¾ç‰‡"""
        if not self.current_pages:
            QMessageBox.warning(self, "æç¤º", "æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹")
            return
        
        # åˆ›å»ºè¿›åº¦å¯¹è¯æ¡†
        self.progress_dialog = QProgressDialog(
            "æ­£åœ¨å¯¼å‡ºå›¾ç‰‡...", 
            "å–æ¶ˆ", 
            0, 
            self.total_pages, 
            self
        )
        self.progress_dialog.setWindowModality(Qt.WindowModal)
        self.progress_dialog.setMinimumDuration(0)
        self.progress_dialog.setAutoClose(False)
        self.progress_dialog.setAutoReset(False)
        self.progress_dialog.canceled.connect(self.on_export_canceled)
        
        # å¼€å§‹å¯¼å‡ºï¼ˆå§‹ç»ˆä»¥å®é™…å¤§å°å¯¼å‡ºï¼‰
        self.exporter.export_pages(
            self.current_pages,
            folder,
            self.html_generator,
            format="PNG",
            quality=100
        )
    
    def on_export_progress(self, current: int, total: int):
        """å¤„ç†å¯¼å‡ºè¿›åº¦"""
        if hasattr(self, 'progress_dialog') and self.progress_dialog:
            self.progress_dialog.setValue(current)
            self.progress_dialog.setLabelText(f"æ­£åœ¨å¯¼å‡ºç¬¬ {current}/{total} é¡µ...")
    
    def on_export_finished(self, success: bool, message: str):
        """å¤„ç†å¯¼å‡ºå®Œæˆ"""
        if hasattr(self, 'progress_dialog')
```

