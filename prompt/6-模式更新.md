### ç”¨æˆ·:
é¡¹ç›®èƒŒæ™¯
æˆ‘æ­£åœ¨å¼€å‘ä¸€ä¸ª Windows æ¡Œé¢åº”ç”¨ã€ŒCardCraftã€ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š
- ç”¨æˆ·è¾“å…¥ Markdown æ–‡æœ¬
- è‡ªåŠ¨æ¸²æŸ“æˆå°çº¢ä¹¦é£æ ¼çš„ç²¾ç¾å¡ç‰‡
- æ™ºèƒ½åˆ†é¡µï¼ˆ3:4 æ¯”ä¾‹ï¼Œ1080Ã—1440pxï¼‰
- æ‰¹é‡å¯¼å‡ºé«˜è´¨é‡å›¾ç‰‡
Â 
# æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼šPySide6 (Qt for Python)
- æ¸²æŸ“ï¼šQWebEngineView (åŸºäº Chromium)
- Markdownè§£æï¼špython-markdown + æ‰©å±•
- æ ·å¼ï¼šHTML + CSS (å°çº¢ä¹¦é£æ ¼)
- åˆ†é¡µï¼šJavaScript (åœ¨ WebEngine ä¸­æ‰§è¡Œ)
Â 
# æ ¸å¿ƒæ¶æ„è®¾è®¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â Â Â Â Â Â Â Â Â Â ä¸»çª—å£ (MainWindow) Â Â Â Â Â Â Â Â Â Â â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Â ç¼–è¾‘å™¨ç»„ä»¶ Â â”‚ Â Â é¢„è§ˆç»„ä»¶ Â Â Â â”‚ Â å·¥å…·æ  Â Â â”‚
â”‚ (QTextEdit) â”‚(QWebEngineView)â”‚ (QToolBar)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Markdownè§£æ Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â HTMLç”Ÿæˆ Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â æ™ºèƒ½åˆ†é¡µ Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â æ ·å¼æ¸²æŸ“ Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â å›¾ç‰‡å¯¼å‡º Â Â Â â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Â 
# é¡¹ç›®ç»“æ„
cardcraft/
â”œâ”€â”€ main.py Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # å¯åŠ¨ç¨‹åºï¼Œåˆ›å»º Qt åº”ç”¨
â”œâ”€â”€ requirements.txt Â Â Â Â Â Â Â Â Â Â Â # ä¾èµ–åŒ…åˆ—è¡¨ï¼šPySide6ã€markdown ç­‰
â”‚
src/
â”œâ”€â”€ ui/
â”‚ Â Â â”œâ”€â”€ main_window.py Â Â Â Â Â Â Â Â # ä¸»çª—å£ï¼šå·¦å³åˆ†æ å¸ƒå±€ï¼Œå¯¼å‡ºæŒ‰é’®ï¼Œ300mså»¶è¿Ÿæ›´æ–°
â”‚ Â Â â”œâ”€â”€ editor_widget.py Â Â Â Â Â Â # å·¦ä¾§ç¼–è¾‘å™¨ï¼šQTextEditï¼Œå«ç¤ºä¾‹æ–‡æœ¬
â”‚ Â Â â”œâ”€â”€ preview_widget.py Â Â Â Â Â # å³ä¾§é¢„è§ˆï¼šQWebEngineViewï¼Œé›†æˆåˆ†é¡µå’Œå¯¼å‡ºåŠŸèƒ½
â”‚ Â Â 
â”œâ”€â”€ core/
â”‚ Â Â â”œâ”€â”€ markdown_processor.py Â # Markdown è½¬ HTMLï¼šä½¿ç”¨ python-markdown åº“
â”‚ Â Â â”œâ”€â”€ html_generator.py Â Â Â Â Â # ç”Ÿæˆå®Œæ•´ç½‘é¡µï¼šæ”¯æŒé¡µç ã€å¤šä¸»é¢˜CSSæ ·å¼
â”‚ Â Â 
â”œâ”€â”€ utils/
â”‚ Â Â â”œâ”€â”€ paginator.py Â Â Â Â Â Â Â Â Â Â # âœ… æ™ºèƒ½åˆ†é¡µå™¨ï¼šHTMLå…ƒç´ è§£æã€é«˜åº¦ä¼°ç®—ã€åˆ†é¡µä¼˜åŒ–
â”‚ Â Â â”œâ”€â”€ exporter.py Â Â Â Â Â Â Â Â Â Â Â # âœ… å›¾ç‰‡å¯¼å‡ºå™¨ï¼šæ‰¹é‡å¯¼å‡ºã€è¿›åº¦è¿½è¸ªã€æ°´å°æ·»åŠ 
â”‚ Â Â â”œâ”€â”€ style_manager.py Â Â Â Â Â Â # âœ… æ ·å¼ç®¡ç†å™¨ï¼šå¤šä¸»é¢˜æ”¯æŒï¼ˆå°çº¢ä¹¦/Instagram/å¾®ä¿¡/çŸ¥ä¹/æ·±è‰²ï¼‰
â”‚ Â Â 
â”œâ”€â”€ resources/
â”‚ Â Â â”œâ”€â”€ styles/ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â # ï¿½ï¿½ é¢„ç•™ï¼šæœªæ¥å¯å­˜æ”¾ç‹¬ç«‹CSSæ–‡ä»¶
â”‚ Â Â â””â”€â”€ templates/ Â Â Â Â Â Â Â Â Â Â Â Â # ï¿½ï¿½ é¢„ç•™ï¼šæœªæ¥å¯å­˜æ”¾HTMLæ¨¡æ¿æ–‡ä»¶# æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚
Â 
## 1. æ™ºèƒ½åˆ†é¡µç®—æ³•
- æ¯é¡µå›ºå®šå°ºå¯¸ï¼š1080Ã—1440px (3:4æ¯”ä¾‹)
- åˆ†é¡µåŸåˆ™ï¼š
Â Â * æ®µè½å®Œæ•´æ€§ï¼šä¸åœ¨æ®µè½ä¸­é—´åˆ†é¡µ
Â Â * æ ‡é¢˜å…³è”ï¼šæ ‡é¢˜ä¸å…¶åç»­å†…å®¹ä¿æŒåŒé¡µ
Â Â * åˆ—è¡¨è¿ç»­ï¼šåˆ—è¡¨é¡¹å°½é‡ä¸åˆ†ç¦»
Â Â * ä»£ç å®Œæ•´ï¼šä»£ç å—ä¸è·¨é¡µ
Â Â * è§†è§‰å¹³è¡¡ï¼šé¿å…é¡µé¢è¿‡ç©ºæˆ–è¿‡æ»¡
Â 
## 2. æ ·å¼ç³»ç»Ÿ
- é¢„è®¾ä¸»é¢˜ï¼šå°çº¢ä¹¦ã€Instagramã€å¾®ä¿¡ã€çŸ¥ä¹ç­‰
- æ ·å¼è¦ç´ ï¼š
Â Â * å­—ä½“ï¼šä¸­æ–‡ç”¨è‹¹æ–¹/å¾®è½¯é›…é»‘ï¼Œè¥¿æ–‡ç”¨ Helvetica
Â Â * é¢œè‰²ï¼šä¸»è‰² #FF2442ï¼Œæ–‡å­— #333333
Â Â * é—´è·ï¼šæ®µè½é—´è· 20pxï¼Œè¡Œé«˜ 1.8
Â Â * ç‰¹æ•ˆï¼šå¡ç‰‡é˜´å½±ã€åœ†è§’ã€æ¸å˜èƒŒæ™¯
Â 
## 3. æ¸²æŸ“æµç¨‹
```python
# ä¼ªä»£ç ç¤ºä¾‹
markdown_text â†’ parse_markdown() â†’ generate_html() â†’ apply_styles() â†’ paginate() â†’ render_preview() â†’ export_images()
4. å¯¼å‡ºåŠŸèƒ½
Â 
æ ¼å¼ï¼šPNG/JPEG
è´¨é‡ï¼šæ”¯æŒ 1x/2x/3x åˆ†è¾¨ç‡
å‘½åï¼šè‡ªåŠ¨ç¼–å·ï¼Œå¦‚ card_01.png, card_02.png
æ‰¹é‡ï¼šä¸€æ¬¡å¯¼å‡ºæ‰€æœ‰åˆ†é¡µ
Â 
ä»£ç è§„èŒƒ
Â 
ä½¿ç”¨ç±»å‹æ³¨è§£ (typing)
éµå¾ª PEP 8
ä¸­æ–‡æ³¨é‡Šè¯´æ˜å…³é”®é€»è¾‘
é”™è¯¯å¤„ç†è¦å®Œå–„
Â 
æ€§èƒ½è¦æ±‚
Â 
å®æ—¶é¢„è§ˆå»¶è¿Ÿ < 300ms
æ”¯æŒ 10000 å­—çš„æ–‡æ¡£
å¯¼å‡ºé€Ÿåº¦ï¼šæ¯å¼ å¡ç‰‡ < 1ç§’
Â 
é—®é¢˜æè¿°
ç›®å‰æˆ‘å‘ç°ï¼Œå¯¼å‡ºå›¾ç‰‡çš„æ—¶å€™ï¼Œé¢„è§ˆç»„ä»¶æœ‰æ—¶å€™è™½ç„¶æˆ‘ç‚¹å‡»çš„æ˜¯é€‚åº”çª—å£æ¨¡å¼ï¼Œä½†æ˜¯å¯¼å‡ºå›¾ç‰‡åï¼Œä¼šåˆ‡æ¢æˆå®é™…å¤§å°æ¨¡å¼
æœŸæœ›è¾“å‡º
ä¿®æ”¹é—®é¢˜çš„ä»£ç ï¼›è‹¥ä¿®æ”¹å°åˆ™ç›´æ¥å‘Šè¯‰æˆ‘ä½ç½®ï¼Œæˆ‘ä¸ªäººè¿›è¡Œä¿®æ”¹ï¼›è‹¥å˜åŠ¨å¤§ï¼Œåˆ™ç»™æˆ‘è¿™ä¸ªæ–‡ä»¶çš„å®Œæ•´ä»£ç 
editor_widget.py->text/plain-># ============================================
# src/ui/editor_widget.py - Qtå…¼å®¹ç‰ˆæœ¬ï¼ˆæ— è­¦å‘Šï¼‰
# ============================================
from PySide6.QtWidgets import QTextEdit, QVBoxLayout, QWidget, QLabel, QFrame, QHBoxLayout
from PySide6.QtGui import QFont, QTextOption, QPalette, QColor, QSyntaxHighlighter, QTextCharFormat
from PySide6.QtCore import Signal, Qt, QRegularExpression

class MarkdownHighlighter(QSyntaxHighlighter):
    """Markdown è¯­æ³•é«˜äº®å™¨"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.highlighting_rules = []
        
        # æ ‡é¢˜
        heading_format = QTextCharFormat()
        heading_format.setForeground(QColor(0, 255, 136))
        heading_format.setFontWeight(QFont.Bold)
        self.highlighting_rules.append((QRegularExpression(r'^#{1,6}\s.*'), heading_format))
        
        # ç²—ä½“
        bold_format = QTextCharFormat()
        bold_format.setForeground(QColor(255, 179, 71))
        bold_format.setFontWeight(QFont.Bold)
        self.highlighting_rules.append((QRegularExpression(r'\*\*[^\*]+\*\*'), bold_format))
        
        # æ–œä½“
        italic_format = QTextCharFormat()
        italic_format.setForeground(QColor(255, 179, 71))
        italic_format.setFontItalic(True)
        self.highlighting_rules.append((QRegularExpression(r'\*[^\*]+\*'), italic_format))
        
        # ä»£ç å—
        code_format = QTextCharFormat()
        code_format.setForeground(QColor(139, 233, 253))
        code_format.setFontFamily("Cascadia Code, Consolas, monospace")
        self.highlighting_rules.append((QRegularExpression(r'`[^`]+`'), code_format))
        
        # é“¾æ¥
        link_format = QTextCharFormat()
        link_format.setForeground(QColor(189, 147, 249))
        link_format.setFontUnderline(True)
        self.highlighting_rules.append((QRegularExpression(r'\[([^\]]+)\]\(([^\)]+)\)'), link_format))
        
        # åˆ—è¡¨
        list_format = QTextCharFormat()
        list_format.setForeground(QColor(255, 121, 198))
        self.highlighting_rules.append((QRegularExpression(r'^\s*[\*\-\+]\s'), list_format))
        self.highlighting_rules.append((QRegularExpression(r'^\s*\d+\.\s'), list_format))
        
        # å¼•ç”¨
        quote_format = QTextCharFormat()
        quote_format.setForeground(QColor(98, 114, 164))
        quote_format.setFontItalic(True)
        self.highlighting_rules.append((QRegularExpression(r'^>\s.*'), quote_format))
        
    def highlightBlock(self, text):
        for pattern, format in self.highlighting_rules:
            iterator = pattern.globalMatch(text)
            while iterator.hasNext():
                match = iterator.next()
                self.setFormat(match.capturedStart(), match.capturedLength(), format)

class EditorWidget(QWidget):
    textChanged = Signal()
    scrollChanged = Signal(float)
    
    def __init__(self):
        super().__init__()
        self.init_ui()
        
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # ç¼–è¾‘å™¨å®¹å™¨
        container = QFrame()
        container.setStyleSheet("""
            QFrame {
                background: transparent;
                border: none;
            }
        """)
        container_layout = QVBoxLayout(container)
        container_layout.setContentsMargins(1, 1, 1, 1)
        container_layout.setSpacing(0)
        
        # åˆ›å»ºç¼–è¾‘å™¨
        self.editor = QTextEdit()
        self.setup_editor()
        
        # æ·»åŠ åˆ°å®¹å™¨
        container_layout.addWidget(self.editor)
        layout.addWidget(container)
        
    def setup_editor(self):
        """è®¾ç½®ç¼–è¾‘å™¨ - Qtå…¼å®¹ç‰ˆæœ¬"""
        # è®¾ç½®å­—ä½“
        font = QFont("Cascadia Code, Consolas, Monaco, monospace", 13)
        font.setStyleHint(QFont.Monospace)
        self.editor.setFont(font)
        
        # è®¾ç½®æ¢è¡Œæ¨¡å¼
        self.editor.setLineWrapMode(QTextEdit.WidgetWidth)
        self.editor.setWordWrapMode(QTextOption.WordWrap)
        
        # è®¾ç½®tabå®½åº¦
        self.editor.setTabStopDistance(40)
        
        # åº”ç”¨è¯­æ³•é«˜äº®
        self.highlighter = MarkdownHighlighter(self.editor.document())
        
        # è®¾ç½®ç¼–è¾‘å™¨æ ·å¼ - Qtå…¼å®¹ç‰ˆæœ¬ï¼ˆç§»é™¤ä¸æ”¯æŒçš„CSSå±æ€§ï¼‰
        self.editor.setStyleSheet("""
            QTextEdit {
                background: rgba(20, 20, 40, 0.6);
                border: none;
                border-radius: 20px;
                padding: 25px;
                color: rgba(255, 255, 255, 0.95);
                selection-background-color: rgba(0, 255, 136, 0.3);
                selection-color: white;
                font-size: 14px;
                line-height: 1.6;
            }
            
            QScrollBar:vertical {
                background: rgba(255, 255, 255, 0.03);
                width: 12px;
                border-radius: 6px;
                margin: 4px;
            }
            
            QScrollBar::handle:vertical {
                background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 255, 255, 0.3),
                    stop: 1 rgba(255, 0, 255, 0.3));
                border-radius: 6px;
                min-height: 30px;
            }
            
            QScrollBar::handle:vertical:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 255, 255, 0.5),
                    stop: 1 rgba(255, 0, 255, 0.5));
            }
            
            QScrollBar::add-line:vertical,
            QScrollBar::sub-line:vertical {
                height: 0px;
            }
            
            QScrollBar:horizontal {
                background: rgba(255, 255, 255, 0.03);
                height: 12px;
                border-radius: 6px;
                margin: 4px;
            }
            
            QScrollBar::handle:horizontal {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 255, 0.3),
                    stop: 1 rgba(255, 0, 255, 0.3));
                border-radius: 6px;
                min-width: 30px;
            }
            
            QScrollBar::handle:horizontal:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 255, 0.5),
                    stop: 1 rgba(255, 0, 255, 0.5));
            }
            
            QScrollBar::add-line:horizontal,
            QScrollBar::sub-line:horizontal {
                width: 0px;
            }
        """)
        
        # è®¾ç½®é»˜è®¤æ–‡æœ¬
        self.editor.setPlainText("""# ğŸŒ¸ å°çº¢ä¹¦ç¬”è®°æ ‡é¢˜

## ä»Šæ—¥åˆ†äº«

å¤§å®¶å¥½å‘€ï½ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªè¶…å®ç”¨çš„ **Markdown ç¼–è¾‘å™¨**ï¼

### âœ¨ ä¸»è¦åŠŸèƒ½

1. **å®æ—¶é¢„è§ˆ** - å·¦è¾¹å†™ï¼Œå³è¾¹çœ‹
2. **æ™ºèƒ½åˆ†é¡µ** - è‡ªåŠ¨é€‚é…å°çº¢ä¹¦å¡ç‰‡å°ºå¯¸
3. **ä¸€é”®å¯¼å‡º** - æ‰¹é‡ç”Ÿæˆç²¾ç¾å›¾ç‰‡

### ğŸ“ ä½¿ç”¨æ–¹æ³•

- åœ¨å·¦ä¾§è¾“å…¥ Markdown æ–‡æœ¬
- å³ä¾§å®æ—¶æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ
- ç‚¹å‡»å¯¼å‡ºæŒ‰é’®ä¿å­˜å›¾ç‰‡

> ğŸ’¡ å°è´´å£«ï¼šæ”¯æŒæ‰€æœ‰å¸¸ç”¨çš„ Markdown è¯­æ³•å“¦ï½

### ä»£ç ç¤ºä¾‹

```python
def hello():
    print("Hello, å°çº¢ä¹¦!")
    return "â¤ï¸"
```

### è¡¨æ ¼ç¤ºä¾‹

| åŠŸèƒ½ | æè¿° | çŠ¶æ€ |
|------|------|------|
| ç¼–è¾‘ | Markdownç¼–è¾‘å™¨ | âœ… |
| é¢„è§ˆ | å®æ—¶æ¸²æŸ“ | âœ… |
| å¯¼å‡º | å›¾ç‰‡ç”Ÿæˆ | âœ… |

---

å–œæ¬¢çš„è¯è®°å¾— **ç‚¹èµæ”¶è—** å“¦ï½ â¤ï¸

å…³æ³¨æˆ‘ï¼Œè·å–æ›´å¤šå®ç”¨å·¥å…·ï¼""")
        
        # è¿æ¥ä¿¡å·
        self.editor.textChanged.connect(self.on_text_changed)
        self.editor.verticalScrollBar().valueChanged.connect(self.on_scroll)
        
    def on_text_changed(self):
        """å¤„ç†æ–‡æœ¬å˜åŒ–"""
        self.textChanged.emit()
        
    def on_scroll(self):
        """å¤„ç†æ»šåŠ¨äº‹ä»¶"""
        scrollbar = self.editor.verticalScrollBar()
        if scrollbar.maximum() > 0:
            percentage = scrollbar.value() / scrollbar.maximum()
            self.scrollChanged.emit(percentage)
            
    def get_text(self):
        """è·å–ç¼–è¾‘å™¨æ–‡æœ¬"""
        return self.editor.toPlainText()
    
    def set_text(self, text):
        """è®¾ç½®ç¼–è¾‘å™¨æ–‡æœ¬"""
        self.editor.setPlainText(text)
        
    def clear(self):
        """æ¸…ç©ºç¼–è¾‘å™¨"""
        self.editor.clear()
        
    def setFocus(self):
        """è®¾ç½®ç„¦ç‚¹åˆ°ç¼–è¾‘å™¨"""
        self.editor.setFocus()
        
    def insertPlainText(self, text):
        """åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬"""
        self.editor.insertPlainText(text)
        
    def selectAll(self):
        """å…¨é€‰æ–‡æœ¬"""
        self.editor.selectAll()
        
    def copy(self):
        """å¤åˆ¶é€‰ä¸­æ–‡æœ¬"""
        self.editor.copy()
        
    def cut(self):
        """å‰ªåˆ‡é€‰ä¸­æ–‡æœ¬"""
        self.editor.cut()
        
    def paste(self):
        """ç²˜è´´æ–‡æœ¬"""
        self.editor.paste()
        
    def undo(self):
        """æ’¤é”€"""
        self.editor.undo()
        
    def redo(self):
        """é‡åš"""
        self.editor.redo()
        
    def setReadOnly(self, readonly):
        """è®¾ç½®åªè¯»æ¨¡å¼"""
        self.editor.setReadOnly(readonly)
        
    def zoomIn(self):
        """æ”¾å¤§å­—ä½“"""
        self.editor.zoomIn(1)
        
    def zoomOut(self):
        """ç¼©å°å­—ä½“"""
        self.editor.zoomOut(1)
        
    def resetZoom(self):
        """é‡ç½®å­—ä½“å¤§å°"""
        font = QFont("Cascadia Code, Consolas, Monaco, monospace", 13)
        self.editor.setFont(font) main_window.py->text/plain-># ============================================
# src/ui/main_window.py - å¢å¼ºç‰ˆå·¥å…·æ 
# ============================================
from PySide6.QtWidgets import (QMainWindow, QHBoxLayout, QVBoxLayout, 
                               QWidget, QToolBar, QSplitter, QPushButton,
                               QFileDialog, QMessageBox, QStatusBar, QLabel,
                               QGraphicsDropShadowEffect, QComboBox, QFrame,
                               QToolButton, QMenu, QDialog, QTextEdit,
                               QDialogButtonBox, QSpinBox, QGridLayout, QLineEdit)
from PySide6.QtCore import Qt, QTimer, QPropertyAnimation, QEasingCurve, QRect, QSize
from PySide6.QtGui import QAction, QIcon, QColor, QLinearGradient, QPainter, QBrush, QKeySequence, QTextCursor
from src.ui.editor_widget import EditorWidget
from src.ui.preview_widget import PreviewWidget
from src.utils.style_manager import StyleManager
import re

class AuroraBackground(QWidget):
    """æå…‰æ¸å˜èƒŒæ™¯ç»„ä»¶"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.gradient_offset = 0
        self.animation_timer = QTimer()
        self.animation_timer.timeout.connect(self.update_gradient)
        self.animation_timer.start(50)  # 20fpsåŠ¨ç”»
        
    def update_gradient(self):
        self.gradient_offset = (self.gradient_offset + 1) % 360
        self.update()
        
    def paintEvent(self, event):
        painter = QPainter(self)
        painter.setRenderHint(QPainter.Antialiasing)
        
        # åˆ›å»ºåŠ¨æ€æå…‰æ¸å˜
        gradient = QLinearGradient(0, 0, self.width(), self.height())
        
        # åŸºäºæ—¶é—´åç§»çš„åŠ¨æ€é¢œè‰²
        hue1 = (180 + self.gradient_offset) % 360
        hue2 = (280 + self.gradient_offset) % 360
        hue3 = (320 + self.gradient_offset) % 360
        
        color1 = QColor.fromHsv(hue1, 180, 60)
        color2 = QColor.fromHsv(hue2, 200, 80)
        color3 = QColor.fromHsv(hue3, 160, 70)
        
        gradient.setColorAt(0, color1)
        gradient.setColorAt(0.3, color2)
        gradient.setColorAt(0.6, QColor(25, 25, 60))
        gradient.setColorAt(1, color3)
        
        painter.fillRect(self.rect(), gradient)

class TableDialog(QDialog):
    """æ’å…¥è¡¨æ ¼å¯¹è¯æ¡†"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("ğŸ“Š æ’å…¥è¡¨æ ¼")
        self.setFixedSize(300, 150)
        self.init_ui()
        
    def init_ui(self):
        layout = QGridLayout(self)
        
        # è¡Œæ•°
        layout.addWidget(QLabel("è¡Œæ•°:"), 0, 0)
        self.rows_spin = QSpinBox()
        self.rows_spin.setRange(2, 20)
        self.rows_spin.setValue(3)
        layout.addWidget(self.rows_spin, 0, 1)
        
        # åˆ—æ•°
        layout.addWidget(QLabel("åˆ—æ•°:"), 1, 0)
        self.cols_spin = QSpinBox()
        self.cols_spin.setRange(2, 10)
        self.cols_spin.setValue(3)
        layout.addWidget(self.cols_spin, 1, 1)
        
        # æŒ‰é’®
        buttons = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        buttons.accepted.connect(self.accept)
        buttons.rejected.connect(self.reject)
        layout.addWidget(buttons, 2, 0, 1, 2)
        
        self.setStyleSheet("""
            QDialog {
                background: rgba(30, 30, 50, 0.95);
            }
            QLabel {
                color: white;
                font-size: 13px;
            }
            QSpinBox {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px;
                border-radius: 5px;
            }
            QPushButton {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 15px;
                border-radius: 5px;
            }
            QPushButton:hover {
                background: rgba(255, 255, 255, 0.15);
            }
        """)

class LinkDialog(QDialog):
    """æ’å…¥é“¾æ¥å¯¹è¯æ¡†"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("ğŸ”— æ’å…¥é“¾æ¥")
        self.setFixedSize(400, 180)
        self.init_ui()
        
    def init_ui(self):
        layout = QGridLayout(self)
        
        # é“¾æ¥æ–‡å­—
        layout.addWidget(QLabel("é“¾æ¥æ–‡å­—:"), 0, 0)
        self.text_edit = QLineEdit()
        self.text_edit.setPlaceholderText("è¾“å…¥æ˜¾ç¤ºçš„æ–‡å­—")
        layout.addWidget(self.text_edit, 0, 1)
        
        # é“¾æ¥åœ°å€
        layout.addWidget(QLabel("é“¾æ¥åœ°å€:"), 1, 0)
        self.url_edit = QLineEdit()
        self.url_edit.setPlaceholderText("https://example.com")
        layout.addWidget(self.url_edit, 1, 1)
        
        # æŒ‰é’®
        buttons = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        buttons.accepted.connect(self.accept)
        buttons.rejected.connect(self.reject)
        layout.addWidget(buttons, 2, 0, 1, 2)
        
        self.setStyleSheet("""
            QDialog {
                background: rgba(30, 30, 50, 0.95);
            }
            QLabel {
                color: white;
                font-size: 13px;
            }
            QLineEdit {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px;
                border-radius: 5px;
            }
            QPushButton {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 15px;
                border-radius: 5px;
            }
            QPushButton:hover {
                background: rgba(255, 255, 255, 0.15);
            }
        """)

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # å…ˆåˆ›å»ºè‡ªåŠ¨æ›´æ–°è®¡æ—¶å™¨
        self.update_timer = QTimer()
        self.update_timer.timeout.connect(self.update_preview)
        self.update_timer.setInterval(300)  # 300mså»¶è¿Ÿ
        
        # åˆå§‹åŒ–æ ·å¼ç®¡ç†å™¨
        self.style_manager = StyleManager()
        
        # ç„¶ååˆå§‹åŒ–UI
        self.init_ui()
        self.setup_connections()
        
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        self.setWindowTitle("âœ¨ å°çº¢ä¹¦ Markdown ç¼–è¾‘å™¨")
        self.setGeometry(100, 100, 1700, 950)
        self.setMinimumSize(1200, 700)
        
        # åˆ›å»ºä¸»å®¹å™¨
        main_container = QWidget()
        self.setCentralWidget(main_container)
        
        # åˆ›å»ºæå…‰èƒŒæ™¯
        self.aurora_bg = AuroraBackground(main_container)
        
        # ä¸»å¸ƒå±€
        main_layout = QVBoxLayout(main_container)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)
        
        # åº”ç”¨å…¨å±€æ ·å¼
        self.setStyleSheet(self.get_global_styles_qt_compatible())
        
        # åˆ›å»ºç¼–è¾‘å™¨å’Œé¢„è§ˆç»„ä»¶
        self.editor = EditorWidget()
        self.preview = PreviewWidget()
        
        # åˆ›å»ºå¢å¼ºç‰ˆå·¥å…·æ 
        toolbar_container = self.create_enhanced_toolbar()
        main_layout.addWidget(toolbar_container)
        
        # åˆ›å»ºå†…å®¹åŒºåŸŸ
        content_area = QWidget()
        content_area.setObjectName("contentArea")
        content_layout = QHBoxLayout(content_area)
        content_layout.setContentsMargins(20, 20, 20, 20)
        content_layout.setSpacing(20)
        
        # åˆ›å»ºåˆ†å‰²å™¨
        splitter = QSplitter(Qt.Horizontal)
        splitter.setObjectName("mainSplitter")
        
        # ä¸ºç»„ä»¶æ·»åŠ ç»ç’ƒå®¹å™¨
        editor_container = self.create_glass_container(self.editor, "ğŸ“ Markdown ç¼–è¾‘å™¨")
        preview_container = self.create_glass_container(self.preview, "ğŸ‘€ å®æ—¶é¢„è§ˆ")
        
        # æ·»åŠ åˆ°åˆ†å‰²å™¨
        splitter.addWidget(editor_container)
        splitter.addWidget(preview_container)
        splitter.setSizes([850, 850])
        
        content_layout.addWidget(splitter)
        main_layout.addWidget(content_area, 1)
        
        # åˆ›å»ºåº•éƒ¨çŠ¶æ€æ 
        self.create_status_bar()
        
        # åˆå§‹æ›´æ–°
        self.update_preview()
        self.update_char_count()
        
        # ç¡®ä¿èƒŒæ™¯åœ¨æœ€åº•å±‚
        self.aurora_bg.lower()
        
    def create_enhanced_toolbar(self):
        """åˆ›å»ºå¢å¼ºç‰ˆå•è¡Œå·¥å…·æ """
        toolbar_container = QFrame()
        toolbar_container.setObjectName("toolbarContainer")
        toolbar_container.setFixedHeight(55)
        
        main_layout = QHBoxLayout(toolbar_container)
        main_layout.setContentsMargins(15, 8, 15, 8)
        main_layout.setSpacing(15)
        
        # å·¦ä¾§ï¼šåŸºç¡€æ ¼å¼åŒ–æŒ‰é’®ç»„
        format_group = QFrame()
        format_group.setObjectName("buttonGroup")
        format_layout = QHBoxLayout(format_group)
        format_layout.setContentsMargins(8, 3, 8, 3)
        format_layout.setSpacing(5)
        
        # åŸºç¡€æ ¼å¼åŒ–æŒ‰é’®
        basic_buttons = [
            ("B", "åŠ ç²— (Ctrl+B)", self.insert_bold, True, False),
            ("I", "æ–œä½“ (Ctrl+I)", self.insert_italic, False, True),
            ("S", "åˆ é™¤çº¿", self.insert_strikethrough, False, False),
            ("`", "è¡Œå†…ä»£ç ", self.insert_inline_code, False, False),
            ("âŸ¨âŸ©", "ä»£ç å—", self.insert_code_block, False, False),
        ]
        
        for text, tooltip, callback, is_bold, is_italic in basic_buttons:
            btn = QToolButton()
            btn.setText(text)
            btn.setToolTip(tooltip)
            btn.clicked.connect(callback)
            btn.setFixedSize(35, 35)
            
            # è®¾ç½®å­—ä½“æ ·å¼
            font = btn.font()
            if is_bold:
                font.setBold(True)
            if is_italic:
                font.setItalic(True)
            btn.setFont(font)
            
            btn.setStyleSheet(self.get_tool_button_style())
            format_layout.addWidget(btn)
        
        main_layout.addWidget(format_group)
        
        # æ·»åŠ åˆ†éš”çº¿
        separator1 = self.create_separator()
        main_layout.addWidget(separator1)
        
        # ä¸­é—´å·¦ï¼šæ ‡é¢˜é€‰æ‹©å™¨
        heading_group = QFrame()
        heading_layout = QHBoxLayout(heading_group)
        heading_layout.setContentsMargins(0, 0, 0, 0)
        heading_layout.setSpacing(8)
        
        heading_label = QLabel("æ ‡é¢˜:")
        heading_label.setStyleSheet("color: rgba(255, 255, 255, 0.7); font-size: 12px;")
        heading_layout.addWidget(heading_label)
        
        self.heading_selector = QComboBox()
        self.heading_selector.setFixedWidth(100)
        self.heading_selector.addItems([
            "æ­£æ–‡",
            "H1 ä¸€çº§æ ‡é¢˜",
            "H2 äºŒçº§æ ‡é¢˜", 
            "H3 ä¸‰çº§æ ‡é¢˜",
            "H4 å››çº§æ ‡é¢˜",
            "H5 äº”çº§æ ‡é¢˜",
            "H6 å…­çº§æ ‡é¢˜"
        ])
        self.heading_selector.setCurrentIndex(0)
        self.heading_selector.setStyleSheet(self.get_mini_combobox_style())
        heading_layout.addWidget(self.heading_selector)
        
        main_layout.addWidget(heading_group)
        
        # ä¸­é—´å³ï¼šåˆ—è¡¨å’Œé“¾æ¥æŒ‰é’®ç»„
        list_group = QFrame()
        list_group.setObjectName("buttonGroup")
        list_layout = QHBoxLayout(list_group)
        list_layout.setContentsMargins(8, 3, 8, 3)
        list_layout.setSpacing(5)
        
        # åˆ—è¡¨å’Œé“¾æ¥æŒ‰é’®
        list_buttons = [
            ("â—‰", "æ— åºåˆ—è¡¨", self.insert_unordered_list),
            ("â‘ ", "æœ‰åºåˆ—è¡¨", self.insert_ordered_list),
            ("ğŸ”—", "æ’å…¥é“¾æ¥", self.insert_link),
            ("ğŸ–¼", "æ’å…¥å›¾ç‰‡", self.insert_image),
            ("ğŸ“Š", "æ’å…¥è¡¨æ ¼", self.insert_table),
            (">", "å¼•ç”¨", self.insert_quote),
            ("â€”", "åˆ†éš”çº¿", self.insert_divider),
        ]
        
        for text, tooltip, callback in list_buttons:
            btn = QToolButton()
            btn.setText(text)
            btn.setToolTip(tooltip)
            btn.clicked.connect(callback)
            btn.setFixedSize(35, 35)
            btn.setStyleSheet(self.get_tool_button_style())
            list_layout.addWidget(btn)
        
        main_layout.addWidget(list_group)
        
        # æ·»åŠ åˆ†éš”çº¿
        separator2 = self.create_separator()
        main_layout.addWidget(separator2)
        
        # æ“ä½œæŒ‰é’®ç»„
        action_group = QFrame()
        action_group.setObjectName("buttonGroup")
        action_layout = QHBoxLayout(action_group)
        action_layout.setContentsMargins(8, 3, 8, 3)
        action_layout.setSpacing(8)
        
        # æ’¤é”€/é‡åš
        undo_btn = QPushButton("â†¶")
        undo_btn.setToolTip("æ’¤é”€ (Ctrl+Z)")
        undo_btn.clicked.connect(self.editor.undo)
        undo_btn.setFixedSize(35, 35)
        undo_btn.setStyleSheet(self.get_action_button_style())
        action_layout.addWidget(undo_btn)

        redo_btn = QPushButton("â†·")
        redo_btn.setToolTip("é‡åš (Ctrl+Y)")
        redo_btn.clicked.connect(self.editor.redo)
        redo_btn.setFixedSize(35, 35)
        redo_btn.setStyleSheet(self.get_action_button_style())
        action_layout.addWidget(redo_btn)

        # æ¸…ç©º
        clear_btn = QPushButton("ğŸ—‘")
        clear_btn.setToolTip("æ¸…ç©ºæ‰€æœ‰å†…å®¹")
        clear_btn.clicked.connect(self.clear_content)
        clear_btn.setFixedSize(35, 35)
        clear_btn.setStyleSheet(self.get_action_button_style())
        action_layout.addWidget(clear_btn)
        
        main_layout.addWidget(action_group)
        
        # æ·»åŠ å¼¹æ€§ç©ºé—´
        main_layout.addStretch()
        
        # å³ä¾§ï¼šä¸»é¢˜é€‰æ‹©å’Œå¯¼å‡º
        right_group = QFrame()
        right_layout = QHBoxLayout(right_group)
        right_layout.setContentsMargins(0, 0, 0, 0)
        right_layout.setSpacing(15)
        
        # ä¸»é¢˜é€‰æ‹©å™¨
        theme_label = QLabel("ä¸»é¢˜:")
        theme_label.setStyleSheet("color: rgba(255, 255, 255, 0.8); font-size: 13px;")
        right_layout.addWidget(theme_label)
        
        self.theme_selector = QComboBox()
        self.theme_selector.setFixedWidth(130)
        themes = self.style_manager.get_theme_display_names()
        for key, name in themes.items():
            self.theme_selector.addItem(name, key)
        self.theme_selector.setCurrentText("å°çº¢ä¹¦ç»å…¸")
        self.theme_selector.setStyleSheet(self.get_combobox_style())
        right_layout.addWidget(self.theme_selector)
        
        # å¯¼å‡ºæŒ‰é’®
        self.export_btn = QPushButton("ğŸ“¸ å¯¼å‡ºå›¾ç‰‡")
        self.export_btn.clicked.connect(self.export_images)
        self.export_btn.setStyleSheet(self.get_export_button_style())
        right_layout.addWidget(self.export_btn)
        
        main_layout.addWidget(right_group)
        
        # è¿æ¥æ ‡é¢˜é€‰æ‹©å™¨ä¿¡å·
        self.heading_selector.currentIndexChanged.connect(self.on_heading_changed)
        
        return toolbar_container
    
    def create_separator(self):
        """åˆ›å»ºåˆ†éš”çº¿"""
        separator = QFrame()
        separator.setFrameStyle(QFrame.VLine | QFrame.Sunken)
        separator.setStyleSheet("background: rgba(255, 255, 255, 0.1);")
        separator.setFixedWidth(1)
        return separator
    
    def get_tool_button_style(self):
        """å·¥å…·æŒ‰é’®æ ·å¼"""
        return """
            QToolButton {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                padding: 2px;
            }
            QToolButton:hover {
                background: rgba(0, 255, 136, 0.15);
                border-color: rgba(0, 255, 136, 0.4);
                color: #00ff88;
            }
            QToolButton:pressed {
                background: rgba(0, 255, 136, 0.25);
            }
        """
    
    def get_action_button_style(self):
        """æ“ä½œæŒ‰é’®æ ·å¼ï¼ˆæ›´å°çš„å°ºå¯¸ï¼‰"""
        return """
            QPushButton {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
            }
            QPushButton:hover {
                background: rgba(255, 255, 255, 0.12);
                border-color: rgba(255, 255, 255, 0.3);
            }
            QPushButton:pressed {
                background: rgba(255, 255, 255, 0.18);
            }
        """
    
    def get_mini_combobox_style(self):
        """è¿·ä½ ä¸‹æ‹‰æ¡†æ ·å¼"""
        return """
            QComboBox {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 8px;
                border-radius: 6px;
                font-size: 12px;
            }
            QComboBox:hover {
                background: rgba(255, 255, 255, 0.12);
            }
            QComboBox::drop-down {
                border: none;
                width: 16px;
            }
            QComboBox::down-arrow {
                image: none;
                border-style: solid;
                border-width: 3px 3px 0 3px;
                border-color: white transparent transparent transparent;
            }
            QComboBox QAbstractItemView {
                background: rgba(30, 30, 50, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                selection-background-color: rgba(0, 255, 136, 0.3);
                padding: 5px;
            }
        """
    
    def get_export_button_style(self):
        """å¯¼å‡ºæŒ‰é’®æ ·å¼"""
        return """
            QPushButton {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 136, 0.3),
                    stop: 1 rgba(0, 255, 200, 0.3));
                border: 2px solid #00ff88;
                color: #00ff88;
                padding: 8px 20px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 136, 0.4),
                    stop: 1 rgba(0, 255, 200, 0.4));
            }
            QPushButton:pressed {
                background: rgba(0, 255, 136, 0.5);
            }
        """
    
    def get_combobox_style(self):
        """ä¸‹æ‹‰æ¡†æ ·å¼"""
        return """
            QComboBox {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 10px;
                border-radius: 8px;
                font-size: 13px;
            }
            QComboBox:hover {
                background: rgba(255, 255, 255, 0.12);
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border-style: solid;
                border-width: 4px 4px 0 4px;
                border-color: white transparent transparent transparent;
            }
            QComboBox QAbstractItemView {
                background: rgba(30, 30, 50, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                selection-background-color: rgba(0, 255, 136, 0.3);
                padding: 5px;
            }
        """
    
    # ===== ç¼–è¾‘å™¨æ“ä½œæ–¹æ³• =====
    
    def on_heading_changed(self, index):
        """å¤„ç†æ ‡é¢˜é€‰æ‹©æ”¹å˜"""
        cursor = self.editor.editor.textCursor()
        cursor.movePosition(QTextCursor.StartOfLine)
        
        # è·å–å½“å‰è¡Œæ–‡æœ¬
        cursor.movePosition(QTextCursor.EndOfLine, QTextCursor.KeepAnchor)
        line_text = cursor.selectedText()
        
        # ç§»é™¤å·²æœ‰çš„æ ‡é¢˜æ ‡è®°
        cleaned_text = line_text.lstrip('#').lstrip()
        
        # æ ¹æ®é€‰æ‹©æ·»åŠ æ–°çš„æ ‡é¢˜æ ‡è®°
        if index == 0:  # æ­£æ–‡
            cursor.insertText(cleaned_text)
        else:  # H1-H6
            heading_level = '#' * index
            cursor.insertText(f"{heading_level} {cleaned_text}")
    
    def insert_bold(self):
        """æ’å…¥ç²—ä½“æ ‡è®°"""
        cursor = self.editor.editor.textCursor()
        if cursor.hasSelection():
            text = cursor.selectedText()
            cursor.insertText(f"**{text}**")
        else:
            cursor.insertText("****")
            cursor.movePosition(QTextCursor.Left, QTextCursor.MoveAnchor, 2)
            self.editor.editor.setTextCursor(cursor)
    
    def insert_italic(self):
        """æ’å…¥æ–œä½“æ ‡è®°"""
        cursor = self.editor.editor.textCursor()
        if cursor.hasSelection():
            text = cursor.selectedText()
            cursor.insertText(f"*{text}*")
        else:
            cursor.insertText("**")
            cursor.movePosition(QTextCursor.Left, QTextCursor.MoveAnchor, 1)
            self.editor.editor.setTextCursor(cursor)
    
    def insert_strikethrough(self):
        """æ’å…¥åˆ é™¤çº¿æ ‡è®°"""
        cursor = self.editor.editor.textCursor()
        if cursor.hasSelection():
            text = cursor.selectedText()
            cursor.insertText(f"~~{text}~~")
        else:
            cursor.insertText("~~~~")
            cursor.movePosition(QTextCursor.Left, QTextCursor.MoveAnchor, 2)
            self.editor.editor.setTextCursor(cursor)
    
    def insert_inline_code(self):
        """æ’å…¥è¡Œå†…ä»£ç æ ‡è®°"""
        cursor = self.editor.editor.textCursor()
        if cursor.hasSelection():
            text = cursor.selectedText()
            cursor.insertText(f"`{text}`")
        else:
            cursor.insertText("``")
            cursor.movePosition(QTextCursor.Left, QTextCursor.MoveAnchor, 1)
            self.editor.editor.setTextCursor(cursor)
    
    def insert_code_block(self):
        """æ’å…¥ä»£ç å—"""
        cursor = self.editor.editor.textCursor()
        if cursor.hasSelection():
            text = cursor.selectedText()
            cursor.insertText(f"```\n{text}\n```")
        else:
            cursor.insertText("```python\n\n```")
            cursor.movePosition(QTextCursor.Up, QTextCursor.MoveAnchor, 1)
            self.editor.editor.setTextCursor(cursor)
    
    def insert_unordered_list(self):
        """æ’å…¥æ— åºåˆ—è¡¨ - æ”¯æŒå¤šè¡Œè½¬æ¢"""
        cursor = self.editor.editor.textCursor()
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­æ–‡æœ¬
        if cursor.hasSelection():
            # è·å–é€‰ä¸­çš„æ–‡æœ¬
            selected_text = cursor.selectedText()
            
            # å°†æ®µè½åˆ†éš”ç¬¦è½¬æ¢ä¸ºæ¢è¡Œç¬¦ï¼ˆQtä½¿ç”¨ç‰¹æ®Šå­—ç¬¦è¡¨ç¤ºæ®µè½ï¼‰
            lines = selected_text.replace('\u2029', '\n').split('\n')
            
            # è½¬æ¢æ¯ä¸€è¡Œä¸ºåˆ—è¡¨é¡¹
            list_lines = []
            for line in lines:
                line = line.strip()
                if line:  # å¿½ç•¥ç©ºè¡Œ
                    # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯åˆ—è¡¨é¡¹
                    if line.startswith('- '):
                        list_lines.append(line)  # å·²ç»æ˜¯æ— åºåˆ—è¡¨
                    elif line.startswith('* ') or line.startswith('+ '):
                        # å…¶ä»–æ— åºåˆ—è¡¨æ ‡è®°ï¼Œç»Ÿä¸€ä¸º -
                        list_lines.append('- ' + line[2:])
                    elif re.match(r'^\d+\.\s', line):
                        # æœ‰åºåˆ—è¡¨ï¼Œè½¬æ¢ä¸ºæ— åº
                        list_lines.append('- ' + re.sub(r'^\d+\.\s+', '', line))
                    elif line.startswith('- [ ] ') or line.startswith('- [x] '):
                        # ä»»åŠ¡åˆ—è¡¨ï¼Œä¿ç•™å†…å®¹ä½†æ”¹ä¸ºæ™®é€šæ— åºåˆ—è¡¨
                        content = line[6:] if line.startswith('- [ ] ') else line[6:]
                        list_lines.append('- ' + content)
                    else:
                        # æ™®é€šæ–‡æœ¬ï¼Œæ·»åŠ åˆ—è¡¨æ ‡è®°
                        list_lines.append('- ' + line)
            
            # æ›¿æ¢é€‰ä¸­çš„æ–‡æœ¬
            if list_lines:
                cursor.insertText('\n'.join(list_lines))
        else:
            # æ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåªåœ¨å½“å‰è¡Œæ·»åŠ åˆ—è¡¨æ ‡è®°
            cursor.movePosition(QTextCursor.StartOfLine)
            
            # è·å–å½“å‰è¡Œæ–‡æœ¬
            cursor.movePosition(QTextCursor.EndOfLine, QTextCursor.KeepAnchor)
            line_text = cursor.selectedText().strip()
            
            # æ£€æŸ¥å¹¶è½¬æ¢å½“å‰è¡Œ
            if line_text:
                if not line_text.startswith('- '):
                    # ç§»é™¤å…¶ä»–åˆ—è¡¨æ ‡è®°
                    if line_text.startswith('* ') or line_text.startswith('+ '):
                        cursor.insertText('- ' + line_text[2:])
                    elif re.match(r'^\d+\.\s', line_text):
                        cursor.insertText('- ' + re.sub(r'^\d+\.\s+', '', line_text))
                    elif line_text.startswith('- [ ] ') or line_text.startswith('- [x] '):
                        content = line_text[6:]
                        cursor.insertText('- ' + content)
                    else:
                        cursor.insertText('- ' + line_text)
                else:
                    # å·²ç»æ˜¯æ— åºåˆ—è¡¨ï¼Œä¿æŒä¸å˜
                    cursor.insertText(line_text)
            else:
                # ç©ºè¡Œï¼Œç›´æ¥æ·»åŠ åˆ—è¡¨æ ‡è®°
                cursor.insertText('- ')
    
    def insert_ordered_list(self):
        """æ’å…¥æœ‰åºåˆ—è¡¨ - æ”¯æŒå¤šè¡Œè½¬æ¢"""
        cursor = self.editor.editor.textCursor()
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­æ–‡æœ¬
        if cursor.hasSelection():
            # è·å–é€‰ä¸­çš„æ–‡æœ¬
            selected_text = cursor.selectedText()
            
            # å°†æ®µè½åˆ†éš”ç¬¦è½¬æ¢ä¸ºæ¢è¡Œç¬¦
            lines = selected_text.replace('\u2029', '\n').split('\n')
            
            # è½¬æ¢æ¯ä¸€è¡Œä¸ºåˆ—è¡¨é¡¹
            list_lines = []
            list_number = 1
            for line in lines:
                line = line.strip()
                if line:  # å¿½ç•¥ç©ºè¡Œ
                    # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯åˆ—è¡¨é¡¹
                    if re.match(r'^\d+\.\s', line):
                        # å·²ç»æ˜¯æœ‰åºåˆ—è¡¨ï¼Œé‡æ–°ç¼–å·
                        content = re.sub(r'^\d+\.\s+', '', line)
                        list_lines.append(f"{list_number}. {content}")
                        list_number += 1
                    elif line.startswith('- ') or line.startswith('* ') or line.startswith('+ '):
                        # æ— åºåˆ—è¡¨ï¼Œè½¬æ¢ä¸ºæœ‰åº
                        list_lines.append(f"{list_number}. {line[2:]}")
                        list_number += 1
                    elif line.startswith('- [ ] ') or line.startswith('- [x] '):
                        # ä»»åŠ¡åˆ—è¡¨ï¼Œè½¬æ¢ä¸ºæœ‰åºåˆ—è¡¨
                        content = line[6:]
                        list_lines.append(f"{list_number}. {content}")
                        list_number += 1
                    else:
                        # æ™®é€šæ–‡æœ¬ï¼Œæ·»åŠ åˆ—è¡¨ç¼–å·
                        list_lines.append(f"{list_number}. {line}")
                        list_number += 1
            
            # æ›¿æ¢é€‰ä¸­çš„æ–‡æœ¬
            if list_lines:
                cursor.insertText('\n'.join(list_lines))
        else:
            # æ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåªåœ¨å½“å‰è¡Œæ·»åŠ åˆ—è¡¨æ ‡è®°
            cursor.movePosition(QTextCursor.StartOfLine)
            
            # è·å–å½“å‰è¡Œæ–‡æœ¬
            cursor.movePosition(QTextCursor.EndOfLine, QTextCursor.KeepAnchor)
            line_text = cursor.selectedText().strip()
            
            # æ£€æŸ¥å¹¶è½¬æ¢å½“å‰è¡Œ
            if line_text:
                if not re.match(r'^\d+\.\s', line_text):
                    # ç§»é™¤å…¶ä»–åˆ—è¡¨æ ‡è®°
                    if line_text.startswith('- ') or line_text.startswith('* ') or line_text.startswith('+ '):
                        cursor.insertText('1. ' + line_text[2:])
                    elif line_text.startswith('- [ ] ') or line_text.startswith('- [x] '):
                        content = line_text[6:]
                        cursor.insertText('1. ' + content)
                    else:
                        cursor.insertText('1. ' + line_text)
                else:
                    # å·²ç»æ˜¯æœ‰åºåˆ—è¡¨ï¼Œä¿æŒä¸å˜
                    cursor.insertText(line_text)
            else:
                # ç©ºè¡Œï¼Œç›´æ¥æ·»åŠ åˆ—è¡¨æ ‡è®°
                cursor.insertText('1. ')
    
    def insert_task_list(self):
        """æ’å…¥ä»»åŠ¡åˆ—è¡¨ - æ”¯æŒå¤šè¡Œè½¬æ¢"""
        cursor = self.editor.editor.textCursor()
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­æ–‡æœ¬
        if cursor.hasSelection():
            # è·å–é€‰ä¸­çš„æ–‡æœ¬
            selected_text = cursor.selectedText()
            
            # å°†æ®µè½åˆ†éš”ç¬¦è½¬æ¢ä¸ºæ¢è¡Œç¬¦
            lines = selected_text.replace('\u2029', '\n').split('\n')
            
            # è½¬æ¢æ¯ä¸€è¡Œä¸ºä»»åŠ¡åˆ—è¡¨é¡¹
            list_lines = []
            for line in lines:
                line = line.strip()
                if line:  # å¿½ç•¥ç©ºè¡Œ
                    # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ä»»åŠ¡åˆ—è¡¨
                    if line.startswith('- [ ] ') or line.startswith('- [x] ') or line.startswith('- [X] '):
                        list_lines.append(line)  # å·²ç»æ˜¯ä»»åŠ¡åˆ—è¡¨ï¼Œä¿æŒä¸å˜
                    elif line.startswith('- ') or line.startswith('* ') or line.startswith('+ '):
                        # æ™®é€šæ— åºåˆ—è¡¨ï¼Œè½¬æ¢ä¸ºä»»åŠ¡åˆ—è¡¨
                        list_lines.append('- [ ] ' + line[2:])
                    elif re.match(r'^\d+\.\s', line):
                        # æœ‰åºåˆ—è¡¨ï¼Œè½¬æ¢ä¸ºä»»åŠ¡åˆ—è¡¨
                        content = re.sub(r'^\d+\.\s+', '', line)
                        list_lines.append('- [ ] ' + content)
                    else:
                        # æ™®é€šæ–‡æœ¬ï¼Œæ·»åŠ ä»»åŠ¡åˆ—è¡¨æ ‡è®°
                        list_lines.append('- [ ] ' + line)
            
            # æ›¿æ¢é€‰ä¸­çš„æ–‡æœ¬
            if list_lines:
                cursor.insertText('\n'.join(list_lines))
        else:
            # æ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåªåœ¨å½“å‰è¡Œæ·»åŠ ä»»åŠ¡åˆ—è¡¨æ ‡è®°
            cursor.movePosition(QTextCursor.StartOfLine)
            
            # è·å–å½“å‰è¡Œæ–‡æœ¬
            cursor.movePosition(QTextCursor.EndOfLine, QTextCursor.KeepAnchor)
            line_text = cursor.selectedText().strip()
            
            # æ£€æŸ¥å¹¶è½¬æ¢å½“å‰è¡Œ
            if line_text:
                if not (line_text.startswith('- [ ] ') or line_text.startswith('- [x] ')):
                    # ç§»é™¤å…¶ä»–åˆ—è¡¨æ ‡è®°
                    if line_text.startswith('- ') or line_text.startswith('* ') or line_text.startswith('+ '):
                        cursor.insertText('- [ ] ' + line_text[2:])
                    elif re.match(r'^\d+\.\s', line_text):
                        content = re.sub(r'^\d+\.\s+', '', line_text)
                        cursor.insertText('- [ ] ' + content)
                    else:
                        cursor.insertText('- [ ] ' + line_text)
                else:
                    # å·²ç»æ˜¯ä»»åŠ¡åˆ—è¡¨ï¼Œåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                    if line_text.startswith('- [ ] '):
                        cursor.insertText('- [x] ' + line_text[6:])
                    else:
                        cursor.insertText('- [ ] ' + line_text[6:])
            else:
                # ç©ºè¡Œï¼Œç›´æ¥æ·»åŠ ä»»åŠ¡åˆ—è¡¨æ ‡è®°
                cursor.insertText('- [ ] ')
    
    def insert_quote(self):
        """æ’å…¥å¼•ç”¨"""
        cursor = self.editor.editor.textCursor()
        cursor.movePosition(QTextCursor.StartOfLine)
        cursor.insertText("> ")
    
    def insert_divider(self):
        """æ’å…¥åˆ†éš”çº¿"""
        self.editor.insertPlainText("\n---\n")
    
    def insert_link(self):
        """æ’å…¥é“¾æ¥ï¼ˆå¸¦å¯¹è¯æ¡†ï¼‰"""
        dialog = LinkDialog(self)
        if dialog.exec():
            text = dialog.text_edit.text() or "é“¾æ¥æ–‡å­—"
            url = dialog.url_edit.text() or "https://example.com"
            self.editor.insertPlainText(f"[{text}]({url})")
    
    def insert_image(self):
        """æ’å…¥å›¾ç‰‡"""
        # å¼¹å‡ºæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "é€‰æ‹©å›¾ç‰‡",
            "",
            "Images (*.png *.jpg *.jpeg *.gif *.bmp *.svg);;All Files (*)"
        )
        
        if file_path:
            # è·å–æ–‡ä»¶åä½œä¸ºæ›¿ä»£æ–‡æœ¬
            import os
            file_name = os.path.basename(file_path)
            
            # æ’å…¥å›¾ç‰‡è¯­æ³•
            cursor = self.editor.editor.textCursor()
            cursor.insertText(f"![{file_name}]({file_path})")
            
            # æç¤ºç”¨æˆ·
            self.status_bar.showMessage(f"å·²æ’å…¥å›¾ç‰‡: {file_name}", 3000)
    
    def insert_table(self):
        """æ’å…¥è¡¨æ ¼"""
        dialog = TableDialog(self)
        if dialog.exec():
            rows = dialog.rows_spin.value()
            cols = dialog.cols_spin.value()
            
            # ç”Ÿæˆè¡¨æ ¼
            table = []
            
            # è¡¨å¤´
            header = "|"
            for i in range(cols):
                header += f" åˆ—{i+1} |"
            table.append(header)
            
            # åˆ†éš”çº¿
            separator = "|"
            for _ in range(cols):
                separator += " --- |"
            table.append(separator)
            
            # æ•°æ®è¡Œ
            for r in range(rows - 1):
                row = "|"
                for c in range(cols):
                    row += f" æ•°æ® |"
                table.append(row)
            
            # æ’å…¥è¡¨æ ¼
            self.editor.insertPlainText("\n" + "\n".join(table) + "\n")
    
    # ===== å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ =====
    
    def create_glass_container(self, widget, title):
        """åˆ›å»ºæ¯›ç»ç’ƒå®¹å™¨"""
        container = QFrame()
        container.setObjectName("glassContainer")
        
        layout = QVBoxLayout(container)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # æ ‡é¢˜æ 
        title_bar = QFrame()
        title_bar.setObjectName("glassTitleBar")
        title_bar.setFixedHeight(45)
        
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(20, 0, 20, 0)
        
        title_label = QLabel(title)
        title_label.setObjectName("glassTitle")
        title_layout.addWidget(title_label)
        title_layout.addStretch()
        
        # æ·»åŠ ç»„ä»¶
        layout.addWidget(title_bar)
        layout.addWidget(widget, 1)
        
        # æ·»åŠ å‘å…‰æ•ˆæœ
        glow = QGraphicsDropShadowEffect()
        glow.setBlurRadius(30)
        glow.setOffset(0, 0)
        glow.setColor(QColor(0, 224, 255, 80))
        widget.setGraphicsEffect(glow)
        
        return container
    
    def create_status_bar(self):
        """åˆ›å»ºæ¯›ç»ç’ƒçŠ¶æ€æ """
        self.status_bar = QStatusBar()
        self.status_bar.setObjectName("glassStatusBar")
        self.status_bar.setFixedHeight(40)
        self.setStatusBar(self.status_bar)
        
        # å­—æ•°ç»Ÿè®¡
        self.char_count_label = QLabel("Words: 0")
        self.char_count_label.setObjectName("statusLabel")
        
        # ä¸»é¢˜ä¿¡æ¯
        self.theme_info_label = QLabel("Theme: å°çº¢ä¹¦ç»å…¸")
        self.theme_info_label.setObjectName("statusLabel")
        
        self.status_bar.addPermanentWidget(self.theme_info_label)
        self.status_bar.addPermanentWidget(self.char_count_label)
    
    def get_global_styles_qt_compatible(self):
        """è·å–Qtå…¼å®¹çš„å…¨å±€æ ·å¼è¡¨"""
        return """
        /* å…¨å±€å­—ä½“ */
        * {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        #contentArea {
            background: transparent;
        }
        
        /* æ¯›ç»ç’ƒå®¹å™¨ */
        #glassContainer {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
        }
        
        #glassTitleBar {
            background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                stop: 0 rgba(255, 255, 255, 0.1),
                stop: 1 rgba(255, 255, 255, 0.05));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        
        #glassTitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        /* å·¥å…·æ å®¹å™¨ */
        #toolbarContainer {
            background: rgba(20, 20, 40, 0.95);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        #buttonGroup {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
        }
        
        /* åˆ†å‰²å™¨ */
        #mainSplitter::handle {
            background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                stop: 0 rgba(255, 255, 255, 0),
                stop: 0.5 rgba(255, 255, 255, 0.2),
                stop: 1 rgba(255, 255, 255, 0));
            width: 3px;
        }
        
        #mainSplitter::handle:hover {
            background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                stop: 0 rgba(0, 255, 255, 0),
                stop: 0.5 rgba(0, 255, 255, 0.5),
                stop: 1 rgba(0, 255, 255, 0));
        }
        
        /* çŠ¶æ€æ  */
        #glassStatusBar {
            background: rgba(20, 20, 40, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }
        
        #statusLabel {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 0 5px;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        QScrollBar:vertical {
            background: rgba(255, 255, 255, 0.03);
            width: 12px;
            border-radius: 6px;
            margin: 2px;
        }
        
        QScrollBar::handle:vertical {
            background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                stop: 0 rgba(0, 255, 255, 0.3),
                stop: 1 rgba(255, 0, 255, 0.3));
            border-radius: 6px;
            min-height: 30px;
        }
        
        QScrollBar::handle:vertical:hover {
            background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                stop: 0 rgba(0, 255, 255, 0.5),
                stop: 1 rgba(255, 0, 255, 0.5));
        }
        
        QScrollBar::add-line:vertical,
        QScrollBar::sub-line:vertical {
            height: 0px;
        }
        
        /* å·¥å…·æç¤º */
        QToolTip {
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        """
    
    def resizeEvent(self, event):
        """çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´èƒŒæ™¯"""
        super().resizeEvent(event)
        if hasattr(self, 'aurora_bg'):
            self.aurora_bg.resize(self.size())
    
    def setup_connections(self):
        """è®¾ç½®ä¿¡å·è¿æ¥"""
        self.editor.textChanged.connect(self.on_text_changed)
        self.editor.scrollChanged.connect(self.preview.handle_scroll)
        self.preview.pageChanged.connect(self.on_page_changed)
        self.theme_selector.currentIndexChanged.connect(self.on_theme_changed)
        
        if hasattr(self.preview, 'sizeChanged'):
            self.preview.sizeChanged.connect(self.on_size_changed)
    
    def on_text_changed(self):
        """æ–‡æœ¬æ”¹å˜æ—¶å¯åŠ¨è®¡æ—¶å™¨"""
        self.update_timer.stop()
        self.update_timer.start()
        self.update_char_count()
    
    def update_preview(self):
        """æ›´æ–°é¢„è§ˆ"""
        self.update_timer.stop()
        markdown_text = self.editor.get_text()
        self.preview.update_content(markdown_text)
    
    def update_char_count(self):
        """æ›´æ–°å­—æ•°ç»Ÿè®¡"""
        text = self.editor.get_text()
        char_count = len(text.replace(" ", "").replace("\n", ""))
        word_count = len(text.split())
        self.char_count_label.setText(f"å­—ç¬¦: {char_count} | å•è¯: {word_count}")
    
    def on_page_changed(self, current, total):
        """é¡µç æ”¹å˜æ—¶æ›´æ–°çŠ¶æ€æ """
        if total > 1:
            self.status_bar.showMessage(f"ç¬¬ {current}/{total} é¡µ", 2000)
    
    def on_theme_changed(self, index):
        """å¤„ç†ä¸»é¢˜æ”¹å˜"""
        theme_key = self.theme_selector.currentData()
        if theme_key:
            self.preview.change_theme(theme_key)
            theme_name = self.theme_selector.currentText()
            self.theme_info_label.setText(f"ä¸»é¢˜: {theme_name}")
            self.status_bar.showMessage(f"å·²åˆ‡æ¢åˆ°: {theme_name}", 3000)
    
    def on_size_changed(self, size):
        """å¤„ç†å°ºå¯¸æ”¹å˜"""
        size_display = {
            "small": "å° (720Ã—960)",
            "medium": "ä¸­ (1080Ã—1440)",
            "large": "å¤§ (1440Ã—1920)"
        }
        display_name = size_display.get(size, size)
        self.status_bar.showMessage(f"å°ºå¯¸: {display_name}", 3000)
    
    def clear_content(self):
        """æ¸…ç©ºå†…å®¹"""
        reply = QMessageBox.question(
            self, "æ¸…ç©ºå†…å®¹",
            "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
            QMessageBox.Yes | QMessageBox.No,
            QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            self.editor.editor.clear()
            self.status_bar.showMessage("âœ… å†…å®¹å·²æ¸…ç©º", 2000)
    
    def export_images(self):
        """å¯¼å‡ºå›¾ç‰‡"""
        if not self.editor.get_text().strip():
            QMessageBox.warning(
                self, "æç¤º",
                "æ²¡æœ‰å†…å®¹å¯å¯¼å‡ºã€‚è¯·å…ˆè¾“å…¥ä¸€äº›æ–‡æœ¬ã€‚",
                QMessageBox.Ok
            )
            return
        
        folder = QFileDialog.getExistingDirectory(
            self, 
            "é€‰æ‹©å¯¼å‡ºæ–‡ä»¶å¤¹",
            "",
            QFileDialog.ShowDirsOnly | QFileDialog.DontResolveSymlinks
        )
        
        if folder:
            try:
                theme_name = self.theme_selector.currentText()
                self.status_bar.showMessage(f"æ­£åœ¨å¯¼å‡ºå›¾ç‰‡ (ä¸»é¢˜: {theme_name})...", 0)
                self.preview.export_pages(folder)
                
                QMessageBox.information(
                    self, "å¯¼å‡ºæˆåŠŸ",
                    f"å›¾ç‰‡å·²æˆåŠŸå¯¼å‡ºåˆ°:\n{folder}\n\nä¸»é¢˜: {theme_name}",
                    QMessageBox.Ok
                )
                
            except Exception as e:
                QMessageBox.critical(
                    self, "å¯¼å‡ºå¤±è´¥",
                    f"å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºé”™:\n{str(e)}",
                    QMessageBox.Ok
                )
                self.status_bar.showMessage("âŒ å¯¼å‡ºå¤±è´¥", 3000) preview_widget.py->text/plain-># ============================================
# src/ui/preview_widget.py - Qtå…¼å®¹ä¼˜åŒ–ç‰ˆ
# ============================================
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QLabel, QFrame, 
                               QPushButton, QHBoxLayout, QProgressDialog,
                               QMessageBox, QComboBox, QButtonGroup, QRadioButton,
                               QScrollArea)
from PySide6.QtWebEngineWidgets import QWebEngineView
from PySide6.QtCore import QUrl, QTimer, Signal, Qt, QSize, QEvent
from PySide6.QtGui import QWheelEvent, QFont
from pathlib import Path
from src.core.markdown_processor import MarkdownProcessor
from src.core.html_generator import HTMLGenerator
from src.utils.paginator import SmartPaginator
from src.utils.exporter import ImageExporter

class CustomScrollArea(QScrollArea):
    """è‡ªå®šä¹‰æ»šåŠ¨åŒºåŸŸï¼Œå¤„ç†æ»šè½®äº‹ä»¶"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.preview_widget = None  # å°†åœ¨PreviewWidgetä¸­è®¾ç½®
        
    def wheelEvent(self, event: QWheelEvent):
        """é‡å†™æ»šè½®äº‹ä»¶"""
        if self.preview_widget:
            # é€‚åº”çª—å£æ¨¡å¼ï¼šæ»šè½®ç¿»é¡µ
            if self.preview_widget.preview_mode == "fit":
                if event.angleDelta().y() > 0:
                    self.preview_widget.prev_page()
                else:
                    self.preview_widget.next_page()
                event.accept()
                return
            
            # å®é™…å¤§å°æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æŒ‰ä½Shiftè¿›è¡Œæ¨ªå‘æ»šåŠ¨
            elif self.preview_widget.preview_mode == "actual":
                # å¦‚æœæŒ‰ä½Shifté”®ï¼Œå®ç°æ¨ªå‘æ»šåŠ¨
                if event.modifiers() == Qt.ShiftModifier:
                    # è·å–æ»šåŠ¨è·ç¦»
                    delta = event.angleDelta().y()
                    # æ¨ªå‘æ»šåŠ¨
                    h_scrollbar = self.horizontalScrollBar()
                    h_scrollbar.setValue(h_scrollbar.value() - delta)
                    event.accept()
                    return
                else:
                    # æ­£å¸¸çš„å‚ç›´æ»šåŠ¨
                    super().wheelEvent(event)
                    return
        
        # é»˜è®¤å¤„ç†
        super().wheelEvent(event)

class PreviewWidget(QWidget):
    pageChanged = Signal(int, int)  # å½“å‰é¡µï¼Œæ€»é¡µæ•°
    sizeChanged = Signal(str)  # å°ºå¯¸æ”¹å˜ä¿¡å·
    
    def __init__(self):
        super().__init__()
        self.current_pages = []  # å­˜å‚¨åˆ†é¡µåçš„HTMLå†…å®¹
        self.current_page = 1
        self.total_pages = 1
        self.markdown_text = ""  # ä¿å­˜åŸå§‹markdownæ–‡æœ¬
        self.current_size = "medium"  # å½“å‰é¡µé¢å°ºå¯¸
        self.preview_mode = "fit"  # é¢„è§ˆæ¨¡å¼: fit(é€‚åº”çª—å£) æˆ– actual(å®é™…å¤§å°)
        
        # åˆå§‹åŒ–å¤„ç†å™¨
        self.markdown_processor = MarkdownProcessor()
        self.html_generator = HTMLGenerator(page_size="medium")
        self.paginator = SmartPaginator(page_size="medium")
        
        # åˆå§‹åŒ–UI
        self.init_ui()
        
        # è®¾ç½®å¯¼å‡ºå™¨
        self.setup_exporter()
        
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # åˆ›å»ºå®¹å™¨æ¡†æ¶ - ç§»é™¤é‡å¤çš„æ ‡é¢˜æ 
        container = QFrame()
        container.setStyleSheet("""
            QFrame {
                background: transparent;
                border: none;
            }
        """)
        container_layout = QVBoxLayout(container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(0)
        
        # åˆ›å»ºé¡¶éƒ¨æ§åˆ¶æ ï¼ˆåŒ…å«å°ºå¯¸å’Œæ¨¡å¼é€‰æ‹©ï¼‰
        top_control_bar = self.create_top_control_bar()
        
        # åˆ›å»ºWebViewå®¹å™¨
        self.create_web_view_container()
        
        # åˆ›å»ºåº•éƒ¨å¯¼èˆªæ§åˆ¶æ 
        bottom_control_bar = self.create_bottom_control_bar()
        
        # ç»„è£…å¸ƒå±€
        container_layout.addWidget(top_control_bar)
        container_layout.addWidget(self.web_container, 1)
        container_layout.addWidget(bottom_control_bar)
        
        layout.addWidget(container)
        
        # è¿æ¥ä¿¡å·
        self.connect_signals()
        
        # åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        self.update_buttons()
    
    def create_top_control_bar(self):
        """åˆ›å»ºé¡¶éƒ¨æ§åˆ¶æ  - Qtå…¼å®¹æ ·å¼"""
        control_bar = QFrame()
        control_bar.setFixedHeight(50)
        control_bar.setStyleSheet("""
            QFrame {
                background: rgba(30, 30, 50, 0.8);
                border-bottom: 1px solid rgba(255, 255, 255, 0.15);
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
            }
        """)
        
        layout = QHBoxLayout(control_bar)
        layout.setContentsMargins(20, 10, 20, 10)
        layout.setSpacing(20)
        
        # å°ºå¯¸é€‰æ‹©éƒ¨åˆ†
        size_container = QWidget()
        size_layout = QHBoxLayout(size_container)
        size_layout.setContentsMargins(0, 0, 0, 0)
        size_layout.setSpacing(10)
        
        size_label = QLabel("å°ºå¯¸:")
        size_label.setStyleSheet("""
            QLabel {
                color: rgba(255, 255, 255, 0.8);
                font-size: 13px;
                font-weight: 500;
            }
        """)
        
        self.size_selector = QComboBox()
        self.size_selector.addItems(["Small (720Ã—960)", "Medium (1080Ã—1440)", "Large (1440Ã—1920)"])
        self.size_selector.setCurrentIndex(1)
        self.size_selector.setFixedWidth(160)
        self.size_selector.setStyleSheet(self.get_combobox_style_qt())
        
        size_layout.addWidget(size_label)
        size_layout.addWidget(self.size_selector)
        
        # é¢„è§ˆæ¨¡å¼éƒ¨åˆ†
        mode_container = QWidget()
        mode_layout = QHBoxLayout(mode_container)
        mode_layout.setContentsMargins(0, 0, 0, 0)
        mode_layout.setSpacing(10)
        
        mode_label = QLabel("æ¨¡å¼:")
        mode_label.setStyleSheet("""
            QLabel {
                color: rgba(255, 255, 255, 0.8);
                font-size: 13px;
                font-weight: 500;
            }
        """)
        
        self.mode_group = QButtonGroup()
        
        self.fit_mode_btn = QRadioButton("é€‚åº”çª—å£")
        self.fit_mode_btn.setChecked(True)
        self.fit_mode_btn.setStyleSheet(self.get_radio_style_qt())
        
        self.actual_mode_btn = QRadioButton("å®é™…å¤§å°")
        self.actual_mode_btn.setStyleSheet(self.get_radio_style_qt())
        
        self.mode_group.addButton(self.fit_mode_btn, 0)
        self.mode_group.addButton(self.actual_mode_btn, 1)
        
        mode_layout.addWidget(mode_label)
        mode_layout.addWidget(self.fit_mode_btn)
        mode_layout.addWidget(self.actual_mode_btn)
        
        # ç»„è£…é¡¶éƒ¨æ§åˆ¶æ 
        layout.addWidget(size_container)
        layout.addSpacing(30)
        layout.addWidget(mode_container)
        layout.addStretch()
        
        return control_bar
    
    def create_web_view_container(self):
        """åˆ›å»ºWebViewå®¹å™¨ - Qtå…¼å®¹æ ·å¼"""
        # ä½¿ç”¨è‡ªå®šä¹‰æ»šåŠ¨åŒºåŸŸ
        self.web_container = CustomScrollArea()
        self.web_container.preview_widget = self  # è®¾ç½®å¼•ç”¨
        
        self.web_container.setStyleSheet("""
            QScrollArea {
                border: none;
                background: rgba(20, 20, 40, 0.4);
            }
            
            QScrollBar:vertical {
                background: rgba(255, 255, 255, 0.03);
                width: 12px;
                border-radius: 6px;
                margin: 4px;
            }
            
            QScrollBar::handle:vertical {
                background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 255, 255, 0.3),
                    stop: 1 rgba(255, 0, 255, 0.3));
                border-radius: 6px;
                min-height: 30px;
            }
            
            QScrollBar::handle:vertical:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 255, 255, 0.5),
                    stop: 1 rgba(255, 0, 255, 0.5));
            }
            
            QScrollBar::add-line:vertical,
            QScrollBar::sub-line:vertical {
                height: 0px;
            }
            
            QScrollBar:horizontal {
                background: rgba(255, 255, 255, 0.03);
                height: 12px;
                border-radius: 6px;
                margin: 4px;
            }
            
            QScrollBar::handle:horizontal {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 255, 0.3),
                    stop: 1 rgba(255, 0, 255, 0.3));
                border-radius: 6px;
                min-width: 30px;
            }
            
            QScrollBar::handle:horizontal:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 255, 0.5),
                    stop: 1 rgba(255, 0, 255, 0.5));
            }
            
            QScrollBar::add-line:horizontal,
            QScrollBar::sub-line:horizontal {
                width: 0px;
            }
        """)
        
        # åˆ›å»ºWebView
        self.web_view = QWebEngineView()
        self.web_view.setStyleSheet("""
            QWebEngineView {
                border: none;
                background: transparent;
            }
        """)
        
        # ç¦ç”¨WebViewè‡ªèº«çš„æ»šåŠ¨æ¡å’Œé¼ æ ‡äº¤äº’ï¼ˆåœ¨å®é™…å¤§å°æ¨¡å¼ä¸‹ï¼‰
        self.web_view.setAttribute(Qt.WA_TransparentForMouseEvents, False)
        self.web_view.setFocusPolicy(Qt.StrongFocus)
        
        # è®¾ç½®æ»šåŠ¨åŒºåŸŸ
        self.web_container.setWidget(self.web_view)
        self.web_container.setWidgetResizable(True)
        self.web_container.setAlignment(Qt.AlignCenter)
        
        # é»˜è®¤è®¾ç½®ä¸ºé€‚åº”çª—å£æ¨¡å¼
        self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
    
    def create_bottom_control_bar(self):
        """åˆ›å»ºåº•éƒ¨å¯¼èˆªæ§åˆ¶æ  - Qtå…¼å®¹æ ·å¼"""
        control_bar = QFrame()
        control_bar.setFixedHeight(60)
        control_bar.setStyleSheet("""
            QFrame {
                background: rgba(20, 20, 40, 0.8);
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
        """)
        
        control_layout = QHBoxLayout(control_bar)
        control_layout.setContentsMargins(20, 12, 20, 12)
        control_layout.setSpacing(15)
        
        # åˆ›å»ºä¸­å¿ƒæ§åˆ¶åŒºå®¹å™¨
        center_controls = QWidget()
        center_layout = QHBoxLayout(center_controls)
        center_layout.setContentsMargins(0, 0, 0, 0)
        center_layout.setSpacing(15)
        
        # ä¸Šä¸€é¡µæŒ‰é’®
        self.prev_btn = QPushButton("â¬… Previous")
        self.prev_btn.setFixedSize(110, 36)
        self.prev_btn.setStyleSheet(self.get_button_style_qt())
        
        # é¡µé¢ä¿¡æ¯æ ‡ç­¾
        self.page_info_label = QLabel("Page 1")
        self.page_info_label.setStyleSheet("""
            QLabel {
                color: #00ff88;
                font-size: 14px;
                font-weight: 600;
                padding: 8px 20px;
                background: rgba(0, 255, 136, 0.1);
                border: 1px solid rgba(0, 255, 136, 0.3);
                border-radius: 18px;
                min-width: 100px;
            }
        """)
        self.page_info_label.setAlignment(Qt.AlignCenter)
        
        # ä¸‹ä¸€é¡µæŒ‰é’®
        self.next_btn = QPushButton("Next â¡")
        self.next_btn.setFixedSize(110, 36)
        self.next_btn.setStyleSheet(self.get_button_style_qt())
        
        # ç»„è£…ä¸­å¿ƒæ§åˆ¶åŒº
        center_layout.addWidget(self.prev_btn)
        center_layout.addWidget(self.page_info_label)
        center_layout.addWidget(self.next_btn)
        
        # å¿«æ·æç¤º
        tips_label = QLabel("ğŸ’¡ æ»šè½®ï¼šä¸Šä¸‹å¯¼èˆª â€¢ Shift+æ»šè½®ï¼šå·¦å³æ»šåŠ¨")
        tips_label.setStyleSheet("""
            QLabel {
                color: rgba(255, 255, 255, 0.5);
                font-size: 11px;
                font-style: italic;
                background: transparent;
            }
        """)
        tips_label.setFont(QFont("Arial", 10))
        
        # ç»„è£…æ§åˆ¶æ 
        control_layout.addStretch()
        control_layout.addWidget(center_controls)
        control_layout.addStretch()
        control_layout.addWidget(tips_label)
        
        return control_bar
    
    def connect_signals(self):
        """è¿æ¥ä¿¡å·"""
        self.prev_btn.clicked.connect(self.prev_page)
        self.next_btn.clicked.connect(self.next_page)
        self.size_selector.currentIndexChanged.connect(self.on_size_changed)
        self.mode_group.buttonClicked.connect(self.on_mode_changed)
    
    def keyPressEvent(self, event):
        """å¤„ç†é”®ç›˜äº‹ä»¶"""
        if event.key() == Qt.Key_PageUp:
            self.prev_page()
        elif event.key() == Qt.Key_PageDown:
            self.next_page()
        elif event.key() == Qt.Key_Home:
            self.go_to_page(1)
        elif event.key() == Qt.Key_End:
            self.go_to_page(self.total_pages)
        else:
            super().keyPressEvent(event)
    
    def on_mode_changed(self):
        """å¤„ç†é¢„è§ˆæ¨¡å¼æ”¹å˜"""
        if self.fit_mode_btn.isChecked():
            self.preview_mode = "fit"
            # é€‚åº”çª—å£æ¨¡å¼ï¼šéšè—æ»šåŠ¨æ¡ï¼Œå¯ç”¨è‡ªé€‚åº”
            self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            self.web_container.setWidgetResizable(True)
            
            # æ¸…é™¤ WebView çš„å›ºå®šå°ºå¯¸é™åˆ¶
            self.web_view.setMinimumSize(0, 0)
            self.web_view.setMaximumSize(16777215, 16777215)
            
            # åœ¨é€‚åº”æ¨¡å¼ä¸‹ï¼ŒWebViewä¸éœ€è¦å¤„ç†é¼ æ ‡äº‹ä»¶
            self.web_view.setAttribute(Qt.WA_TransparentForMouseEvents, False)
            
        else:
            self.preview_mode = "actual"
            # å®é™…å¤§å°æ¨¡å¼ï¼šæ˜¾ç¤ºæ»šåŠ¨æ¡
            self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAsNeeded)
            self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
            self.web_container.setWidgetResizable(False)
            
            # åœ¨å®é™…å¤§å°æ¨¡å¼ä¸‹ï¼Œè®©WebViewé€æ˜äºé¼ æ ‡æ»šè½®äº‹ä»¶
            # è¿™æ ·æ»šè½®äº‹ä»¶ä¼šç›´æ¥ä¼ é€’ç»™ScrollArea
            self.web_view.setAttribute(Qt.WA_TransparentForMouseEvents, True)
        
        # é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢
        self.display_current_page()
    
    def on_size_changed(self, index):
        """å¤„ç†å°ºå¯¸æ”¹å˜"""
        size_map = {0: "small", 1: "medium", 2: "large"}
        new_size = size_map.get(index, "medium")
        
        if new_size != self.current_size:
            self.current_size = new_size
            
            # æ›´æ–°å„ç»„ä»¶çš„å°ºå¯¸è®¾ç½®
            self.html_generator = HTMLGenerator(page_size=new_size)
            self.paginator.set_page_size(new_size)
            
            # é‡æ–°å¤„ç†å†…å®¹
            if self.markdown_text:
                self.update_content(self.markdown_text)
            
            # å‘é€å°ºå¯¸æ”¹å˜ä¿¡å·
            self.sizeChanged.emit(new_size)
    
    def update_content(self, markdown_text: str):
        """æ›´æ–°é¢„è§ˆå†…å®¹"""
        try:
            self.markdown_text = markdown_text
            
            # å¤„ç† Markdown
            html_content = self.markdown_processor.parse(markdown_text)
            
            # ä½¿ç”¨æ™ºèƒ½åˆ†é¡µå™¨è¿›è¡Œåˆ†é¡µ
            self.current_pages = self.paginator.paginate(html_content)
            
            # ä¼˜åŒ–åˆ†é¡µç»“æœ
            self.current_pages = self.paginator.optimize_pages(self.current_pages)
            
            self.total_pages = len(self.current_pages)
            self.current_page = 1
            
            # æ˜¾ç¤ºç¬¬ä¸€é¡µ
            self.display_current_page()
            
            # æ›´æ–°æŒ‰é’®å’Œä¿¡æ¯
            self.update_buttons()
            self.update_page_info()
            
        except Exception as e:
            self.show_error(f"Preview error: {str(e)}")
    
    def display_current_page(self):
        """æ˜¾ç¤ºå½“å‰é¡µ"""
        if not self.current_pages:
            return
            
        if 1 <= self.current_page <= len(self.current_pages):
            page_content = self.current_pages[self.current_page - 1]
            
            # è·å–ç›®æ ‡å°ºå¯¸
            size_config = {
                "small": (720, 960),
                "medium": (1080, 1440),
                "large": (1440, 1920)
            }
            target_width, target_height = size_config.get(self.current_size, (1080, 1440))
            
            # æ ¹æ®é¢„è§ˆæ¨¡å¼ç”Ÿæˆä¸åŒçš„HTML
            if self.preview_mode == "fit":
                # é€‚åº”çª—å£æ¨¡å¼
                full_html = self.generate_fit_html(page_content, target_width, target_height)
                self.web_view.setMinimumSize(0, 0)
                self.web_view.setMaximumSize(16777215, 16777215)
                self.web_container.setWidgetResizable(True)
                
            else:
                # å®é™…å¤§å°æ¨¡å¼ï¼šæ·»åŠ ç¦ç”¨å†…éƒ¨æ»šåŠ¨çš„CSS
                full_html = self.generate_actual_html(page_content, target_width, target_height)
                # è®¾ç½®WebViewä¸ºå®é™…å°ºå¯¸
                self.web_view.setFixedSize(target_width, target_height)
                self.web_container.setWidgetResizable(False)
            
            # åŠ è½½åˆ°WebView
            self.web_view.setHtml(full_html, QUrl("file:///"))
    
    def generate_actual_html(self, content: str, target_width: int, target_height: int) -> str:
        """ç”Ÿæˆå®é™…å¤§å°æ¨¡å¼çš„HTMLï¼ˆç¦ç”¨å†…éƒ¨æ»šåŠ¨ï¼‰"""
        base_html = self.html_generator.generate(content)
        
        # æ·»åŠ ç¦ç”¨æ»šåŠ¨çš„CSSå’ŒJavaScript
        disable_scroll = """
        <style>
            /* ç¦ç”¨æ‰€æœ‰å†…éƒ¨æ»šåŠ¨ */
            html, body {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
                touch-action: none !important;
                user-select: none !important;
                -webkit-user-select: none !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }
            
            html::-webkit-scrollbar,
            body::-webkit-scrollbar {
                display: none !important;
            }
            
            * {
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }
            
            *::-webkit-scrollbar {
                display: none !important;
            }
        </style>
        
        <script>
            // ç¦ç”¨æ»šåŠ¨äº‹ä»¶
            document.addEventListener('DOMContentLoaded', function() {
                // ç¦ç”¨æ»šè½®äº‹ä»¶
                document.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, { passive: false, capture: true });
                
                // ç¦ç”¨è§¦æ‘¸æ»šåŠ¨
                document.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, { passive: false, capture: true });
                
                // ç¦ç”¨é”®ç›˜æ»šåŠ¨
                document.addEventListener('keydown', function(e) {
                    const scrollKeys = [32, 33, 34, 35, 36, 37, 38, 39, 40];
                    if (scrollKeys.includes(e.keyCode)) {
                        e.preventDefault();
                        return false;
                    }
                }, false);
                
                // å›ºå®šbodyä½ç½®
                document.body.style.position = 'fixed';
                document.body.style.top = '0';
                document.body.style.left = '0';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                document.body.style.overflow = 'hidden';
            });
        </script>
        """
        
        # æ’å…¥åˆ°headæ ‡ç­¾ç»“æŸå‰
        full_html = base_html.replace('</head>', disable_scroll + '</head>')
        
        return full_html
    
    def generate_fit_html(self, content: str, target_width: int, target_height: int) -> str:
        """ç”Ÿæˆé€‚åº”çª—å£çš„HTML"""
        base_html = self.html_generator.generate(content)
        
        scale_script = f"""
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}
            
            html, body {{
                width: 100%;
                height: 100%;
                overflow: hidden;
                background: #1a1a2e;
                display: flex;
                justify-content: center;
                align-items: center;
            }}
            
            #viewport-container {{
                position: relative;
                width: 100vw;
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
            }}
            
            #content-wrapper {{
                position: relative;
                width: {target_width}px;
                height: {target_height}px;
                transform-origin: center center;
                flex-shrink: 0;
            }}
        </style>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {{
                if (!document.getElementById('viewport-container')) {{
                    const viewportContainer = document.createElement('div');
                    viewportContainer.id = 'viewport-container';
                    
                    const contentWrapper = document.createElement('div');
                    contentWrapper.id = 'content-wrapper';
                    
                    while (document.body.firstChild) {{
                        contentWrapper.appendChild(document.body.firstChild);
                    }}
                    
                    viewportContainer.appendChild(contentWrapper);
                    document.body.appendChild(viewportContainer);
                }}
                
                function adjustScale() {{
                    const wrapper = document.getElementById('content-wrapper');
                    const container = document.getElementById('viewport-container');
                    
                    if (!wrapper || !container) return;
                    
                    const availableWidth = container.clientWidth;
                    const availableHeight = container.clientHeight;
                    
                    const targetWidth = {target_width};
                    const targetHeight = {target_height};
                    
                    const padding = 40;
                    const scaleX = (availableWidth - padding) / targetWidth;
                    const scaleY = (availableHeight - padding) / targetHeight;
                    
                    const scale = Math.min(scaleX, scaleY, 1.0);
                    
                    wrapper.style.transform = `scale(${{scale}})`;
                }}
                
                setTimeout(adjustScale, 100);
                window.addEventListener('resize', adjustScale);
                
                const observer = new ResizeObserver(adjustScale);
                observer.observe(document.getElementById('viewport-container'));
            }});
        </script>
        """
        
        full_html = base_html.replace('</head>', scale_script + '</head>')
        return full_html
    
    def prev_page(self):
        """ä¸Šä¸€é¡µ"""
        if self.current_page > 1:
            self.go_to_page(self.current_page - 1)
    
    def next_page(self):
        """ä¸‹ä¸€é¡µ"""
        if self.current_page < self.total_pages:
            self.go_to_page(self.current_page + 1)
    
    def go_to_page(self, page_num: int):
        """è·³è½¬åˆ°æŒ‡å®šé¡µ"""
        if 1 <= page_num <= self.total_pages:
            self.current_page = page_num
            self.display_current_page()
            self.update_buttons()
            self.update_page_info()
    
    def update_buttons(self):
        """æ›´æ–°æŒ‰é’®çŠ¶æ€"""
        self.prev_btn.setEnabled(self.current_page > 1)
        self.next_btn.setEnabled(self.current_page < self.total_pages)
        self.pageChanged.emit(self.current_page, self.total_pages)
    
    def update_page_info(self):
        """æ›´æ–°é¡µé¢ä¿¡æ¯æ˜¾ç¤º"""
        if self.total_pages > 1:
            self.page_info_label.setText(f"Page {self.current_page} / {self.total_pages}")
        else:
            self.page_info_label.setText("Page 1")
    
    def get_button_style_qt(self) -> str:
        """è·å–æŒ‰é’®æ ·å¼ - Qtå…¼å®¹ç‰ˆæœ¬"""
        return """
            QPushButton {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.25);
                color: rgba(255, 255, 255, 0.95);
                padding: 10px 20px;
                border-radius: 18px;
                font-weight: 600;
                font-size: 13px;
                letter-spacing: 0.5px;
            }
            
            QPushButton:hover {
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(0, 255, 136, 0.5);
                color: #00ff88;
            }
            
            QPushButton:pressed {
                background: rgba(0, 255, 136, 0.2);
            }
            
            QPushButton:disabled {
                background: rgba(255, 255, 255, 0.02);
                border-color: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.3);
            }
        """
    
    def get_combobox_style_qt(self) -> str:
        """è·å–ä¸‹æ‹‰æ¡†æ ·å¼ - Qtå…¼å®¹ç‰ˆæœ¬"""
        return """
            QComboBox {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: rgba(255, 255, 255, 0.95);
                padding: 8px 15px;
                border-radius: 10px;
                font-size: 12px;
                font-weight: 500;
                letter-spacing: 0.3px;
            }
            
            QComboBox:hover {
                background: rgba(255, 255, 255, 0.12);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
            
            QComboBox::drop-down {
                border: none;
                width: 25px;
            }
            
            QComboBox::down-arrow {
                image: none;
                border-style: solid;
                border-width: 5px 5px 0 5px;
                border-color: rgba(255, 255, 255, 0.7) transparent transparent transparent;
                margin-right: 5px;
            }
            
            QComboBox QAbstractItemView {
                background: rgba(30, 30, 50, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                selection-background-color: rgba(0, 255, 136, 0.3);
                outline: none;
                padding: 5px;
                border-radius: 8px;
            }
            
            QComboBox QAbstractItemView::item {
                min-height: 32px;
                padding: 8px 12px;
                border-radius: 4px;
                margin: 2px 4px;
            }
            
            QComboBox QAbstractItemView::item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
            
            QComboBox QAbstractItemView::item:selected {
                background: rgba(0, 255, 136, 0.3);
                color: white;
            }
        """
    
    def get_radio_style_qt(self) -> str:
        """è·å–å•é€‰æŒ‰é’®æ ·å¼ - Qtå…¼å®¹ç‰ˆæœ¬"""
        return """
            QRadioButton {
                color: rgba(255, 255, 255, 0.85);
                font-size: 12px;
                spacing: 8px;
                padding: 5px;
            }
            
            QRadioButton::indicator {
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.05);
            }
            
            QRadioButton::indicator:hover {
                border-color: rgba(0, 255, 136, 0.5);
                background: rgba(0, 255, 136, 0.1);
            }
            
            QRadioButton::indicator:checked {
                background: qradialgradient(
                    cx: 0.5, cy: 0.5, radius: 0.5,
                    fx: 0.5, fy: 0.5,
                    stop: 0 #00ff88,
                    stop: 0.6 #00ff88,
                    stop: 0.7 transparent
                );
                border-color: #00ff88;
            }
            
            QRadioButton:checked {
                color: #00ff88;
            }
        """
    
    def setup_exporter(self):
        """è®¾ç½®å¯¼å‡ºå™¨"""
        self.exporter = ImageExporter(self.web_view)
        self.exporter.progress.connect(self.on_export_progress)
        self.exporter.finished.connect(self.on_export_finished)
        self.exporter.page_exported.connect(self.on_page_exported)
    
    def export_pages(self, folder: str):
        """å¯¼å‡ºæ‰€æœ‰é¡µé¢ä¸ºå›¾ç‰‡"""
        if not self.current_pages:
            QMessageBox.warning(self, "Warning", "No content to export")
            return
        
        # åˆ›å»ºè¿›åº¦å¯¹è¯æ¡†
        self.progress_dialog = QProgressDialog(
            "Exporting images...", 
            "Cancel", 
            0, 
            self.total_pages, 
            self
        )
        self.progress_dialog.setWindowModality(Qt.WindowModal)
        self.progress_dialog.setMinimumDuration(0)
        self.progress_dialog.setAutoClose(False)
        self.progress_dialog.setAutoReset(False)
        
        # è®¾ç½®è¿›åº¦å¯¹è¯æ¡†æ ·å¼
        self.progress_dialog.setStyleSheet("""
            QProgressDialog {
                background: rgba(30, 30, 50, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                color: white;
            }
            QProgressBar {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 5px;
                text-align: center;
                color: white;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 136, 0.6),
                    stop: 1 rgba(0, 255, 255, 0.6));
                border-radius: 4px;
            }
            QPushButton {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 15px;
                border-radius: 5px;
            }
            QPushButton:hover {
                background: rgba(255, 255, 255, 0.15);
            }
        """)
        
        self.progress_dialog.canceled.connect(self.on_export_canceled)
        
        # å¼€å§‹å¯¼å‡ºï¼ˆå§‹ç»ˆä»¥å®é™…å¤§å°å¯¼å‡ºï¼‰
        self.exporter.export_pages(
            self.current_pages,
            folder,
            self.html_generator,
            format="PNG",
            quality=100
        )
    
    def on_export_progress(self, current: int, total: int):
        """å¤„ç†å¯¼å‡ºè¿›åº¦"""
        if hasattr(self, 'progress_dialog') and self.progress_dialog:
            self.progress_dialog.setValue(current)
            self.progress_dialog.setLabelText(f"Exporting page {current}/{total}...")
    
    def on_export_finished(self, success: bool, message: str):
        """å¤„ç†å¯¼å‡ºå®Œæˆ"""
        if hasattr(self, 'progress_dialog') and self.progress_dialog:
            try:
                self.progress_dialog.canceled.disconnect()
                self.progress_dialog.close()
                self.progress_dialog.deleteLater()
            except:
                pass
            finally:
                self.progress_dialog = None
        
        if success:
            size_info = f"({self.current_size}: {self.get_actual_size()}px)"
            QMessageBox.information(self, "Export Successful", f"{message}\nSize: {size_info}")
        else:
            QMessageBox.warning(self, "Export Failed", message)
    
    def on_page_exported(self, page_num: int, file_path: str):
        """å¤„ç†å•é¡µå¯¼å‡ºå®Œæˆ"""
        print(f"Exported page {page_num}: {file_path}")
    
    def on_export_canceled(self):
        """å¤„ç†å¯¼å‡ºå–æ¶ˆ"""
        self.exporter.cancel_export()
    
    def get_actual_size(self) -> str:
        """è·å–å®é™…å°ºå¯¸"""
        size_config = {
            "small": "720Ã—960",
            "medium": "1080Ã—1440",
            "large": "1440Ã—1920"
        }
        return size_config.get(self.current_size, "1080Ã—1440")
    
    def handle_scroll(self, percentage: float):
        """å¤„ç†ç¼–è¾‘å™¨æ»šåŠ¨åŒæ­¥ï¼ˆä¿ç•™æ¥å£å…¼å®¹æ€§ï¼‰"""
        pass
    
    def show_error(self, message: str):
        """æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯"""
        error_html = f"""
        <html>
        <body style="padding: 20px; font-family: sans-serif; background: #1a1a2e; color: #e0e6ed;">
            <h3 style="color: #ff4757;">Error</h3>
            <p style="color: #8a92a6;">{message}</p>
        </body>
        </html>
        """
        self.web_view.setHtml(error_html)
    
    def change_theme(self, theme: str):
        """åˆ‡æ¢ä¸»é¢˜"""
        self.html_generator.set_theme(theme)
        if self.current_pages:
            self.display_current_page()
    
    def resizeEvent(self, event):
        """å¤„ç†çª—å£å¤§å°æ”¹å˜äº‹ä»¶"""
        super().resizeEvent(event)
        # åœ¨é€‚åº”çª—å£æ¨¡å¼ä¸‹ï¼Œé‡æ–°æ¸²æŸ“ä»¥é€‚åº”æ–°å°ºå¯¸
        if self.preview_mode == "fit" and self.current_pages:
            # å»¶è¿Ÿæ‰§è¡Œä»¥é¿å…é¢‘ç¹é‡ç»˜
            if hasattr(self, 'resize_timer'):
                self.resize_timer.stop()
            else:
                self.resize_timer = QTimer()
                self.resize_timer.timeout.connect(self.on_resize_finished)
                self.resize_timer.setSingleShot(True)
            self.resize_timer.start(300)
    
    def on_resize_finished(self):
        """çª—å£å¤§å°è°ƒæ•´å®Œæˆåçš„å¤„ç†"""
        if self.preview_mode == "fit":
            self.display_current_page() exporter.py->text/plain-># ============================================
# src/utils/exporter.py
# ============================================
from PySide6.QtCore import QObject, Signal, QTimer, QEventLoop, QSize, Qt, QPoint, QRect
from PySide6.QtGui import QImage, QPainter, QFont, QColor, QPageSize, QRegion
from PySide6.QtWebEngineWidgets import QWebEngineView
from PySide6.QtPrintSupport import QPrinter
from PySide6.QtWidgets import QWidget
from pathlib import Path
from typing import List, Optional
import json
import time

class ImageExporter(QObject):
    """å›¾ç‰‡å¯¼å‡ºå™¨"""
    
    # ä¿¡å·
    progress = Signal(int, int)  # å½“å‰è¿›åº¦ï¼Œæ€»æ•°
    finished = Signal(bool, str)  # æ˜¯å¦æˆåŠŸï¼Œæ¶ˆæ¯
    page_exported = Signal(int, str)  # é¡µç ï¼Œæ–‡ä»¶è·¯å¾„
    
    def __init__(self, web_view: QWebEngineView):
        super().__init__()
        self.web_view = web_view
        self.pages_to_export = []
        self.current_export_index = 0
        self.output_folder = ""
        self.html_generator = None
        self.export_format = "PNG"
        self.quality = 100
        self._is_exporting = False
        
    def export_pages(self, pages: List[str], output_folder: str, html_generator, 
                     format: str = "PNG", quality: int = 100) -> None:
        """
        å¯¼å‡ºå¤šä¸ªé¡µé¢ä¸ºå›¾ç‰‡
        
        Args:
            pages: HTMLé¡µé¢å†…å®¹åˆ—è¡¨
            output_folder: è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„
            html_generator: HTMLç”Ÿæˆå™¨å®ä¾‹
            format: å›¾ç‰‡æ ¼å¼ (PNG/JPEG)
            quality: å›¾ç‰‡è´¨é‡ (1-100)
        """
        self.pages_to_export = pages
        self.output_folder = Path(output_folder)
        self.current_export_index = 0
        self.html_generator = html_generator
        self.export_format = format
        self.quality = quality
        self._is_exporting = True
        
        # ç¡®ä¿è¾“å‡ºæ–‡ä»¶å¤¹å­˜åœ¨
        self.output_folder.mkdir(parents=True, exist_ok=True)
        
        # ç¡®ä¿WebViewæ˜¯å›ºå®šå°ºå¯¸
        self.web_view.setFixedSize(1080, 1440)
        self.web_view.setZoomFactor(1.0)  # é‡ç½®ç¼©æ”¾
        
        # å¼€å§‹å¯¼å‡ºç¬¬ä¸€é¡µ
        self._export_next_page()
    
    def _export_next_page(self):
        """å¯¼å‡ºä¸‹ä¸€é¡µ"""
        if not self._is_exporting:
            return
            
        if self.current_export_index >= len(self.pages_to_export):
            # å¯¼å‡ºå®Œæˆ
            self._is_exporting = False
            self.finished.emit(True, f"æˆåŠŸå¯¼å‡º {len(self.pages_to_export)} å¼ å›¾ç‰‡")
            return
        
        # å‘é€è¿›åº¦ä¿¡å·
        self.progress.emit(self.current_export_index + 1, len(self.pages_to_export))
        
        # è·å–å½“å‰é¡µå†…å®¹
        page_content = self.pages_to_export[self.current_export_index]
        page_num = self.current_export_index + 1
        
        # ç”Ÿæˆå®Œæ•´HTMLï¼ˆåŒ…å«é¡µç ä¿¡æ¯ï¼‰
        full_html = self.html_generator.generate(
            page_content, 
            page_num=page_num, 
            total_pages=len(self.pages_to_export)
        )
        
        # åŠ è½½HTMLåˆ°WebView
        self.web_view.setHtml(full_html, "file:///")
        
        # ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå¯¼å‡º
        QTimer.singleShot(1500, lambda: self._capture_page(page_num))
    
    def _capture_page(self, page_num: int):
        """æ•è·å½“å‰é¡µé¢ä¸ºå›¾ç‰‡"""
        if not self._is_exporting:
            return
            
        # æ„å»ºè¾“å‡ºæ–‡ä»¶å
        extension = self.export_format.lower()
        filename = f"card_{page_num:02d}.{extension}"
        output_path = self.output_folder / filename
        
        # ä½¿ç”¨ç²¾ç¡®çš„æ•è·æ–¹æ³•
        self._capture_fixed_size(output_path, page_num)
    
    def _capture_fixed_size(self, output_path: Path, page_num: int):
        """æ•è·å›ºå®šå°ºå¯¸çš„é¡µé¢"""
        try:
            # ä»html_generatorè·å–å½“å‰å°ºå¯¸
            target_width = self.html_generator.page_width
            target_height = self.html_generator.page_height
            
            # åˆ›å»ºç›®æ ‡å›¾ç‰‡
            image = QImage(target_width, target_height, QImage.Format_ARGB32)
            image.fill(Qt.white)
            
            # åˆ›å»ºpainter
            painter = QPainter(image)
            painter.setRenderHint(QPainter.RenderHint.Antialiasing, True)
            painter.setRenderHint(QPainter.RenderHint.TextAntialiasing, True)
            painter.setRenderHint(QPainter.RenderHint.SmoothPixmapTransform, True)
            
            # ç¡®ä¿WebViewæ˜¯æ­£ç¡®çš„å°ºå¯¸
            self.web_view.resize(target_width, target_height)
            
            # æ¸²æŸ“WebViewåˆ°å›¾ç‰‡
            # ä½¿ç”¨å›ºå®šçš„æºçŸ©å½¢æ¥ç¡®ä¿åªæ•è·å¡ç‰‡åŒºåŸŸ
            source_rect = QRect(0, 0, target_width, target_height)
            target_rect = QRect(0, 0, target_width, target_height)
            
            # æ¸²æŸ“WebView
            if isinstance(self.web_view, QWidget):
                self.web_view.render(
                    painter,
                    QPoint(0, 0),
                    QRegion(source_rect),
                    QWidget.RenderFlag.DrawWindowBackground | QWidget.RenderFlag.DrawChildren
                )
            
            # å¯é€‰ï¼šæ·»åŠ å¯¼å‡ºæ—¶é—´æ°´å°
            self._add_export_watermark(painter, page_num)
            
            painter.end()
            
            # ä¿å­˜å›¾ç‰‡
            success = image.save(str(output_path), self.export_format, self.quality)
            
            if success:
                self.page_exported.emit(page_num, str(output_path))
                # ç»§ç»­å¯¼å‡ºä¸‹ä¸€é¡µ
                self.current_export_index += 1
                QTimer.singleShot(100, self._export_next_page)
            else:
                self._is_exporting = False
                self.finished.emit(False, f"ä¿å­˜å›¾ç‰‡å¤±è´¥: {output_path}")
                
        except Exception as e:
            self._is_exporting = False
            self.finished.emit(False, f"å¯¼å‡ºé¡µé¢ {page_num} æ—¶å‡ºé”™: {str(e)}")
    
    def _add_export_watermark(self, painter: QPainter, page_num: int):
        """æ·»åŠ å¯¼å‡ºæ°´å°ï¼ˆå¯é€‰ï¼‰"""
        # è®¾ç½®æ°´å°å­—ä½“å’Œé¢œè‰²
        font = QFont("Arial", 9)
        painter.setFont(font)
        painter.setPen(QColor(200, 200, 200, 80))
        
        # åœ¨å³ä¸‹è§’æ·»åŠ ç”Ÿæˆæ—¶é—´ï¼ˆéå¸¸æ·¡çš„æ°´å°ï¼‰
        timestamp = time.strftime("%Y%m%d")
        painter.drawText(
            1000, 1420,
            f"{timestamp}"
        )
    
    def export_as_pdf(self, pages: List[str], output_file: str, html_generator):
        """
        å¯¼å‡ºä¸ºPDFæ–‡ä»¶ï¼ˆæ‰€æœ‰é¡µé¢åˆå¹¶ä¸ºä¸€ä¸ªPDFï¼‰
        
        Args:
            pages: HTMLé¡µé¢å†…å®¹åˆ—è¡¨
            output_file: è¾“å‡ºPDFæ–‡ä»¶è·¯å¾„
            html_generator: HTMLç”Ÿæˆå™¨å®ä¾‹
        """
        try:
            # åˆ›å»ºPDFæ‰“å°æœº
            printer = QPrinter(QPrinter.PrinterMode.HighResolution)
            printer.setOutputFormat(QPrinter.OutputFormat.PdfFormat)
            printer.setOutputFileName(output_file)
            
            # è®¾ç½®é¡µé¢å¤§å°ä¸ºå°çº¢ä¹¦å¡ç‰‡æ¯”ä¾‹
            # æ³¨æ„ï¼šPDFä½¿ç”¨ç‚¹(point)ä½œä¸ºå•ä½ï¼Œ1ç‚¹ = 1/72è‹±å¯¸
            # 1080px Ã— 1440px åœ¨ 96 DPI ä¸‹çº¦ç­‰äº 810pt Ã— 1080pt
            page_size = QPageSize(QSize(810, 1080), QPageSize.Unit.Point)
            printer.setPageSize(page_size)
            printer.setPageMargins(0, 0, 0, 0, QPrinter.Unit.Millimeter)
            
            # åˆå¹¶æ‰€æœ‰é¡µé¢å†…å®¹
            combined_html = self._combine_pages_for_pdf(pages, html_generator)
            
            # åŠ è½½åˆå¹¶åçš„HTML
            self.web_view.setHtml(combined_html, "file:///")
            
            # ç­‰å¾…åŠ è½½å®Œæˆåæ‰“å°
            loop = QEventLoop()
            
            def on_load_finished():
                self.web_view.page().print(printer, lambda success: loop.quit())
            
            QTimer.singleShot(1000, on_load_finished)
            loop.exec()
            
            self.finished.emit(True, f"PDFå¯¼å‡ºæˆåŠŸ: {output_file}")
            
        except Exception as e:
            self.finished.emit(False, f"PDFå¯¼å‡ºå¤±è´¥: {str(e)}")
    
    def _combine_pages_for_pdf(self, pages: List[str], html_generator) -> str:
        """åˆå¹¶å¤šä¸ªé¡µé¢ä¸ºPDFæ ¼å¼"""
        combined_content = ""
        
        for i, page in enumerate(pages, 1):
            if i > 1:
                # æ·»åŠ åˆ†é¡µç¬¦
                combined_content += '<div style="page-break-before: always;"></div>'
            
            # æ·»åŠ é¡µé¢å†…å®¹ï¼ŒåŒ…è£…åœ¨å›ºå®šå°ºå¯¸çš„å®¹å™¨ä¸­
            combined_content += f'''
            <div style="width: 1080px; height: 1440px; position: relative; overflow: hidden;">
                {page}
            </div>
            '''
        
        # ç”Ÿæˆå®Œæ•´HTML
        return html_generator.generate(combined_content)
    
    def cancel_export(self):
        """å–æ¶ˆå¯¼å‡º"""
        self._is_exporting = False
        self.pages_to_export = []
        self.finished.emit(False, "å¯¼å‡ºå·²å–æ¶ˆ") paginator.py->text/plain-># ============================================
# src/utils/paginator.py
# ============================================
from typing import List, Tuple, Optional, Dict
from dataclasses import dataclass
from bs4 import BeautifulSoup, NavigableString, Tag, Comment
import re

@dataclass
class PageElement:
    """é¡µé¢å…ƒç´ """
    type: str  # 'heading', 'paragraph', 'list', 'code', 'blockquote', 'table', 'hr', 'text', 'pagebreak'
    content: str  # HTMLå†…å®¹
    text: str  # çº¯æ–‡æœ¬å†…å®¹ï¼ˆç”¨äºè®¡ç®—é«˜åº¦ï¼‰
    level: int = 0  # æ ‡é¢˜çº§åˆ«æˆ–åµŒå¥—æ·±åº¦
    height: int = 0  # ä¼°ç®—é«˜åº¦ï¼ˆåƒç´ ï¼‰
    can_break: bool = True  # æ˜¯å¦å¯ä»¥åœ¨æ­¤å¤„åˆ†é¡µ
    is_forced_break: bool = False  # æ˜¯å¦æ˜¯å¼ºåˆ¶åˆ†é¡µï¼ˆç”¨äºæ ‡è®°ç”¨æˆ·æ·»åŠ çš„åˆ†é¡µç¬¦ï¼‰
    
class SmartPaginator:
    """æ™ºèƒ½åˆ†é¡µå™¨ - æ”¯æŒå¤šå°ºå¯¸"""
    
    # å…ƒç´ é«˜åº¦ä¼°ç®—ï¼ˆåƒç´ ï¼‰- è°ƒæ•´ä¸ºæ›´å‡†ç¡®çš„å€¼
    ELEMENT_HEIGHTS = {
        'h1': 90,        # å¤§æ ‡é¢˜ + åº•éƒ¨è¾¹æ¡†
        'h2': 70,        # äºŒçº§æ ‡é¢˜
        'h3': 60,        # ä¸‰çº§æ ‡é¢˜
        'h4': 50,        # å››çº§æ ‡é¢˜
        'h5': 45,        # äº”çº§æ ‡é¢˜
        'h6': 40,        # å…­çº§æ ‡é¢˜
        'p_base': 25,    # æ®µè½åŸºç¡€é«˜åº¦
        'p_line': 28,    # æ®µè½æ¯è¡Œé«˜åº¦ï¼ˆè€ƒè™‘è¡Œé«˜1.8ï¼‰
        'li': 35,        # åˆ—è¡¨é¡¹
        'code_block': 40,  # ä»£ç å—åŸºç¡€é«˜åº¦
        'code_line': 24,   # ä»£ç æ¯è¡Œé«˜åº¦
        'blockquote': 60,  # å¼•ç”¨å—åŸºç¡€é«˜åº¦
        'blockquote_line': 28,  # å¼•ç”¨æ¯è¡Œé«˜åº¦
        'table_header': 45,  # è¡¨æ ¼å¤´
        'table_row': 40,     # è¡¨æ ¼è¡Œ
        'hr': 35,           # åˆ†éš”çº¿
        'margin_bottom': 20,  # å…ƒç´ åº•éƒ¨é—´è·
    }
    
    # é¡µé¢å°ºå¯¸é…ç½®
    PAGE_SIZES = {
        "small": {
            "width": 720,
            "height": 960,
            "padding_top": 35,
            "padding_bottom": 50,
            "padding_sides": 30
        },
        "medium": {
            "width": 1080,
            "height": 1440,
            "padding_top": 45,
            "padding_bottom": 70,
            "padding_sides": 40
        },
        "large": {
            "width": 1440,
            "height": 1920,
            "padding_top": 55,
            "padding_bottom": 90,
            "padding_sides": 50
        }
    }
    
    # åˆ†é¡µç­–ç•¥å‚æ•°
    MIN_ORPHAN_LINES = 2  # å­¤è¡Œæ§åˆ¶ï¼šæ®µè½æœ«å°¾æœ€å°‘ä¿ç•™è¡Œæ•°
    MIN_WIDOW_LINES = 2   # å¯¡è¡Œæ§åˆ¶ï¼šæ®µè½å¼€å¤´æœ€å°‘ä¿ç•™è¡Œæ•°
    HEADING_KEEP_WITH = 150  # æ ‡é¢˜åè‡³å°‘ä¿ç•™çš„å†…å®¹é«˜åº¦
    
    # å­—ç¬¦å®½åº¦ä¼°ç®—ï¼ˆåƒç´ ï¼‰
    CHAR_WIDTH = 16  # ä¸­æ–‡å­—ç¬¦å¹³å‡å®½åº¦
    CHAR_WIDTH_EN = 9  # è‹±æ–‡å­—ç¬¦å¹³å‡å®½åº¦
    
    def __init__(self, page_size: str = "medium"):
        """
        åˆå§‹åŒ–åˆ†é¡µå™¨
        
        Args:
            page_size: é¡µé¢å°ºå¯¸ ("small", "medium", "large")
        """
        self.elements: List[PageElement] = []
        self.set_page_size(page_size)
        self.forced_break_pages = set()  # è®°å½•å“ªäº›é¡µé¢æ˜¯é€šè¿‡åˆ†é¡µç¬¦åˆ›å»ºçš„
        
    def set_page_size(self, size: str):
        """è®¾ç½®é¡µé¢å°ºå¯¸"""
        if size not in self.PAGE_SIZES:
            size = "medium"
        
        config = self.PAGE_SIZES[size]
        self.page_size_name = size
        self.page_width = config["width"]
        self.page_height = config["height"]
        self.padding_top = config["padding_top"]
        self.padding_bottom = config["padding_bottom"]
        self.padding_sides = config["padding_sides"]
        
        # è®¡ç®—å†…å®¹åŒºåŸŸ
        self.content_width = self.page_width - (self.padding_sides * 2)
        self.content_height = self.page_height - self.padding_top - self.padding_bottom
        
        # æ ¹æ®å°ºå¯¸è°ƒæ•´åˆ†é¡µç­–ç•¥
        if size == "small":
            self.HEADING_KEEP_WITH = 100  # å°å°ºå¯¸é¡µé¢ï¼Œæ ‡é¢˜åä¿ç•™ç©ºé—´å¯ä»¥æ›´å°‘
        elif size == "large":
            self.HEADING_KEEP_WITH = 200  # å¤§å°ºå¯¸é¡µé¢ï¼Œæ ‡é¢˜åä¿ç•™æ›´å¤šç©ºé—´
        else:
            self.HEADING_KEEP_WITH = 150
    
    def get_page_info(self) -> Dict:
        """è·å–å½“å‰é¡µé¢é…ç½®ä¿¡æ¯"""
        return {
            "size_name": self.page_size_name,
            "width": self.page_width,
            "height": self.page_height,
            "content_width": self.content_width,
            "content_height": self.content_height,
            "padding": {
                "top": self.padding_top,
                "bottom": self.padding_bottom,
                "sides": self.padding_sides
            }
        }
    
    def paginate(self, html_content: str) -> List[str]:
        """
        æ ¸å¿ƒåˆ†é¡µæ–¹æ³•
        
        Args:
            html_content: HTMLå†…å®¹
            
        Returns:
            åˆ†é¡µåçš„HTMLå†…å®¹åˆ—è¡¨
        """
        # é‡ç½®å¼ºåˆ¶åˆ†é¡µè®°å½•
        self.forced_break_pages = set()
        
        # 1. è§£æHTMLä¸ºå…ƒç´ åˆ—è¡¨
        elements = self.parse_html_to_elements(html_content)
        
        if not elements:
            return [html_content] if html_content else []
        
        # 2. æ‰§è¡Œåˆ†é¡µ
        pages = []
        current_page_elements = []
        current_height = 0
        consecutive_breaks = 0  # è¿½è¸ªè¿ç»­çš„åˆ†é¡µç¬¦æ•°é‡
        
        i = 0
        while i < len(elements):
            element = elements[i]
            
            # å¤„ç†å¼ºåˆ¶åˆ†é¡µæ ‡è®°
            if element.type == 'pagebreak':
                consecutive_breaks += 1
                
                # ä¿å­˜å½“å‰é¡µï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
                if current_page_elements:
                    pages.append(self._elements_to_html(current_page_elements))
                    self.forced_break_pages.add(len(pages) - 1)  # è®°å½•è¿™æ˜¯å¼ºåˆ¶åˆ†é¡µ
                    current_page_elements = []
                    current_height = 0
                elif consecutive_breaks > 1:
                    # å¦‚æœæ˜¯è¿ç»­çš„åˆ†é¡µç¬¦ï¼Œåˆ›å»ºç©ºé¡µ
                    pages.append("")
                    self.forced_break_pages.add(len(pages) - 1)  # è®°å½•è¿™æ˜¯å¼ºåˆ¶åˆ†é¡µåˆ›å»ºçš„ç©ºé¡µ
                
                i += 1
                continue
            
            # éåˆ†é¡µç¬¦å…ƒç´ ï¼Œé‡ç½®è¿ç»­åˆ†é¡µç¬¦è®¡æ•°
            consecutive_breaks = 0
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†é¡µ
            element_height = element.height
            
            # ç‰¹æ®Šå¤„ç†ï¼šæ ‡é¢˜å…ƒç´ 
            if element.type == 'heading':
                # æ£€æŸ¥æ ‡é¢˜åæ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´æ”¾ç½®å†…å®¹
                if current_height + element_height + self.HEADING_KEEP_WITH > self.content_height:
                    # éœ€è¦åˆ†é¡µï¼Œæ ‡é¢˜æ”¾åˆ°ä¸‹ä¸€é¡µ
                    if current_page_elements:
                        pages.append(self._elements_to_html(current_page_elements))
                        current_page_elements = []
                        current_height = 0
            
            # æ£€æŸ¥å½“å‰å…ƒç´ æ˜¯å¦è¶…å‡ºé¡µé¢é«˜åº¦
            if current_height + element_height > self.content_height:
                # æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ†å‰²å…ƒç´ 
                if element.type == 'paragraph' and element_height > self.content_height * 0.3:
                    # é•¿æ®µè½å¯ä»¥å°è¯•åˆ†å‰²
                    split_result = self._try_split_paragraph(element, self.content_height - current_height)
                    if split_result:
                        first_part, second_part = split_result
                        if first_part:
                            current_page_elements.append(first_part)
                        pages.append(self._elements_to_html(current_page_elements))
                        current_page_elements = [second_part] if second_part else []
                        current_height = second_part.height if second_part else 0
                    else:
                        # æ— æ³•åˆ†å‰²ï¼Œæ•´ä¸ªå…ƒç´ æ”¾åˆ°ä¸‹ä¸€é¡µ
                        if current_page_elements:
                            pages.append(self._elements_to_html(current_page_elements))
                        current_page_elements = [element]
                        current_height = element_height
                else:
                    # ä¸å¯åˆ†å‰²çš„å…ƒç´ æˆ–ä¸éœ€è¦åˆ†å‰²ï¼Œæ”¾åˆ°ä¸‹ä¸€é¡µ
                    if current_page_elements:
                        pages.append(self._elements_to_html(current_page_elements))
                    current_page_elements = [element]
                    current_height = element_height
            else:
                # å½“å‰å…ƒç´ å¯ä»¥æ”¾å…¥å½“å‰é¡µ
                current_page_elements.append(element)
                current_height += element_height
            
            i += 1
        
        # 3. ä¿å­˜æœ€åä¸€é¡µ
        if current_page_elements:
            pages.append(self._elements_to_html(current_page_elements))
        
        # 4. å¦‚æœæ²¡æœ‰ç”Ÿæˆä»»ä½•é¡µé¢ï¼Œè¿”å›åŸå§‹å†…å®¹
        if not pages:
            return [html_content]
        
        return pages
    
    def _elements_to_html(self, elements: List[PageElement]) -> str:
        """å°†å…ƒç´ åˆ—è¡¨è½¬æ¢å›HTMLå­—ç¬¦ä¸²"""
        html_parts = []
        for element in elements:
            if element.type != 'pagebreak':  # è·³è¿‡åˆ†é¡µæ ‡è®°
                html_parts.append(element.content)
        return '\n'.join(html_parts)
    
    def _try_split_paragraph(self, element: PageElement, available_height: int) -> Optional[Tuple[PageElement, PageElement]]:
        """
        å°è¯•åˆ†å‰²æ®µè½
        
        Args:
            element: è¦åˆ†å‰²çš„æ®µè½å…ƒç´ 
            available_height: å½“å‰é¡µå‰©ä½™é«˜åº¦
            
        Returns:
            åˆ†å‰²åçš„ä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœæ— æ³•åˆ†å‰²åˆ™è¿”å›None
        """
        # ç®€å•å®ç°ï¼šæš‚ä¸åˆ†å‰²æ®µè½ï¼Œä¿æŒæ®µè½å®Œæ•´æ€§
        # æœªæ¥å¯ä»¥å®ç°æ›´å¤æ‚çš„åˆ†å‰²é€»è¾‘
        return None
    
    def _calculate_text_height(self, text: str) -> int:
        """è®¡ç®—çº¯æ–‡æœ¬é«˜åº¦"""
        if not text:
            return 0
        
        # ä¼°ç®—æ–‡æœ¬è¡Œæ•°
        chars_per_line = self.content_width // self.CHAR_WIDTH
        total_chars = len(text)
        estimated_lines = max(1, (total_chars + chars_per_line - 1) // chars_per_line)
        
        return self.ELEMENT_HEIGHTS['p_base'] + estimated_lines * self.ELEMENT_HEIGHTS['p_line']
    
    def _calculate_paragraph_height(self, text: str) -> int:
        """è®¡ç®—æ®µè½é«˜åº¦"""
        if not text:
            return self.ELEMENT_HEIGHTS['p_base']
        
        # è€ƒè™‘ä¸­è‹±æ–‡æ··åˆ
        chinese_chars = len(re.findall(r'[\u4e00-\u9fff]', text))
        english_chars = len(text) - chinese_chars
        
        # è®¡ç®—å¹³å‡æ¯è¡Œå­—ç¬¦æ•°
        avg_char_width = (chinese_chars * self.CHAR_WIDTH + english_chars * self.CHAR_WIDTH_EN) / max(1, len(text))
        chars_per_line = self.content_width / avg_char_width
        
        # è®¡ç®—è¡Œæ•°
        lines = max(1, int(len(text) / chars_per_line) + 1)
        
        return self.ELEMENT_HEIGHTS['p_base'] + lines * self.ELEMENT_HEIGHTS['p_line'] + self.ELEMENT_HEIGHTS['margin_bottom']
    
    def _calculate_blockquote_height(self, text: str) -> int:
        """è®¡ç®—å¼•ç”¨å—é«˜åº¦"""
        if not text:
            return self.ELEMENT_HEIGHTS['blockquote']
        
        # å¼•ç”¨å—å†…å®¹å®½åº¦æ›´çª„
        effective_width = self.content_width - 60  # å‡å»å·¦è¾¹æ¡†å’Œå†…è¾¹è·
        chars_per_line = effective_width // self.CHAR_WIDTH
        lines = max(1, (len(text) + chars_per_line - 1) // chars_per_line)
        
        return self.ELEMENT_HEIGHTS['blockquote'] + lines * self.ELEMENT_HEIGHTS['blockquote_line'] + self.ELEMENT_HEIGHTS['margin_bottom']
    
    def parse_html_to_elements(self, html: str) -> List[PageElement]:
        """
        å°†HTMLè§£æä¸ºé¡µé¢å…ƒç´ åˆ—è¡¨ï¼Œä¿æŒåŸå§‹é¡ºåº
        æ”¹è¿›ç‰ˆï¼šä½¿ç”¨æ·±åº¦ä¼˜å…ˆéå†ï¼Œç¡®ä¿æ‰€æœ‰åˆ†é¡µæ ‡è®°éƒ½è¢«è¯†åˆ«
        """
        elements = []
        
        # ä½¿ç”¨BeautifulSoupè§£æHTML
        soup = BeautifulSoup(html, 'html.parser')
        
        # æ·±åº¦ä¼˜å…ˆéå†æ‰€æœ‰å…ƒç´ ï¼Œæ‰å¹³åŒ–å¤„ç†
        elements = self._flatten_parse(soup)
        
        return elements
    
    def _flatten_parse(self, node) -> List[PageElement]:
        """
        æ‰å¹³åŒ–è§£ææ‰€æœ‰èŠ‚ç‚¹ï¼Œç¡®ä¿åˆ†é¡µæ ‡è®°è¢«æ­£ç¡®è¯†åˆ«
        è¿™ä¸ªæ–¹æ³•ä¼šéå†æ•´ä¸ªDOMæ ‘ï¼Œå°†æ‰€æœ‰å†…å®¹æ‰å¹³åŒ–ä¸ºå…ƒç´ åˆ—è¡¨
        """
        elements = []
        
        # å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹
        if isinstance(node, NavigableString):
            # è·³è¿‡æ³¨é‡Šå’Œç©ºç™½æ–‡æœ¬
            if not isinstance(node, Comment):
                text = str(node).strip()
                if text:
                    elements.append(PageElement(
                        type='text',
                        content=f'<p>{text}</p>',
                        text=text,
                        height=self._calculate_text_height(text),
                        can_break=True
                    ))
            return elements
        
        # å¦‚æœä¸æ˜¯Tagï¼Œè¿”å›ç©ºåˆ—è¡¨
        if not isinstance(node, Tag):
            return elements
        
        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯åˆ†é¡µæ ‡è®°
        if self._is_pagebreak_marker(node):
            elements.append(PageElement(
                type='pagebreak',
                content='',
                text='',
                height=0,
                can_break=True,
                level=999,
                is_forced_break=True  # æ ‡è®°ä¸ºå¼ºåˆ¶åˆ†é¡µ
            ))
            return elements
        
        # å¤„ç†å…·ä½“çš„å…ƒç´ ç±»å‹
        tag_name = node.name.lower()
        
        # å¤„ç†å—çº§å…ƒç´ 
        if tag_name in ['h1', 'h2', 'h3', 'h4', 'h5', 'h6']:
            # æ ‡é¢˜å…ƒç´ 
            level = int(tag_name[1])
            text = node.get_text(strip=True)
            height = self.ELEMENT_HEIGHTS[tag_name] + self.ELEMENT_HEIGHTS['margin_bottom']
            
            elements.append(PageElement(
                type='heading',
                content=str(node),
                text=text,
                level=level,
                height=height,
                can_break=False
            ))
            
        elif tag_name == 'p':
            # æ®µè½å…ƒç´  - éœ€è¦æ£€æŸ¥å†…éƒ¨æ˜¯å¦æœ‰åˆ†é¡µæ ‡è®°
            has_pagebreak = False
            sub_elements = []
            
            # æ£€æŸ¥æ®µè½å†…éƒ¨çš„æ‰€æœ‰å­èŠ‚ç‚¹
            for child in node.children:
                if isinstance(child, Tag) and self._is_pagebreak_marker(child):
                    has_pagebreak = True
                    # å¦‚æœæ®µè½å†…æœ‰åˆ†é¡µæ ‡è®°ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                    # å…ˆä¿å­˜åˆ†é¡µæ ‡è®°å‰çš„å†…å®¹
                    text_before = ''.join(str(c) for c in list(node.children)[:list(node.children).index(child)])
                    if text_before.strip():
                        sub_elements.append(PageElement(
                            type='paragraph',
                            content=f'<p>{text_before}</p>',
                            text=text_before,
                            height=self._calculate_paragraph_height(text_before),
                            can_break=True
                        ))
                    # æ·»åŠ åˆ†é¡µæ ‡è®°
                    sub_elements.append(PageElement(
                        type='pagebreak',
                        content='',
                        text='',
                        height=0,
                        can_break=True,
                        level=999,
                        is_forced_break=True
                    ))
            
            if has_pagebreak:
                elements.extend(sub_elements)
            else:
                # æ­£å¸¸çš„æ®µè½
                text = node.get_text(strip=True)
                if text:
                    height = self._calculate_paragraph_height(text)
                    elements.append(PageElement(
                        type='paragraph',
                        content=str(node),
                        text=text,
                        height=height,
                        can_break=True
                    ))
                    
        elif tag_name in ['ul', 'ol']:
            # åˆ—è¡¨å…ƒç´ 
            items = node.find_all('li')
            text = node.get_text(strip=True)
            height = len(items) * self.ELEMENT_HEIGHTS['li'] + self.ELEMENT_HEIGHTS['margin_bottom']
            
            elements.append(PageElement(
                type='list',
                content=str(node),
                text=text,
                height=height,
                can_break=len(items) > 3
            ))
            
        elif tag_name == 'pre':
            # ä»£ç å—
            text = node.get_text()
            lines = text.count('\n') + 1
            height = (self.ELEMENT_HEIGHTS['code_block'] + 
                    lines * self.ELEMENT_HEIGHTS['code_line'] +
                    self.ELEMENT_HEIGHTS['margin_bottom'])
            
            elements.append(PageElement(
                type='code',
                content=str(node),
                text=text,
                height=height,
                can_break=lines > 10
            ))
            
        elif tag_name == 'blockquote':
            # å¼•ç”¨å—
            text = node.get_text(strip=True)
            height = self._calculate_blockquote_height(text)
            
            elements.append(PageElement(
                type='blockquote',
                content=str(node),
                text=text,
                height=height,
                can_break=True
            ))
            
        elif tag_name == 'table':
            # è¡¨æ ¼
            rows = node.find_all('tr')
            headers = node.find_all('th')
            text = node.get_text(strip=True)
            
            height = (len(headers) * self.ELEMENT_HEIGHTS['table_header'] +
                    (len(rows) - len(headers)) * self.ELEMENT_HEIGHTS['table_row'] +
                    self.ELEMENT_HEIGHTS['margin_bottom'])
            
            elements.append(PageElement(
                type='table',
                content=str(node),
                text=text,
                height=height,
                can_break=len(rows) > 5
            ))
            
        elif tag_name == 'hr':
            # åˆ†éš”çº¿
            elements.append(PageElement(
                type='hr',
                content=str(node),
                text='',
                height=self.ELEMENT_HEIGHTS['hr'],
                can_break=True
            ))
            
        elif tag_name in ['div', 'section', 'article', 'main', 'aside', 'nav', 'header', 'footer']:
            # å®¹å™¨å…ƒç´  - é€’å½’å¤„ç†å­å…ƒç´ 
            for child in node.children:
                elements.extend(self._flatten_parse(child))
                
        else:
            # å…¶ä»–å…ƒç´  - é€’å½’å¤„ç†å­å…ƒç´ 
            # ä½†é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å®é™…å†…å®¹
            text = node.get_text(strip=True)
            if text:
                # æ£€æŸ¥å­å…ƒç´ ä¸­æ˜¯å¦æœ‰åˆ†é¡µæ ‡è®°
                for child in node.children:
                    child_elements = self._flatten_parse(child)
                    if child_elements:
                        elements.extend(child_elements)
                
                # å¦‚æœæ²¡æœ‰å­å…ƒç´ è¢«è§£æï¼Œåˆ™å°†æ•´ä¸ªå…ƒç´ ä½œä¸ºæ–‡æœ¬å¤„ç†
                if not elements:
                    elements.append(PageElement(
                        type='text',
                        content=str(node),
                        text=text,
                        height=self._calculate_text_height(text),
                        can_break=True
                    ))
            else:
                # é€’å½’å¤„ç†å­å…ƒç´ 
                for child in node.children:
                    elements.extend(self._flatten_parse(child))
        
        return elements
    
    def _is_pagebreak_marker(self, element: Tag) -> bool:
        """
        æ£€æŸ¥å…ƒç´ æ˜¯å¦æ˜¯åˆ†é¡µæ ‡è®°
        æ”¯æŒå¤šç§è¯†åˆ«æ–¹å¼
        """
        if not isinstance(element, Tag):
            return False
            
        # æ£€æŸ¥æ˜¯å¦æ˜¯å¸¦æœ‰ç‰¹å®šclassçš„div
        if element.name.lower() == 'div':
            classes = element.get('class', [])
            if isinstance(classes, str):
                classes = classes.split()
            
            # æ£€æŸ¥classå
            if 'pagebreak-marker' in classes:
                return True
            
            # æ£€æŸ¥dataå±æ€§
            if element.get('data-pagebreak') == 'true':
                return True
        
        return False
    
    def optimize_pages(self, pages: List[str]) -> List[str]:
        """
        ä¼˜åŒ–åˆ†é¡µç»“æœï¼Œåˆå¹¶è¿‡çŸ­çš„é¡µé¢
        ä¿®æ”¹ï¼šä¿ç•™é€šè¿‡åˆ†é¡µç¬¦åˆ›å»ºçš„é¡µé¢ï¼Œå³ä½¿æ˜¯ç©ºé¡µ
        """
        if len(pages) <= 1:
            return pages
        
        optimized = []
        i = 0
        
        # æ ¹æ®é¡µé¢å°ºå¯¸è°ƒæ•´åˆå¹¶é˜ˆå€¼
        merge_threshold = 0.35 if self.page_size_name == "small" else 0.4
        
        while i < len(pages):
            current_page = pages[i]
            
            # æ£€æŸ¥å½“å‰é¡µæ˜¯å¦æ˜¯é€šè¿‡åˆ†é¡µç¬¦åˆ›å»ºçš„
            is_forced_page = i in self.forced_break_pages
            
            # å¦‚æœæ˜¯å¼ºåˆ¶åˆ†é¡µåˆ›å»ºçš„é¡µé¢ï¼Œç›´æ¥ä¿ç•™ï¼ˆå³ä½¿æ˜¯ç©ºé¡µï¼‰
            if is_forced_page:
                optimized.append(current_page)
                i += 1
                continue
            
            # éå¼ºåˆ¶åˆ†é¡µçš„é¡µé¢ï¼Œè¿›è¡Œå¸¸è§„ä¼˜åŒ–
            # è¿‡æ»¤æ‰å®Œå…¨ç©ºçš„é¡µé¢
            if not current_page or not current_page.strip():
                i += 1
                continue
            
            # ä¼°ç®—å½“å‰é¡µé¢é«˜åº¦
            current_elements = self.parse_html_to_elements(current_page)
            current_height = sum(e.height for e in current_elements)
            
            # å¦‚æœé¡µé¢è¿‡çŸ­ï¼Œå°è¯•ä¸ä¸‹ä¸€é¡µåˆå¹¶ï¼ˆä½†ä¸åˆå¹¶å¼ºåˆ¶åˆ†é¡µçš„é¡µé¢ï¼‰
            if current_height < self.content_height * merge_threshold and i < len(pages) - 1:
                next_page_index = i + 1
                # æ£€æŸ¥ä¸‹ä¸€é¡µæ˜¯å¦æ˜¯å¼ºåˆ¶åˆ†é¡µ
                if next_page_index not in self.forced_break_pages:
                    next_page = pages[next_page_index]
                    if next_page and next_page.strip():  # ç¡®ä¿ä¸‹ä¸€é¡µæœ‰å†…å®¹
                        next_elements = self.parse_html_to_elements(next_page)
                        next_height = sum(e.height for e in next_elements)
                        
                        # å¦‚æœåˆå¹¶åä¸è¶…è¿‡æœ€å¤§é«˜åº¦ï¼Œåˆ™åˆå¹¶
                        if current_height + next_height <= self.content_height:
                            optimized.append(current_page + next_page)
                            i += 2  # è·³è¿‡ä¸‹ä¸€é¡µ
                            continue
            
            optimized.append(current_page)
            i += 1
        
        # å¦‚æœä¼˜åŒ–åæ²¡æœ‰é¡µé¢ï¼Œè‡³å°‘è¿”å›ä¸€ä¸ªé¡µé¢
        return optimized if optimized else ['']
    
    def debug_pagination(self, html_content: str) -> List[dict]:
        """è°ƒè¯•åˆ†é¡µï¼Œè¿”å›è¯¦ç»†ä¿¡æ¯"""
        elements = self.parse_html_to_elements(html_content)
        pages_info = []
        
        pages = self.paginate(html_content)
        for i, page in enumerate(pages, 1):
            page_elements = self.parse_html_to_elements(page)
            total_height = sum(e.height for e in page_elements)
            
            pages_info.append({
                'page_num': i,
                'page_size': self.page_size_name,
                'content_dimensions': f"{self.content_width}Ã—{self.content_height}px",
                'elements_count': len(page_elements),
                'total_height': total_height,
                'max_height': self.content_height,
                'fill_rate': f"{(total_height / self.content_height * 100):.1f}%",
                'is_forced_break': (i-1) in self.forced_break_pages,  # æ ‡è®°æ˜¯å¦æ˜¯å¼ºåˆ¶åˆ†é¡µ
                'elements': [
                    {
                        'type': e.type,
                        'height': e.height,
                        'text_preview': e.text[:50] + '...' if len(e.text) > 50 else e.text
                    }
                    for e in page_elements
                ]
            })
        
        return pages_info style_manager.py->text/plain-># ============================================
# src/utils/style_manager.py
# ============================================
from typing import Dict, Any, Tuple
from dataclasses import dataclass
import colorsys

@dataclass
class ThemeConfig:
    """ä¸»é¢˜é…ç½®"""
    name: str
    primary_color: str
    secondary_color: str
    text_color: str
    background: str
    font_family: str
    heading_font: str
    code_font: str
    accent_color: str = ""  # å¼ºè°ƒè‰²
    link_color: str = ""    # é“¾æ¥è‰²
    
class StyleManager:
    """æ ·å¼ç®¡ç†å™¨ - æ‰©å±•ç‰ˆ"""
    
    # é¢„è®¾ä¸»é¢˜ - 12ç§é£æ ¼
    THEMES = {
        # ç¤¾äº¤åª’ä½“é£æ ¼
        "xiaohongshu": ThemeConfig(
            name="å°çº¢ä¹¦ç»å…¸",
            primary_color="#FF2442",
            secondary_color="#FF6B6B",
            text_color="#2c3e50",
            background="linear-gradient(135deg, #ffeef8 0%, #ffe0f0 100%)",
            font_family='-apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", "Microsoft YaHei", sans-serif',
            heading_font='"PingFang SC", "Helvetica Neue", sans-serif',
            code_font='"JetBrains Mono", "Cascadia Code", "Consolas", monospace',
            accent_color="#FFB6C1",
            link_color="#FF69B4"
        ),
        
        "instagram": ThemeConfig(
            name="Instagramæ¸å˜",
            primary_color="#E4405F",
            secondary_color="#BC2A8D",
            text_color="#262626",
            background="linear-gradient(45deg, #F9ED69 0%, #EE2A7B 50%, #6228D7 100%)",
            font_family='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
            heading_font='"Segoe UI", Roboto, sans-serif',
            code_font='"Monaco", "Courier New", monospace',
            accent_color="#FCAF45",
            link_color="#833AB4"
        ),
        
        "wechat": ThemeConfig(
            name="å¾®ä¿¡ç®€çº¦",
            primary_color="#07C160",
            secondary_color="#4CAF50",
            text_color="#353535",
            background="linear-gradient(180deg, #F7F7F7 0%, #FFFFFF 100%)",
            font_family='"PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif',
            heading_font='"PingFang SC", "Microsoft YaHei", sans-serif',
            code_font='"SF Mono", "Monaco", "Inconsolata", monospace',
            accent_color="#95EC69",
            link_color="#576B95"
        ),
        
        "douyin": ThemeConfig(
            name="æŠ–éŸ³é…·é»‘",
            primary_color="#FE2C55",
            secondary_color="#25F4EE",
            text_color="#FFFFFF",
            background="linear-gradient(135deg, #000000 0%, #161823 100%)",
            font_family='"PingFang SC", "Helvetica Neue", Arial, sans-serif',
            heading_font='"PingFang SC", "Helvetica Neue", sans-serif',
            code_font='"Fira Code", "Source Code Pro", monospace',
            accent_color="#00F2EA",
            link_color="#FE2C55"
        ),
        
        # çŸ¥è¯†å¹³å°é£æ ¼
        "zhihu": ThemeConfig(
            name="çŸ¥ä¹è“",
            primary_color="#0084FF",
            secondary_color="#1890FF",
            text_color="#1A1A1A",
            background="linear-gradient(180deg, #FFFFFF 0%, #F6F6F6 100%)",
            font_family='"PingFang SC", "Helvetica Neue", "Microsoft YaHei", sans-serif',
            heading_font='"PingFang SC", "Helvetica Neue", sans-serif',
            code_font='"Source Code Pro", "Consolas", monospace',
            accent_color="#5BBCFF",
            link_color="#175199"
        ),
        
        "notion": ThemeConfig(
            name="Notionæç®€",
            primary_color="#000000",
            secondary_color="#2F3437",
            text_color="#37352F",
            background="linear-gradient(180deg, #FFFFFF 0%, #FAFAFA 100%)",
            font_family='"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
            heading_font='"Inter", -apple-system, sans-serif',
            code_font='"SFMono-Regular", "Consolas", "Liberation Mono", monospace',
            accent_color="#EB5757",
            link_color="#0070F3"
        ),
        
        # ä¼˜é›…é£æ ¼
        "elegant_purple": ThemeConfig(
            name="ä¼˜é›…ç´«",
            primary_color="#6B46C1",
            secondary_color="#9333EA",
            text_color="#1F2937",
            background="linear-gradient(135deg, #F9FAFB 0%, #F3E8FF 100%)",
            font_family='"Inter", "PingFang SC", "Microsoft YaHei", sans-serif',
            heading_font='"Playfair Display", "PingFang SC", serif',
            code_font='"JetBrains Mono", "Cascadia Code", monospace',
            accent_color="#A78BFA",
            link_color="#7C3AED"
        ),
        
        "ocean_blue": ThemeConfig(
            name="æµ·æ´‹è“",
            primary_color="#0EA5E9",
            secondary_color="#06B6D4",
            text_color="#0F172A",
            background="linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 50%, #BAE6FD 100%)",
            font_family='"Inter", "PingFang SC", "Microsoft YaHei", sans-serif',
            heading_font='"Inter", "PingFang SC", sans-serif',
            code_font='"Fira Code", "Consolas", monospace',
            accent_color="#38BDF8",
            link_color="#0284C7"
        ),
        
        "sunset_orange": ThemeConfig(
            name="æ—¥è½æ©™",
            primary_color="#F97316",
            secondary_color="#FB923C",
            text_color="#1C1917",
            background="linear-gradient(135deg, #FFF7ED 0%, #FED7AA 50%, #FDBA74 100%)",
            font_family='"Inter", "PingFang SC", "Microsoft YaHei", sans-serif',
            heading_font='"Inter", "PingFang SC", sans-serif',
            code_font='"Source Code Pro", "Monaco", monospace',
            accent_color="#FCD34D",
            link_color="#EA580C"
        ),
        
        "forest_green": ThemeConfig(
            name="æ£®æ—ç»¿",
            primary_color="#059669",
            secondary_color="#10B981",
            text_color="#064E3B",
            background="linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 50%, #A7F3D0 100%)",
            font_family='"Inter", "PingFang SC", "Microsoft YaHei", sans-serif',
            heading_font='"Inter", "PingFang SC", sans-serif',
            code_font='"JetBrains Mono", monospace',
            accent_color="#34D399",
            link_color="#047857"
        ),
        
        # æ·±è‰²ä¸»é¢˜
        "dark_mode": ThemeConfig(
            name="æ·±è‰²æ¨¡å¼",
            primary_color="#00E0FF",
            secondary_color="#0096FF",
            text_color="#E0E6ED",
            background="linear-gradient(135deg, #0F0F1E 0%, #1A1A2E 50%, #16213E 100%)",
            font_family='"Inter", "PingFang SC", "Microsoft YaHei", sans-serif',
            heading_font='"Inter", "PingFang SC", sans-serif',
            code_font='"Fira Code", "JetBrains Mono", monospace',
            accent_color="#00F0FF",
            link_color="#00B8D4"
        ),
        
        "midnight": ThemeConfig(
            name="åˆå¤œç´«",
            primary_color="#B794F4",
            secondary_color="#9F7AEA",
            text_color="#E9D8FD",
            background="linear-gradient(135deg, #1A202C 0%, #2D3748 50%, #4A5568 100%)",
            font_family='"Inter", "PingFang SC", "Microsoft YaHei", sans-serif',
            heading_font='"Inter", "PingFang SC", sans-serif',
            code_font='"Cascadia Code", "Fira Code", monospace',
            accent_color="#D6BCFA",
            link_color="#B794F4"
        )
    }
    
    def __init__(self, theme: str = "xiaohongshu"):
        self.current_theme = theme
        self.custom_styles = {}
        
    def get_theme(self, theme_name: str = None) -> ThemeConfig:
        """è·å–ä¸»é¢˜é…ç½®"""
        if theme_name is None:
            theme_name = self.current_theme
        return self.THEMES.get(theme_name, self.THEMES["xiaohongshu"])
    
    def get_theme_list(self) -> list:
        """è·å–æ‰€æœ‰ä¸»é¢˜åˆ—è¡¨"""
        return list(self.THEMES.keys())
    
    def get_theme_display_names(self) -> Dict[str, str]:
        """è·å–ä¸»é¢˜æ˜¾ç¤ºåç§°"""
        return {key: theme.name for key, theme in self.THEMES.items()}
    
    def set_theme(self, theme_name: str):
        """è®¾ç½®å½“å‰ä¸»é¢˜"""
        if theme_name in self.THEMES:
            self.current_theme = theme_name
    
    def hex_to_rgb(self, hex_color: str) -> Tuple[int, int, int]:
        """åå…­è¿›åˆ¶é¢œè‰²è½¬RGB"""
        hex_color = hex_color.lstrip('#')
        return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
    
    def rgb_to_hex(self, r: int, g: int, b: int) -> str:
        """RGBè½¬åå…­è¿›åˆ¶"""
        return f"#{r:02x}{g:02x}{b:02x}"
    
    def lighten_color(self, hex_color: str, amount: float) -> str:
        """ä½¿é¢œè‰²å˜æµ…ï¼ˆamount: 0-1ï¼‰"""
        r, g, b = self.hex_to_rgb(hex_color)
        # è½¬æ¢ä¸ºHSL
        h, l, s = colorsys.rgb_to_hls(r/255, g/255, b/255)
        # å¢åŠ äº®åº¦
        l = min(1.0, l + (1 - l) * amount)
        # è½¬å›RGB
        r, g, b = colorsys.hls_to_rgb(h, l, s)
        return self.rgb_to_hex(int(r*255), int(g*255), int(b*255))
    
    def darken_color(self, hex_color: str, amount: float) -> str:
        """ä½¿é¢œè‰²å˜æ·±ï¼ˆamount: 0-1ï¼‰"""
        r, g, b = self.hex_to_rgb(hex_color)
        # è½¬æ¢ä¸ºHSL
        h, l, s = colorsys.rgb_to_hls(r/255, g/255, b/255)
        # é™ä½äº®åº¦
        l = max(0.0, l * (1 - amount))
        # è½¬å›RGB
        r, g, b = colorsys.hls_to_rgb(h, l, s)
        return self.rgb_to_hex(int(r*255), int(g*255), int(b*255))
    
    def add_alpha(self, hex_color: str, alpha: float) -> str:
        """æ·»åŠ é€æ˜åº¦ï¼ˆè¿”å›rgbaæ ¼å¼ï¼‰"""
        r, g, b = self.hex_to_rgb(hex_color)
        return f"rgba({r}, {g}, {b}, {alpha})"
    
    def generate_css(self, theme_name: str = None, font_size: int = 18) -> str:
        """ç”Ÿæˆä¸»é¢˜CSS"""
        theme = self.get_theme(theme_name)
        
        # ç”Ÿæˆæ´¾ç”Ÿé¢œè‰²
        primary_light = self.lighten_color(theme.primary_color, 0.9)
        primary_dark = self.darken_color(theme.primary_color, 0.2)
        secondary_light = self.lighten_color(theme.secondary_color, 0.9)
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæ·±è‰²ä¸»é¢˜
        is_dark = theme_name in ["dark_mode", "midnight", "douyin"]
        
        return f"""
        /* ä¸»é¢˜: {theme.name} */
        :root {{
            --primary-color: {theme.primary_color};
            --secondary-color: {theme.secondary_color};
            --accent-color: {theme.accent_color or theme.secondary_color};
            --text-color: {theme.text_color};
            --link-color: {theme.link_color or theme.primary_color};
            --font-family: {theme.font_family};
            --heading-font: {theme.heading_font};
            --code-font: {theme.code_font};
            --primary-light: {primary_light};
            --primary-dark: {primary_dark};
            --secondary-light: {secondary_light};
            --base-font-size: {font_size}px;
        }}
        
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: var(--font-family);
            background: {theme.background};
            color: var(--text-color);
            font-size: var(--base-font-size);
            line-height: 1.85;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }}
        
        /* æ ‡é¢˜æ ·å¼ */
        h1, h2, h3, h4, h5, h6 {{
            font-family: var(--heading-font);
            color: var(--primary-color);
            font-weight: 700;
            letter-spacing: -0.02em;
        }}
        
        h1 {{
            font-size: calc(var(--base-font-size) + 16px);
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 3px solid {self.add_alpha(theme.primary_color, 0.2)};
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }}
        
        h2 {{
            font-size: calc(var(--base-font-size) + 10px);
            margin-top: 38px;
            margin-bottom: 22px;
            position: relative;
            padding-left: 20px;
        }}
        
        h2::before {{
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 5px;
            height: 24px;
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
            box-shadow: 0 2px 8px {self.add_alpha(theme.primary_color, 0.3)};
        }}
        
        h3 {{
            font-size: calc(var(--base-font-size) + 5px);
            margin-top: 30px;
            margin-bottom: 18px;
            color: {theme.text_color if not is_dark else theme.secondary_color};
        }}
        
        /* æ®µè½æ ·å¼ */
        p {{
            margin-bottom: 22px;
            font-size: var(--base-font-size);
            color: var(--text-color);
            text-align: justify;
            line-height: 1.85;
        }}
        
        /* å¼ºè°ƒæ ·å¼ */
        strong {{
            color: var(--primary-color);
            font-weight: 600;
            background: linear-gradient(180deg, transparent 70%, {self.add_alpha(theme.primary_color, 0.2)} 70%);
            padding: 0 4px;
            border-radius: 2px;
        }}
        
        em {{
            font-style: italic;
            color: {self.darken_color(theme.text_color, 0.2) if not is_dark else self.lighten_color(theme.text_color, 0.2)};
        }}
        
        /* åˆ—è¡¨æ ·å¼ */
        ul, ol {{
            margin: 24px 0;
            padding-left: 38px;
        }}
        
        li {{
            margin-bottom: 16px;
            font-size: var(--base-font-size);
            color: var(--text-color);
            line-height: 1.85;
            position: relative;
        }}
        
        ul li::marker {{
            color: var(--primary-color);
            font-size: calc(var(--base-font-size) + 2px);
        }}
        
        ol li::marker {{
            color: var(--primary-color);
            font-weight: 600;
        }}
        
        /* å¼•ç”¨æ ·å¼ */
        blockquote {{
            border-left: 4px solid var(--primary-color);
            margin: 28px 0;
            padding: 20px 28px;
            background: {self.add_alpha(theme.primary_color, 0.05) if not is_dark else self.add_alpha(theme.primary_color, 0.1)};
            border-radius: 10px;
            position: relative;
            box-shadow: 0 4px 15px {self.add_alpha(theme.primary_color, 0.1)};
        }}
        
        blockquote::before {{
            content: '"';
            position: absolute;
            top: -10px;
            left: 24px;
            font-size: 48px;
            color: {self.add_alpha(theme.primary_color, 0.3)};
            font-family: Georgia, serif;
            font-weight: bold;
        }}
        
        blockquote p {{
            color: {self.darken_color(theme.text_color, 0.1) if not is_dark else self.lighten_color(theme.text_color, 0.1)};
            font-style: italic;
            margin-bottom: 0;
            font-size: calc(var(--base-font-size) - 1px);
        }}
        
        /* è¡Œå†…ä»£ç  */
        code {{
            background: {self.add_alpha(theme.primary_color, 0.1)};
            padding: 4px 10px;
            border-radius: 6px;
            font-family: var(--code-font);
            font-size: calc(var(--base-font-size) - 2px);
            color: {theme.primary_color if not is_dark else theme.accent_color};
            font-weight: 500;
            border: 1px solid {self.add_alpha(theme.primary_color, 0.2)};
        }}
        
        /* ä»£ç å— */
        pre {{
            background: {('#1e1e1e' if not is_dark else '#0a0a0f')};
            color: #d4d4d4;
            padding: 26px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 28px 0;
            box-shadow: 0 8px 24px {self.add_alpha('#000000', 0.15)};
            position: relative;
            border: 1px solid {self.add_alpha(theme.primary_color, 0.2)};
        }}
        
        pre::before {{
            content: "CODE";
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 11px;
            color: {self.add_alpha(theme.text_color, 0.5)};
            font-weight: 600;
            letter-spacing: 1px;
            font-family: var(--font-family);
        }}
        
        pre code {{
            background: none;
            color: #d4d4d4;
            padding: 0;
            font-size: calc(var(--base-font-size) - 3px);
            line-height: 1.7;
            border: none;
        }}
        
        /* è¡¨æ ¼æ ·å¼ */
        table {{
            width: 100%;
            border-collapse: collapse;
            margin: 28px 0;
            font-size: calc(var(--base-font-size) - 1px);
            box-shadow: 0 4px 15px {self.add_alpha(theme.primary_color, 0.08)};
            border-radius: 10px;
            overflow: hidden;
        }}
        
        th {{
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            font-size: calc(var(--base-font-size) - 1px);
            letter-spacing: 0.5px;
        }}
        
        td {{
            padding: 15px 20px;
            border-bottom: 1px solid {self.add_alpha(theme.text_color, 0.1)};
            color: var(--text-color);
        }}
        
        tr:nth-child(even) {{
            background: {self.add_alpha(theme.primary_color, 0.03)};
        }}
        
        tr:hover {{
            background: {self.add_alpha(theme.primary_color, 0.08)};
            transition: background 0.3s ease;
        }}
        
        tr:last-child td {{
            border-bottom: none;
        }}
        
        /* åˆ†éš”çº¿ */
        hr {{
            border: none;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                {self.add_alpha(theme.primary_color, 0.3)} 20%, 
                {self.add_alpha(theme.primary_color, 0.3)} 80%, 
                transparent);
            margin: 38px 0;
            position: relative;
        }}
        
        hr::after {{
            content: "âœ¦";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: {theme.background.split('(')[0] + '(180deg, #FFFFFF 0%, #FFFFFF 100%)' if 'gradient' in theme.background else '#FFFFFF'};
            color: var(--primary-color);
            padding: 0 10px;
            font-size: 20px;
        }}
        
        /* é“¾æ¥æ ·å¼ */
        a {{
            color: var(--link-color);
            text-decoration: none;
            border-bottom: 2px solid {self.add_alpha(theme.link_color or theme.primary_color, 0.3)};
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: 1px;
            position: relative;
        }}
        
        a:hover {{
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            background: {self.add_alpha(theme.primary_color, 0.08)};
            padding: 2px 6px;
            margin: -2px -6px;
            border-radius: 4px;
        }}
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {{
            from {{
                opacity: 0;
                transform: translateY(10px);
            }}
            to {{
                opacity: 1;
                transform: translateY(0);
            }}
        }}
        
        .content > * {{
            animation: fadeIn 0.5s ease-out backwards;
        }}
        
        .content > *:nth-child(1) {{ animation-delay: 0.05s; }}
        .content > *:nth-child(2) {{ animation-delay: 0.1s; }}
        .content > *:nth-child(3) {{ animation-delay: 0.15s; }}
        .content > *:nth-child(4) {{ animation-delay: 0.2s; }}
        .content > *:nth-child(5) {{ animation-delay: 0.25s; }}
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {{
            width: 8px;
            height: 8px;
        }}
        
        ::-webkit-scrollbar-track {{
            background: {self.add_alpha(theme.text_color, 0.05)};
            border-radius: 4px;
        }}
        
        ::-webkit-scrollbar-thumb {{
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
        }}
        
        ::-webkit-scrollbar-thumb:hover {{
            background: linear-gradient(180deg, var(--secondary-color), var(--primary-color));
        }}
        """
    
    def get_export_settings(self, theme_name: str = None) -> Dict[str, Any]:
        """è·å–å¯¼å‡ºè®¾ç½®"""
        theme = self.get_theme(theme_name)
        
        return {
            "theme_name": theme.name,
            "page_width": 1080,
            "page_height": 1440,
            "padding": {
                "top": 45,
                "bottom": 45,
                "left": 40,
                "right": 40
            },
            "font_size": 16,
            "line_height": 1.8,
            "paragraph_spacing": 20,
            "image_quality": 100,
            "format": "PNG",
            "colors": {
                "primary": theme.primary_color,
                "secondary": theme.secondary_color,
                "text": theme.text_color,
                "background": theme.background
            }
        }
    
    def apply_custom_styles(self, styles: Dict[str, str]):
        """åº”ç”¨è‡ªå®šä¹‰æ ·å¼"""
        self.custom_styles.update(styles)
    
    def get_combined_css(self, theme_name: str = None, font_size: int = 18) -> str:
        """è·å–ç»„åˆçš„CSSï¼ˆä¸»é¢˜ + è‡ªå®šä¹‰ï¼‰"""
        base_css = self.generate_css(theme_name, font_size)
        
        if self.custom_styles:
            custom_css = "\n/* è‡ªå®šä¹‰æ ·å¼ */\n"
            for selector, rules in self.custom_styles.items():
                custom_css += f"{selector} {{\n{rules}\n}}\n"
            return base_css + custom_css
        
        return base_css html_generator.py->text/plain-># ============================================
# src/core/html_generator.py
# ============================================
from pathlib import Path
from typing import Optional
from src.utils.style_manager import StyleManager

class HTMLGenerator:
    def __init__(self, font_size: int = 18, page_size: str = "medium", theme: str = "xiaohongshu"):
        self.resource_path = Path(__file__).parent.parent / "resources"
        self.base_font_size = font_size  # åŸºç¡€å­—ä½“å¤§å°ï¼Œé»˜è®¤18px
        
        # é¡µé¢å°ºå¯¸é…ç½®
        self.page_sizes = {
            "small": {"width": 720, "height": 960},
            "medium": {"width": 1080, "height": 1440},
            "large": {"width": 1440, "height": 1920}
        }
        self.current_size = page_size
        self.page_width = self.page_sizes[page_size]["width"]
        self.page_height = self.page_sizes[page_size]["height"]
        
        # æ ·å¼ç®¡ç†å™¨
        self.style_manager = StyleManager(theme)
        self.current_theme = theme
        
    def set_page_size(self, size: str):
        """è®¾ç½®é¡µé¢å°ºå¯¸"""
        if size in self.page_sizes:
            self.current_size = size
            self.page_width = self.page_sizes[size]["width"]
            self.page_height = self.page_sizes[size]["height"]
    
    def set_theme(self, theme: str):
        """è®¾ç½®ä¸»é¢˜"""
        self.current_theme = theme
        self.style_manager.set_theme(theme)
    
    def set_font_size(self, size: int):
        """è®¾ç½®åŸºç¡€å­—ä½“å¤§å°"""
        self.base_font_size = size
        
    def generate(self, content: str, page_num: int = 0, total_pages: int = 0) -> str:
        """
        ç”Ÿæˆå®Œæ•´çš„ HTML é¡µé¢
        
        Args:
            content: HTMLå†…å®¹
            page_num: å½“å‰é¡µç ï¼ˆ0è¡¨ç¤ºä¸æ˜¾ç¤ºï¼‰
            total_pages: æ€»é¡µæ•°
        """
        # ç”Ÿæˆä¸»é¢˜CSS
        theme_css = self.style_manager.generate_css(self.current_theme, self.base_font_size)
        
        # ç”Ÿæˆé¡µé¢ç‰¹å®šCSS
        page_css = self.get_page_css()
        
        # è·å–JavaScript
        js = self.get_js()
        
        # ç”Ÿæˆé¡µç ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
        page_info = ""
        if page_num > 0 and total_pages > 1:
            page_info = f"""
            <div class="page-info">
                <span class="page-number">{page_num}</span>
                <span class="page-separator">/</span>
                <span class="page-total">{total_pages}</span>
            </div>
            """
        
        html = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦å¡ç‰‡ - {self.style_manager.get_theme().name}</title>
    <style>
        {theme_css}
        {page_css}
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="content" id="content">
                {content}
            </div>
            {page_info}
        </div>
    </div>
    <script>{js}</script>
</body>
</html>
"""
        return html
    
    def get_page_css(self) -> str:
        """è·å–é¡µé¢å¸ƒå±€CSS"""
        theme = self.style_manager.get_theme()
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæ·±è‰²ä¸»é¢˜
        is_dark = self.current_theme in ["dark_mode", "midnight", "douyin"]
        
        return f"""
        /* é¡µé¢å¸ƒå±€ */
        html, body {{
            width: {self.page_width}px;
            height: {self.page_height}px;
            overflow: hidden !important;
            margin: 0;
            padding: 0;
        }}
        
        .container {{
            width: {self.page_width}px;
            height: {self.page_height}px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }}
        
        .card {{
            width: 100%;
            height: 100%;
            background: {'rgba(255, 255, 255, 0.98)' if not is_dark else 'rgba(20, 20, 35, 0.98)'};
            border-radius: 20px;
            box-shadow: 0 20px 60px {self.style_manager.add_alpha(theme.primary_color, 0.15)},
                        0 10px 30px {self.style_manager.add_alpha('#000000', 0.1)};
            overflow: hidden;
            position: relative;
        }}
        
        .content {{
            padding: 50px 45px 70px 45px;
            color: var(--text-color);
            line-height: 1.85;
            height: 100%;
            overflow: hidden !important;
            position: relative;
        }}
        
        /* é¡µç ä¿¡æ¯ */
        .page-info {{
            position: absolute;
            bottom: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: {self.style_manager.add_alpha(theme.primary_color, 0.1)};
            border-radius: 20px;
            border: 1px solid {self.style_manager.add_alpha(theme.primary_color, 0.2)};
        }}
        
        .page-number {{
            font-weight: 700;
            color: var(--primary-color);
            font-size: 14px;
        }}
        
        .page-separator {{
            color: {self.style_manager.add_alpha(theme.text_color, 0.4)};
            font-size: 12px;
        }}
        
        .page-total {{
            color: {self.style_manager.add_alpha(theme.text_color, 0.6)};
            font-size: 14px;
        }}
        
        /* è£…é¥°å…ƒç´  */
        .card::before {{
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, {self.style_manager.add_alpha(theme.primary_color, 0.1)} 0%, transparent 70%);
            pointer-events: none;
        }}
        
        .card::after {{
            content: "";
            position: absolute;
            bottom: -50%;
            left: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, {self.style_manager.add_alpha(theme.secondary_color, 0.1)} 0%, transparent 70%);
            pointer-events: none;
        }}
        
        /* å“åº”å¼å›¾ç‰‡ */
        img {{
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 8px 24px {self.style_manager.add_alpha('#000000', 0.1)};
        }}
        
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {{
            display: none !important;
        }}
        
        * {{
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }}
        
        /* æ‰“å°æ ·å¼ */
        @media print {{
            body {{
                background: white;
                padding: 0;
            }}
            
            .container {{
                max-width: 100%;
            }}
            
            .card {{
                box-shadow: none;
                border-radius: 0;
                page-break-inside: avoid;
            }}
            
            .card::before,
            .card::after {{
                display: none;
            }}
        }}

        /* å®Œå…¨éšè—åˆ†é¡µæ ‡è®° */
        .pagebreak-marker {{
            display: none !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            visibility: hidden !important;
        }}
        """
    
    def get_js(self) -> str:
        """è·å–JavaScriptä»£ç """
        return """
        // é¡µé¢åŠ è½½å®Œæˆåçš„å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            const content = document.getElementById('content');
            if (content) {
                content.style.opacity = '0';
                content.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => {
                    content.style.opacity = '1';
                }, 100);
            }
            
            // å›¾ç‰‡å»¶è¿ŸåŠ è½½å’ŒåŠ¨ç”»
            const images = document.querySelectorAll('img');
            images.forEach((img, index) => {
                img.loading = 'lazy';
                img.style.opacity = '0';
                img.style.transform = 'translateY(20px)';
                img.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                
                // å›¾ç‰‡åŠ è½½å®Œæˆåæ˜¾ç¤º
                if (img.complete) {
                    setTimeout(() => {
                        img.style.opacity = '1';
                        img.style.transform = 'translateY(0)';
                    }, 100 * (index + 1));
                } else {
                    img.addEventListener('load', () => {
                        setTimeout(() => {
                            img.style.opacity = '1';
                            img.style.transform = 'translateY(0)';
                        }, 100);
                    });
                }
            });
            
            // ä»£ç å—å¢å¼º
            const codeBlocks = document.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                // æ·»åŠ è¯­è¨€æ ‡è¯†
                const code = block.querySelector('code');
                if (code && code.className) {
                    const lang = code.className.replace('language-', '');
                    if (lang) {
                        block.setAttribute('data-language', lang.toUpperCase());
                    }
                }
            });
            
            // è¡¨æ ¼å¢å¼º
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                // æ·»åŠ å“åº”å¼åŒ…è£…
                const wrapper = document.createElement('div');
                wrapper.style.overflowX = 'auto';
                wrapper.style.marginBottom = '20px';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
            
            // ç¡®ä¿å†…å®¹ä¸è¶…å‡º
            function ensureContentFit() {
                const card = document.querySelector('.card');
                const content = document.querySelector('.content');
                if (card && content) {
                    content.style.maxHeight = '100%';
                    content.style.overflow = 'hidden';
                }
            }
            
            ensureContentFit();
            window.addEventListener('resize', ensureContentFit);
        });
        
        // ç¦ç”¨æ‰€æœ‰æ»šåŠ¨
        window.addEventListener('scroll', function(e) {
            e.preventDefault();
            window.scrollTo(0, 0);
        }, { passive: false });
        
        window.addEventListener('wheel', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        window.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
        """ markdown_processor.py->text/plain-># ============================================
# src/core/markdown_processor.py
# ============================================
import markdown
from markdown.extensions import fenced_code, tables
import re
import uuid

class TaskListExtension(markdown.Extension):
    """è‡ªå®šä¹‰ä»»åŠ¡åˆ—è¡¨æ‰©å±•"""
    
    def extendMarkdown(self, md):
        # æé«˜ä¼˜å…ˆçº§åˆ° 100ï¼Œç¡®ä¿åœ¨åˆ—è¡¨å¤„ç†ä¹‹å‰æ‰§è¡Œ
        md.preprocessors.register(TaskListPreprocessor(md), 'tasklist', 100)
        md.postprocessors.register(TaskListPostprocessor(md), 'tasklist', 25)

class TaskListPreprocessor(markdown.preprocessors.Preprocessor):
    """é¢„å¤„ç†å™¨ï¼šæ ‡è®°ä»»åŠ¡åˆ—è¡¨é¡¹"""
    
    TASK_PATTERN = re.compile(r'^(\s*)([-\*\+])\s+\[([ xX])\]\s+(.*)$')
    
    def run(self, lines):
        new_lines = []
        for line in lines:
            match = self.TASK_PATTERN.match(line)
            if match:
                indent, marker, checked, text = match.groups()
                # å°†ä»»åŠ¡åˆ—è¡¨è½¬æ¢ä¸ºç‰¹æ®Šæ ‡è®°ï¼Œé¿å…è¢«æ™®é€šåˆ—è¡¨å¤„ç†å¹²æ‰°
                checked_mark = 'checked' if checked.lower() == 'x' else 'unchecked'
                # ä½¿ç”¨ç‰¹æ®Šçš„HTMLæ³¨é‡ŠåŒ…è£¹ï¼Œç¡®ä¿Markdownè§£æå™¨ä¸ä¼šç ´åå®ƒ
                new_line = f"{indent}{marker} <!--tasklist-{checked_mark}--> {text}"
                new_lines.append(new_line)
            else:
                new_lines.append(line)
        return new_lines

class TaskListPostprocessor(markdown.postprocessors.Postprocessor):
    """åå¤„ç†å™¨ï¼šå°†æ ‡è®°è½¬æ¢ä¸ºHTMLå¤é€‰æ¡†"""
    
    def run(self, text):
        # æ›¿æ¢å·²é€‰ä¸­çš„ä»»åŠ¡
        text = re.sub(
            r'<li><!--tasklist-checked-->\s*(.*?)</li>',
            r'<li class="task-list-item"><input type="checkbox" class="task-list-checkbox" checked disabled> \1</li>',
            text,
            flags=re.DOTALL
        )
        
        # æ›¿æ¢æœªé€‰ä¸­çš„ä»»åŠ¡
        text = re.sub(
            r'<li><!--tasklist-unchecked-->\s*(.*?)</li>',
            r'<li class="task-list-item"><input type="checkbox" class="task-list-checkbox" disabled> \1</li>',
            text,
            flags=re.DOTALL
        )
        
        # ä¸ºåŒ…å«ä»»åŠ¡åˆ—è¡¨çš„ul/olæ·»åŠ class
        text = re.sub(
            r'<(ul|ol)>(\s*<li class="task-list-item">)',
            r'<\1 class="task-list">\2',
            text
        )
        
        return text

class MarkdownProcessor:
    def __init__(self):
        # ä½¿ç”¨å¿…è¦ä¸”ç¨³å®šçš„æ‰©å±•
        self.extensions = [
            TaskListExtension(),                # æ”¾åˆ°æœ€å‰é¢ï¼Œä¼˜å…ˆå¤„ç†ä»»åŠ¡åˆ—è¡¨
            'markdown.extensions.fenced_code',
            'markdown.extensions.tables',
            'markdown.extensions.nl2br',
            'markdown.extensions.attr_list',
            'markdown.extensions.def_list',
            'markdown.extensions.footnotes',
            'markdown.extensions.toc',
            'markdown.extensions.sane_lists',   # æ”¾åˆ°ä»»åŠ¡åˆ—è¡¨æ‰©å±•ä¹‹å
            'markdown.extensions.smarty',
        ]
        
        # é…ç½®æ‰©å±•
        self.extension_configs = {}
        
    def parse(self, text: str) -> str:
        """è§£æ Markdown æ–‡æœ¬ä¸º HTML"""
        try:
            # 1. é¦–å…ˆå¤„ç†åˆ†é¡µæ ‡è®°ï¼Œå°†å…¶è½¬æ¢ä¸ºç‰¹æ®Šçš„ HTML æ ‡è®°
            text = self._process_pagebreaks_before_markdown(text)
            
            # 2. åˆ›å»ºæ–°çš„ Markdown å®ä¾‹ï¼ˆé¿å…çŠ¶æ€æ±¡æŸ“ï¼‰
            md = markdown.Markdown(
                extensions=self.extensions,
                extension_configs=self.extension_configs
            )
            
            # 3. è½¬æ¢ Markdown ä¸º HTML
            html = md.convert(text)
            
            # 4. åå¤„ç†ï¼šæ·»åŠ å°çº¢ä¹¦ç‰¹è‰² emoji æ”¯æŒ
            html = self._process_emojis(html)
            
            # 5. æ·»åŠ ä»»åŠ¡åˆ—è¡¨çš„æ ·å¼æ”¯æŒ
            html = self._add_tasklist_styles(html)
            
            return html
            
        except Exception as e:
            print(f"Markdown è§£æé”™è¯¯: {e}")
            return f"<p style='color: red;'>è§£æé”™è¯¯: {str(e)}</p>"
    
    def _process_pagebreaks_before_markdown(self, text: str) -> str:
        """
        åœ¨ Markdown è§£æä¹‹å‰å¤„ç†åˆ†é¡µæ ‡è®°
        ç›´æ¥å°† <!-- pagebreak --> æ›¿æ¢ä¸ºç‰¹æ®Šçš„ HTML div
        """
        # åŒ¹é… HTML æ³¨é‡Šå½¢å¼çš„åˆ†é¡µæ ‡è®°ï¼ˆæ”¯æŒå¤§å°å†™å’Œç©ºæ ¼å˜åŒ–ï¼‰
        pattern = r'<!--\s*pagebreak\s*-->'
        
        # ç›´æ¥æ›¿æ¢ä¸º HTML divï¼ˆè¿™ä¸ª div ä¸ä¼šè¢« Markdown è§£æå™¨æ”¹å˜ï¼‰
        replacement = '\n\n<div class="pagebreak-marker" data-pagebreak="true"></div>\n\n'
        
        # æ‰§è¡Œæ›¿æ¢
        text = re.sub(pattern, replacement, text, flags=re.IGNORECASE)
        
        return text
    
    def _process_emojis(self, html: str) -> str:
        """å¤„ç† emoji è¡¨æƒ…"""
        # ä¿æŒ emoji åŸæ ·æ˜¾ç¤º
        return html
    
    def _add_tasklist_styles(self, html: str) -> str:
        """æ·»åŠ ä»»åŠ¡åˆ—è¡¨çš„å†…è”æ ·å¼"""
        # å¦‚æœHTMLä¸­åŒ…å«ä»»åŠ¡åˆ—è¡¨ï¼Œæ·»åŠ æ ·å¼
        if 'task-list' in html:
            style = """
            <style>
                .task-list {
                    list-style-type: none;
                    padding-left: 0;
                }
                
                .task-list-item {
                    list-style-type: none;
                    margin-left: 0;
                    padding-left: 0;
                    position: relative;
                }
                
                .task-list-checkbox {
                    margin-right: 8px;
                    margin-left: 0;
                    vertical-align: middle;
                    position: relative;
                    top: -1px;
                    cursor: default;
                    width: 16px;
                    height: 16px;
                    accent-color: var(--primary-color, #FF2442);
                }
                
                .task-list-item + .task-list-item {
                    margin-top: 8px;
                }
                
                /* ç¾åŒ–å¤é€‰æ¡†æ ·å¼ */
                .task-list-checkbox:checked::before {
                    content: 'âœ“';
                    position: absolute;
                    color: var(--primary-color, #FF2442);
                    font-weight: bold;
                    font-size: 12px;
                    left: 2px;
                    top: -2px;
                }
            </style>
            """
            # å°†æ ·å¼æ’å…¥åˆ°HTMLå¼€å¤´
            html = style + html
        
        return html style_manager.py->text/plain->
### ç³»ç»Ÿ:
çœ‹äº†æ‚¨çš„ä»£ç ï¼Œé—®é¢˜å‡ºåœ¨ `preview_widget.py` çš„ `export_pages` æ–¹æ³•ä¸­ã€‚å¯¼å‡ºæ—¶ä¼šè°ƒç”¨ `self.web_view.setFixedSize(1080, 1440)`ï¼Œè¿™ä¼šæ”¹å˜ WebView çš„å°ºå¯¸è®¾ç½®ï¼Œä½†å¯¼å‡ºå®Œæˆåæ²¡æœ‰æ¢å¤åŸæ¥çš„æ¨¡å¼è®¾ç½®ã€‚

## é—®é¢˜åˆ†æ

åœ¨ `export_pages` æ–¹æ³•ä¸­ï¼Œ`ImageExporter` ä¼šè®¾ç½® WebView ä¸ºå›ºå®šå°ºå¯¸ï¼š
```python
# ç¡®ä¿WebViewæ˜¯å›ºå®šå°ºå¯¸
self.web_view.setFixedSize(1080, 1440)
```

ä½†å¯¼å‡ºå®Œæˆåï¼Œæ²¡æœ‰æ ¹æ®å½“å‰çš„é¢„è§ˆæ¨¡å¼æ¢å¤ç›¸åº”çš„è®¾ç½®ã€‚

## è§£å†³æ–¹æ¡ˆ

éœ€è¦åœ¨ `preview_widget.py` ä¸­ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹ï¼š

### 1. åœ¨ `export_pages` æ–¹æ³•å¼€å§‹æ—¶ä¿å­˜å½“å‰æ¨¡å¼çŠ¶æ€

### 2. åœ¨ `on_export_finished` æ–¹æ³•ä¸­æ¢å¤æ¨¡å¼çŠ¶æ€

ä»¥ä¸‹æ˜¯å…·ä½“ä¿®æ”¹ï¼š ä»£ç 
```python
# ============================================
# src/ui/preview_widget.py - Qtå…¼å®¹ä¼˜åŒ–ç‰ˆï¼ˆä¿®å¤å¯¼å‡ºåæ¨¡å¼é—®é¢˜ï¼‰
# ============================================
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QLabel, QFrame, 
                               QPushButton, QHBoxLayout, QProgressDialog,
                               QMessageBox, QComboBox, QButtonGroup, QRadioButton,
                               QScrollArea)
from PySide6.QtWebEngineWidgets import QWebEngineView
from PySide6.QtCore import QUrl, QTimer, Signal, Qt, QSize, QEvent
from PySide6.QtGui import QWheelEvent, QFont
from pathlib import Path
from src.core.markdown_processor import MarkdownProcessor
from src.core.html_generator import HTMLGenerator
from src.utils.paginator import SmartPaginator
from src.utils.exporter import ImageExporter

class CustomScrollArea(QScrollArea):
    """è‡ªå®šä¹‰æ»šåŠ¨åŒºåŸŸï¼Œå¤„ç†æ»šè½®äº‹ä»¶"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.preview_widget = None  # å°†åœ¨PreviewWidgetä¸­è®¾ç½®
        
    def wheelEvent(self, event: QWheelEvent):
        """é‡å†™æ»šè½®äº‹ä»¶"""
        if self.preview_widget:
            # é€‚åº”çª—å£æ¨¡å¼ï¼šæ»šè½®ç¿»é¡µ
            if self.preview_widget.preview_mode == "fit":
                if event.angleDelta().y() > 0:
                    self.preview_widget.prev_page()
                else:
                    self.preview_widget.next_page()
                event.accept()
                return
            
            # å®é™…å¤§å°æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æŒ‰ä½Shiftè¿›è¡Œæ¨ªå‘æ»šåŠ¨
            elif self.preview_widget.preview_mode == "actual":
                # å¦‚æœæŒ‰ä½Shifté”®ï¼Œå®ç°æ¨ªå‘æ»šåŠ¨
                if event.modifiers() == Qt.ShiftModifier:
                    # è·å–æ»šåŠ¨è·ç¦»
                    delta = event.angleDelta().y()
                    # æ¨ªå‘æ»šåŠ¨
                    h_scrollbar = self.horizontalScrollBar()
                    h_scrollbar.setValue(h_scrollbar.value() - delta)
                    event.accept()
                    return
                else:
                    # æ­£å¸¸çš„å‚ç›´æ»šåŠ¨
                    super().wheelEvent(event)
                    return
        
        # é»˜è®¤å¤„ç†
        super().wheelEvent(event)

class PreviewWidget(QWidget):
    pageChanged = Signal(int, int)  # å½“å‰é¡µï¼Œæ€»é¡µæ•°
    sizeChanged = Signal(str)  # å°ºå¯¸æ”¹å˜ä¿¡å·
    
    def __init__(self):
        super().__init__()
        self.current_pages = []  # å­˜å‚¨åˆ†é¡µåçš„HTMLå†…å®¹
        self.current_page = 1
        self.total_pages = 1
        self.markdown_text = ""  # ä¿å­˜åŸå§‹markdownæ–‡æœ¬
        self.current_size = "medium"  # å½“å‰é¡µé¢å°ºå¯¸
        self.preview_mode = "fit"  # é¢„è§ˆæ¨¡å¼: fit(é€‚åº”çª—å£) æˆ– actual(å®é™…å¤§å°)
        self._is_exporting = False  # æ·»åŠ å¯¼å‡ºçŠ¶æ€æ ‡å¿—
        
        # åˆå§‹åŒ–å¤„ç†å™¨
        self.markdown_processor = MarkdownProcessor()
        self.html_generator = HTMLGenerator(page_size="medium")
        self.paginator = SmartPaginator(page_size="medium")
        
        # åˆå§‹åŒ–UI
        self.init_ui()
        
        # è®¾ç½®å¯¼å‡ºå™¨
        self.setup_exporter()
        
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # åˆ›å»ºå®¹å™¨æ¡†æ¶ - ç§»é™¤é‡å¤çš„æ ‡é¢˜æ 
        container = QFrame()
        container.setStyleSheet("""
            QFrame {
                background: transparent;
                border: none;
            }
        """)
        container_layout = QVBoxLayout(container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(0)
        
        # åˆ›å»ºé¡¶éƒ¨æ§åˆ¶æ ï¼ˆåŒ…å«å°ºå¯¸å’Œæ¨¡å¼é€‰æ‹©ï¼‰
        top_control_bar = self.create_top_control_bar()
        
        # åˆ›å»ºWebViewå®¹å™¨
        self.create_web_view_container()
        
        # åˆ›å»ºåº•éƒ¨å¯¼èˆªæ§åˆ¶æ 
        bottom_control_bar = self.create_bottom_control_bar()
        
        # ç»„è£…å¸ƒå±€
        container_layout.addWidget(top_control_bar)
        container_layout.addWidget(self.web_container, 1)
        container_layout.addWidget(bottom_control_bar)
        
        layout.addWidget(container)
        
        # è¿æ¥ä¿¡å·
        self.connect_signals()
        
        # åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        self.update_buttons()
    
    def create_top_control_bar(self):
        """åˆ›å»ºé¡¶éƒ¨æ§åˆ¶æ  - Qtå…¼å®¹æ ·å¼"""
        control_bar = QFrame()
        control_bar.setFixedHeight(50)
        control_bar.setStyleSheet("""
            QFrame {
                background: rgba(30, 30, 50, 0.8);
                border-bottom: 1px solid rgba(255, 255, 255, 0.15);
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
            }
        """)
        
        layout = QHBoxLayout(control_bar)
        layout.setContentsMargins(20, 10, 20, 10)
        layout.setSpacing(20)
        
        # å°ºå¯¸é€‰æ‹©éƒ¨åˆ†
        size_container = QWidget()
        size_layout = QHBoxLayout(size_container)
        size_layout.setContentsMargins(0, 0, 0, 0)
        size_layout.setSpacing(10)
        
        size_label = QLabel("å°ºå¯¸:")
        size_label.setStyleSheet("""
            QLabel {
                color: rgba(255, 255, 255, 0.8);
                font-size: 13px;
                font-weight: 500;
            }
        """)
        
        self.size_selector = QComboBox()
        self.size_selector.addItems(["Small (720Ã—960)", "Medium (1080Ã—1440)", "Large (1440Ã—1920)"])
        self.size_selector.setCurrentIndex(1)
        self.size_selector.setFixedWidth(160)
        self.size_selector.setStyleSheet(self.get_combobox_style_qt())
        
        size_layout.addWidget(size_label)
        size_layout.addWidget(self.size_selector)
        
        # é¢„è§ˆæ¨¡å¼éƒ¨åˆ†
        mode_container = QWidget()
        mode_layout = QHBoxLayout(mode_container)
        mode_layout.setContentsMargins(0, 0, 0, 0)
        mode_layout.setSpacing(10)
        
        mode_label = QLabel("æ¨¡å¼:")
        mode_label.setStyleSheet("""
            QLabel {
                color: rgba(255, 255, 255, 0.8);
                font-size: 13px;
                font-weight: 500;
            }
        """)
        
        self.mode_group = QButtonGroup()
        
        self.fit_mode_btn = QRadioButton("é€‚åº”çª—å£")
        self.fit_mode_btn.setChecked(True)
        self.fit_mode_btn.setStyleSheet(self.get_radio_style_qt())
        
        self.actual_mode_btn = QRadioButton("å®é™…å¤§å°")
        self.actual_mode_btn.setStyleSheet(self.get_radio_style_qt())
        
        self.mode_group.addButton(self.fit_mode_btn, 0)
        self.mode_group.addButton(self.actual_mode_btn, 1)
        
        mode_layout.addWidget(mode_label)
        mode_layout.addWidget(self.fit_mode_btn)
        mode_layout.addWidget(self.actual_mode_btn)
        
        # ç»„è£…é¡¶éƒ¨æ§åˆ¶æ 
        layout.addWidget(size_container)
        layout.addSpacing(30)
        layout.addWidget(mode_container)
        layout.addStretch()
        
        return control_bar
    
    def create_web_view_container(self):
        """åˆ›å»ºWebViewå®¹å™¨ - Qtå…¼å®¹æ ·å¼"""
        # ä½¿ç”¨è‡ªå®šä¹‰æ»šåŠ¨åŒºåŸŸ
        self.web_container = CustomScrollArea()
        self.web_container.preview_widget = self  # è®¾ç½®å¼•ç”¨
        
        self.web_container.setStyleSheet("""
            QScrollArea {
                border: none;
                background: rgba(20, 20, 40, 0.4);
            }
            
            QScrollBar:vertical {
                background: rgba(255, 255, 255, 0.03);
                width: 12px;
                border-radius: 6px;
                margin: 4px;
            }
            
            QScrollBar::handle:vertical {
                background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 255, 255, 0.3),
                    stop: 1 rgba(255, 0, 255, 0.3));
                border-radius: 6px;
                min-height: 30px;
            }
            
            QScrollBar::handle:vertical:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                    stop: 0 rgba(0, 255, 255, 0.5),
                    stop: 1 rgba(255, 0, 255, 0.5));
            }
            
            QScrollBar::add-line:vertical,
            QScrollBar::sub-line:vertical {
                height: 0px;
            }
            
            QScrollBar:horizontal {
                background: rgba(255, 255, 255, 0.03);
                height: 12px;
                border-radius: 6px;
                margin: 4px;
            }
            
            QScrollBar::handle:horizontal {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 255, 0.3),
                    stop: 1 rgba(255, 0, 255, 0.3));
                border-radius: 6px;
                min-width: 30px;
            }
            
            QScrollBar::handle:horizontal:hover {
                background: qlineargradient(x1: 0, y1: 0, x2: 1, y2: 0,
                    stop: 0 rgba(0, 255, 255, 0.5),
                    stop: 1 rgba(255, 0, 255, 0.5));
            }
            
            QScrollBar::add-line:horizontal,
            QScrollBar::sub-line:horizontal {
                width: 0px;
            }
        """)
        
        # åˆ›å»ºWebView
        self.web_view = QWebEngineView()
        self.web_view.setStyleSheet("""
            QWebEngineView {
                border: none;
                background: transparent;
            }
        """)
        
        # ç¦ç”¨WebViewè‡ªèº«çš„æ»šåŠ¨æ¡å’Œé¼ æ ‡äº¤äº’ï¼ˆåœ¨å®é™…å¤§å°æ¨¡å¼ä¸‹ï¼‰
        self.web_view.setAttribute(Qt.WA_TransparentForMouseEvents, False)
        self.web_view.setFocusPolicy(Qt.StrongFocus)
        
        # è®¾ç½®æ»šåŠ¨åŒºåŸŸ
        self.web_container.setWidget(self.web_view)
        self.web_container.setWidgetResizable(True)
        self.web_container.setAlignment(Qt.AlignCenter)
        
        # é»˜è®¤è®¾ç½®ä¸ºé€‚åº”çª—å£æ¨¡å¼
        self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
    
    def create_bottom_control_bar(self):
        """åˆ›å»ºåº•éƒ¨å¯¼èˆªæ§åˆ¶æ  - Qtå…¼å®¹æ ·å¼"""
        control_bar = QFrame()
        control_bar.setFixedHeight(60)
        control_bar.setStyleSheet("""
            QFrame {
                background: rgba(20, 20, 40, 0.8);
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
        """)
        
        control_layout = QHBoxLayout(control_bar)
        control_layout.setContentsMargins(20, 12, 20, 12)
        control_layout.setSpacing(15)
        
        # åˆ›å»ºä¸­å¿ƒæ§åˆ¶åŒºå®¹å™¨
        center_controls = QWidget()
        center_layout = QHBoxLayout(center_controls)
        center_layout.setContentsMargins(0, 0, 0, 0)
        center_layout.setSpacing(15)
        
        # ä¸Šä¸€é¡µæŒ‰é’®
        self.prev_btn = QPushButton("â¬… Previous")
        self.prev_btn.setFixedSize(110, 36)
        self.prev_btn.setStyleSheet(self.get_button_style_qt())
        
        # é¡µé¢ä¿¡æ¯æ ‡ç­¾
        self.page_info_label = QLabel("Page 1")
        self.page_info_label.setStyleSheet("""
            QLabel {
                color: #00ff88;
                font-size: 14px;
                font-weight: 600;
                padding: 8px 20px;
                background: rgba(0, 255, 136, 0.1);
                border: 1px solid rgba(0, 255, 136, 0.3);
                border-radius: 18px;
                min-width: 100px;
            }
        """)
        self.page_info_label.setAlignment(Qt.AlignCenter)
        
        # ä¸‹ä¸€é¡µæŒ‰é’®
        self.next_btn = QPushButton("Next â¡")
        self.next_btn.setFixedSize(110, 36)
        self.next_btn.setStyleSheet(self.get_button_style_qt())
        
        # ç»„è£…ä¸­å¿ƒæ§åˆ¶åŒº
        center_layout.addWidget(self.prev_btn)
        center_layout.addWidget(self.page_info_label)
        center_layout.addWidget(self.next_btn)
        
        # å¿«æ·æç¤º
        tips_label = QLabel("ğŸ’¡ æ»šè½®ï¼šä¸Šä¸‹å¯¼èˆª â€¢ Shift+æ»šè½®ï¼šå·¦å³æ»šåŠ¨")
        tips_label.setStyleSheet("""
            QLabel {
                color: rgba(255, 255, 255, 0.5);
                font-size: 11px;
                font-style: italic;
                background: transparent;
            }
        """)
        tips_label.setFont(QFont("Arial", 10))
        
        # ç»„è£…æ§åˆ¶æ 
        control_layout.addStretch()
        control_layout.addWidget(center_controls)
        control_layout.addStretch()
        control_layout.addWidget(tips_label)
        
        return control_bar
    
    def connect_signals(self):
        """è¿æ¥ä¿¡å·"""
        self.prev_btn.clicked.connect(self.prev_page)
        self.next_btn.clicked.connect(self.next_page)
        self.size_selector.currentIndexChanged.connect(self.on_size_changed)
        self.mode_group.buttonClicked.connect(self.on_mode_changed)
    
    def keyPressEvent(self, event):
        """å¤„ç†é”®ç›˜äº‹ä»¶"""
        if event.key() == Qt.Key_PageUp:
            self.prev_page()
        elif event.key() == Qt.Key_PageDown:
            self.next_page()
        elif event.key() == Qt.Key_Home:
            self.go_to_page(1)
        elif event.key() == Qt.Key_End:
            self.go_to_page(self.total_pages)
        else:
            super().keyPressEvent(event)
    
    def on_mode_changed(self):
        """å¤„ç†é¢„è§ˆæ¨¡å¼æ”¹å˜"""
        # å¦‚æœæ­£åœ¨å¯¼å‡ºï¼Œä¸å…è®¸åˆ‡æ¢æ¨¡å¼
        if self._is_exporting:
            return
            
        if self.fit_mode_btn.isChecked():
            self.preview_mode = "fit"
            # é€‚åº”çª—å£æ¨¡å¼ï¼šéšè—æ»šåŠ¨æ¡ï¼Œå¯ç”¨è‡ªé€‚åº”
            self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            self.web_container.setWidgetResizable(True)
            
            # æ¸…é™¤ WebView çš„å›ºå®šå°ºå¯¸é™åˆ¶
            self.web_view.setMinimumSize(0, 0)
            self.web_view.setMaximumSize(16777215, 16777215)
            
            # åœ¨é€‚åº”æ¨¡å¼ä¸‹ï¼ŒWebViewä¸éœ€è¦å¤„ç†é¼ æ ‡äº‹ä»¶
            self.web_view.setAttribute(Qt.WA_TransparentForMouseEvents, False)
            
        else:
            self.preview_mode = "actual"
            # å®é™…å¤§å°æ¨¡å¼ï¼šæ˜¾ç¤ºæ»šåŠ¨æ¡
            self.web_container.setHorizontalScrollBarPolicy(Qt.ScrollBarAsNeeded)
            self.web_container.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
            self.web_container.setWidgetResizable(False)
            
            # åœ¨å®é™…å¤§å°æ¨¡å¼ä¸‹ï¼Œè®©WebViewé€æ˜äºé¼ æ ‡æ»šè½®äº‹ä»¶
            # è¿™æ ·æ»šè½®äº‹ä»¶ä¼šç›´æ¥ä¼ é€’ç»™ScrollArea
            self.web_view.setAttribute(Qt.WA_TransparentForMouseEvents, True)
        
        # é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢
        self.display_current_page()
    
    def on_size_changed(self, index):
        """å¤„ç†å°ºå¯¸æ”¹å˜"""
        size_map = {0: "small", 1: "medium", 2: "large"}
        new_size = size_map.get(index, "medium")
        
        if new_size != self.current_size:
            self.current_size = new_size
            
            # æ›´æ–°å„ç»„ä»¶çš„å°ºå¯¸è®¾ç½®
            self.html_generator = HTMLGenerator(page_size=new_size)
            self.paginator.set_page_size(new_size)
            
            # é‡æ–°å¤„ç†å†…å®¹
            if self.markdown_text:
                self.update_content(self.markdown_text)
            
            # å‘é€å°ºå¯¸æ”¹å˜ä¿¡å·
            self.sizeChanged.emit(new_size)
    
    def update_content(self, markdown_text: str):
        """æ›´æ–°é¢„è§ˆå†…å®¹"""
        try:
            self.markdown_text = markdown_text
            
            # å¤„ç† Markdown
            html_content = self.markdown_processor.parse(markdown_text)
            
            # ä½¿ç”¨æ™ºèƒ½åˆ†é¡µå™¨è¿›è¡Œåˆ†é¡µ
            self.current_pages = self.paginator.paginate(html_content)
            
            # ä¼˜åŒ–åˆ†é¡µç»“æœ
            self.current_pages = self.paginator.optimize_pages(self.current_pages)
            
            self.total_pages = len(self.current_pages)
            self.current_page = 1
            
            # æ˜¾ç¤ºç¬¬ä¸€é¡µ
            self.display_current_page()
            
            # æ›´æ–°æŒ‰é’®å’Œä¿¡æ¯
            self.update_buttons()
            self.update_page_info()
            
        except Exception as e:
            self.show_error(f"Preview error: {str(e)}")
    
    def display_current_page(self):
        """æ˜¾ç¤ºå½“å‰é¡µ"""
        # å¦‚æœæ­£åœ¨å¯¼å‡ºï¼Œä¸æ›´æ–°æ˜¾ç¤º
        if self._is_exporting:
            return
            
        if not self.current_pages:
            return
            
        if 1 <= self.current_page <= len(self.current_pages):
            page_content = self.current_pages[self.current_page - 1]
            
            # è·å–ç›®æ ‡å°ºå¯¸
            size_config = {
                "small": (720, 960),
                "medium": (1080, 1440),
                "large": (1440, 1920)
            }
            target_width, target_height = size_config.get(self.current_size, (1080, 1440))
            
            # æ ¹æ®é¢„è§ˆæ¨¡å¼ç”Ÿæˆä¸åŒçš„HTML
            if self.preview_mode == "fit":
                # é€‚åº”çª—å£æ¨¡å¼
                full_html = self.generate_fit_html(page_content, target_width, target_height)
                self.web_view.setMinimumSize(0, 0)
                self.web_view.setMaximumSize(16777215, 16777215)
                self.web_container.setWidgetResizable(True)
                
            else:
                # å®é™…å¤§å°æ¨¡å¼ï¼šæ·»åŠ ç¦ç”¨å†…éƒ¨æ»šåŠ¨çš„CSS
                full_html = self.generate_actual_html(page_content, target_width, target_height)
                # è®¾ç½®WebViewä¸ºå®é™…å°ºå¯¸
                self.web_view.setFixedSize(target_width, target_height)
                self.web_container.setWidgetResizable(False)
            
            # åŠ è½½åˆ°WebView
            self.web_view.setHtml(full_html, QUrl("file:///"))
    
    def generate_actual_html(self, content: str, target_width: int, target_height: int) -> str:
        """ç”Ÿæˆå®é™…å¤§å°æ¨¡å¼çš„HTMLï¼ˆç¦ç”¨å†…éƒ¨æ»šåŠ¨ï¼‰"""
        base_html = self.html_generator.generate(content)
        
        # æ·»åŠ ç¦ç”¨æ»šåŠ¨çš„CSSå’ŒJavaScript
        disable_scroll = """
        <style>
            /* ç¦ç”¨æ‰€æœ‰å†…éƒ¨æ»šåŠ¨ */
            html, body {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
                touch-action: none !important;
                user-select: none !important;
                -webkit-user-select: none !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }
            
            html::-webkit-scrollbar,
            body::-webkit-scrollbar {
                display: none !important;
            }
            
            * {
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }
            
            *::-webkit-scrollbar {
                display: none !important;
            }
        </style>
        
        <script>
            // ç¦ç”¨æ»šåŠ¨äº‹ä»¶
            document.addEventListener('DOMContentLoaded', function() {
                // ç¦ç”¨æ»šè½®äº‹ä»¶
                document.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, { passive: false, capture: true });
                
                // ç¦ç”¨è§¦æ‘¸æ»šåŠ¨
                document.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, { passive: false, capture: true });
                
                // ç¦ç”¨é”®ç›˜æ»šåŠ¨
                document.addEventListener('keydown', function(e) {
                    const scrollKeys = [32, 33, 34, 35, 36, 37, 38, 39, 40];
                    if (scrollKeys.includes(e.keyCode)) {
                        e.preventDefault();
                        return false;
                    }
                }, false);
                
                // å›ºå®šbodyä½ç½®
                document.body.style.position = 'fixed';
                document.body.style.top = '0';
                document.body.style.left = '0';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                document.body.style.overflow = 'hidden';
            });
        </script>
        """
        
        # æ’å…¥åˆ°headæ ‡ç­¾ç»“æŸå‰
        full_html = base_html.replace('</head>', disable_scroll + '</head>')
        
        return full_html
    
    def generate_fit_html(self, content: str, target_width: int, target_height: int) -> str:
        """ç”Ÿæˆé€‚åº”çª—å£çš„HTML"""
        base_html = self.html_generator.generate(content)
        
        scale_script = f"""
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}
            
            html, body {{
                width: 100%;
                height: 100%;
                overflow: hidden;
                background: #1a1a2e;
                display: flex;
                justify-content: center;
                align-items: center;
            }}
            
            #viewport-container {{
                position: relative;
                width: 100vw;
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
            }}
            
            #content-wrapper {{
                position: relative;
                width: {target_width}px;
                height: {target_height}px;
                transform-origin: center center;
                flex-shrink: 0;
            }}
        </style>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {{
                if (!document.getElementById('viewport-container')) {{
                    const viewportContainer = document.createElement('div');
                    viewportContainer.id = 'viewport-container';
                    
                    const contentWrapper = document.createElement('div');
                    contentWrapper.id = 'content-wrapper';
                    
                    while (document.body.firstChild) {{
                        contentWrapper.appendChild(document.body.firstChild);
                    }}
                    
                    viewportContainer.appendChild(contentWrapper);
                    document.body.appendChild(viewportContainer);
                }}
                
                function adjustScale() {{
                    const wrapper = document.getElementById('content-wrapper');
                    const container = document.getElementById('viewport-container');
                    
                    if (!wrapper || !container) return;
                    
                    const availableWidth = container.clientWidth;
                    const availableHeight = container.clientHeight;
                    
                    const targetWidth = {target_width};
                    const targetHeight = {target_height};
                    
                    const padding = 40;
                    const scaleX = (availableWidth - padding) / targetWidth;
                    const scaleY = (availableHeight - padding) / targetHeight;
                    
                    const scale = Math.min(scaleX, scaleY, 1.0);
                    
                    wrapper.style.transform = `scale(${{scale}})`;
                }}
                
                setTimeout(adjustScale, 100);
                window.addEventListener('resize', adjustScale);
                
                const observer = new ResizeObserver(adjustScale);
                observer.observe(document.getElementById('viewport-container'));
            }});
        </script>
        """
        
        full_html = base_html.replace('</head>', scale_script + '</head>')
        return full_html
    
    def prev_page(self):
        """ä¸Šä¸€é¡µ"""
        if self.current_page > 1:
            self.go_to_page(self.current_page - 1)
    
    def next_page(self):
        """ä¸‹ä¸€é¡µ"""
        if self.current_page < self.total_pages:
            self.go_to_page(self.current_page + 1)
    
    def go_to_page(self, page_num: int):
        """è·³è½¬åˆ°æŒ‡å®šé¡µ"""
        if 1 <= page_num <= self.total_pages:
            self.current_page = page_num
            self.display_current_page()
            self.update_buttons()
            self.update_page_info()
    
    def update_buttons(self):
        """æ›´æ–°æŒ‰é’®çŠ¶æ€"""
        self.prev_btn.setEnabled(self.current_page > 1)
        self.next_btn.setEnabled(self.current_page < self.total_pages)
        self.pageChanged.emit(self.current_page, self.total_pages)
    
    def update_page_info(self):
        """æ›´æ–°é¡µé¢ä¿¡æ¯æ˜¾ç¤º"""
        if self.total_pages > 1:
            self.page_info_label.setText(f"Page {self.current_page} / {self.total_pages}")
        else:
            self.page_info_label.setText("Page 1")
    
    def get_button_style_qt(self) -> str:
        """è·å–æŒ‰é’®æ ·å¼ - Qtå…¼å®¹ç‰ˆæœ¬"""
        return """
            QPushButton {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.25);
                color: rgba(255, 255, 255, 0.95);
                padding: 10px 20px;
                border-radius: 18px;
```

### ç”¨æˆ·:
Continue
### ç³»ç»Ÿ:
å®Œæˆäº†ï¼ä¸»è¦ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š

## å…³é”®ä¿®æ”¹ç‚¹

1. **æ·»åŠ å¯¼å‡ºçŠ¶æ€æ ‡å¿—** (`__init__` æ–¹æ³•)
   - æ·»åŠ  `self._is_exporting = False` æ ‡å¿—æ¥è¿½è¸ªå¯¼å‡ºçŠ¶æ€

2. **é˜»æ­¢å¯¼å‡ºæœŸé—´çš„æ¨¡å¼åˆ‡æ¢** (`on_mode_changed` æ–¹æ³•)
   - å¯¼å‡ºæ—¶ä¸å…è®¸åˆ‡æ¢é¢„è§ˆæ¨¡å¼

3. **é˜»æ­¢å¯¼å‡ºæœŸé—´çš„é¡µé¢æ›´æ–°** (`display_current_page` æ–¹æ³•)
   - å¯¼å‡ºæ—¶ä¸æ›´æ–°æ˜¾ç¤ºå†…å®¹

4. **ä¿å­˜å’Œæ¢å¤çŠ¶æ€** (`export_pages` æ–¹æ³•)
   - å¯¼å‡ºå¼€å§‹æ—¶ä¿å­˜å½“å‰é¢„è§ˆæ¨¡å¼å’Œé¡µç 
   - è®¾ç½® `_is_exporting = True`
   - ä¿å­˜ `_saved_preview_mode` å’Œ `_saved_current_page`

5. **æ¢å¤åŸå§‹çŠ¶æ€** (`on_export_finished` æ–¹æ³•)
   - å¯¼å‡ºå®Œæˆåæ¢å¤ä¹‹å‰çš„é¢„è§ˆæ¨¡å¼
   - æ ¹æ®ä¿å­˜çš„æ¨¡å¼é‡æ–°è®¾ç½®æ‰€æœ‰ç›¸å…³çš„UIå±æ€§
   - æ¢å¤åˆ°ä¹‹å‰çš„é¡µé¢

6. **å–æ¶ˆå¯¼å‡ºæ—¶ä¹Ÿæ¢å¤** (`on_export_canceled` æ–¹æ³•)
   - å–æ¶ˆå¯¼å‡ºæ—¶åŒæ ·æ¢å¤åŸå§‹çŠ¶æ€

è¿™æ ·ä¿®æ”¹åï¼Œå¯¼å‡ºå›¾ç‰‡æ—¶ä¼šï¼š
1. è®°ä½å½“å‰çš„é¢„è§ˆæ¨¡å¼ï¼ˆé€‚åº”çª—å£/å®é™…å¤§å°ï¼‰
2. è®°ä½å½“å‰æŸ¥çœ‹çš„é¡µç 
3. å¯¼å‡ºå®Œæˆæˆ–å–æ¶ˆåï¼Œè‡ªåŠ¨æ¢å¤åˆ°åŸæ¥çš„æ¨¡å¼å’Œé¡µé¢
4. å¯¼å‡ºè¿‡ç¨‹ä¸­é˜²æ­¢æ¨¡å¼åˆ‡æ¢å’Œé¡µé¢æ›´æ–°

è¿™ä¸ªè§£å†³æ–¹æ¡ˆç¡®ä¿äº†å¯¼å‡ºæ“ä½œä¸ä¼šå½±å“ç”¨æˆ·çš„é¢„è§ˆä½“éªŒã€‚
